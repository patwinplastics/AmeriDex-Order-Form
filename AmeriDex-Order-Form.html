<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>AmeriDex 3D Deck Builder</title>
<style>
    :root {
        --bg-page: #f5f7fa;
        --bg-card: #ffffff;
        --primary: #2563eb;
        --primary-dark: #1d4ed8;
        --primary-soft: #eff6ff;
        --border-subtle: #e5e7eb;
        --text-main: #111827;
        --text-muted: #6b7280;
        --danger: #dc2626;
        --success: #16a34a;
        --warning: #f59e0b;
        --shadow-soft: 0 10px 25px rgba(15, 23, 42, 0.08);
        --radius-card: 14px;
        --radius-field: 8px;
    }

    * { box-sizing: border-box; }

    html, body {
        margin: 0;
        padding: 0;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        background-color: var(--bg-page);
        color: var(--text-main);
        line-height: 1.5;
    }

    .page-shell {
        max-width: 1400px;
        margin: 0 auto;
        padding: 1rem;
    }

    header.app-header {
        background: linear-gradient(135deg, #2563eb, #1e40af);
        color: #fff;
        padding: 1.5rem 1rem;
        border-radius: 0 0 var(--radius-card) var(--radius-card);
        box-shadow: var(--shadow-soft);
        text-align: center;
        margin-bottom: 1rem;
    }

    header.app-header img.logo {
        max-width: 180px;
        height: auto;
        margin-bottom: 0.5rem;
    }

    header.app-header h1 {
        margin: 0;
        font-size: 1.5rem;
    }

    header.app-header p {
        margin: 0.5rem 0 0;
        font-size: 0.85rem;
        opacity: 0.9;
    }

    .card {
        background: var(--bg-card);
        border-radius: var(--radius-card);
        padding: 1.25rem;
        margin-bottom: 1rem;
        box-shadow: 0 1px 3px rgba(15, 23, 42, 0.08);
        border: 1px solid var(--border-subtle);
    }

    .card-title {
        margin: 0 0 0.5rem 0;
        font-size: 1.1rem;
        font-weight: 700;
        color: var(--primary);
    }

    .card-subtitle {
        margin: 0 0 1rem 0;
        font-size: 0.8rem;
        color: var(--text-muted);
    }

    /* 3D Builder Layout */
    .deck-builder-container {
        display: grid;
        grid-template-columns: 1fr;
        gap: 1rem;
    }

    @media (min-width: 1000px) {
        .deck-builder-container {
            grid-template-columns: 340px 1fr;
        }
    }

    .builder-controls {
        background: #f8fafc;
        border-radius: 12px;
        padding: 1rem;
        border: 1px solid var(--border-subtle);
        max-height: calc(100vh - 200px);
        overflow-y: auto;
    }

    .control-section {
        margin-bottom: 1.25rem;
        padding-bottom: 1rem;
        border-bottom: 1px dashed var(--border-subtle);
    }

    .control-section:last-child {
        border-bottom: none;
        margin-bottom: 0;
        padding-bottom: 0;
    }

    .control-section-title {
        font-size: 0.75rem;
        font-weight: 700;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: 0.6rem;
    }

    .field {
        margin-bottom: 0.6rem;
    }

    .field label {
        display: block;
        font-size: 0.8rem;
        font-weight: 600;
        margin-bottom: 0.25rem;
        color: #374151;
    }

    .field input,
    .field select {
        width: 100%;
        padding: 0.5rem;
        border: 1px solid var(--border-subtle);
        border-radius: 6px;
        font-size: 0.9rem;
    }

    .field input:focus,
    .field select:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.15);
    }

    /* Color Grid */
    .color-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 0.5rem;
    }

    .color-card {
        border: 3px solid transparent;
        border-radius: 8px;
        overflow: hidden;
        cursor: pointer;
        transition: all 0.2s ease;
        background: white;
    }

    .color-card:hover {
        border-color: var(--primary);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .color-card.selected {
        border-color: var(--primary);
        box-shadow: 0 0 0 2px white, 0 0 0 4px var(--primary);
    }

    .color-card img {
        width: 100%;
        height: 45px;
        object-fit: cover;
        display: block;
    }

    .color-card-label {
        text-align: center;
        font-size: 0.65rem;
        font-weight: 600;
        padding: 0.25rem 0.15rem;
        color: var(--text-main);
        background: #f9fafb;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    /* Color Preview Panel */
    .color-preview-panel {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 0.75rem;
        margin-top: 0.75rem;
        padding: 0.75rem;
        background: white;
        border-radius: 8px;
        border: 1px solid var(--border-subtle);
    }

    .color-preview-box {
        text-align: center;
    }

    .color-preview-box h5 {
        margin: 0 0 0.4rem 0;
        font-size: 0.7rem;
        color: var(--text-muted);
        text-transform: uppercase;
    }

    .color-preview-box img {
        width: 100%;
        max-width: 100px;
        height: 60px;
        object-fit: cover;
        border-radius: 6px;
        border: 1px solid var(--border-subtle);
    }

    .color-preview-box .color-name {
        font-size: 0.75rem;
        font-weight: 600;
        margin-top: 0.3rem;
    }

    /* Stair Buttons */
    .stair-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 0.4rem;
    }

    .stair-btn {
        padding: 0.5rem;
        font-size: 0.75rem;
        font-weight: 600;
        border: 1px solid var(--border-subtle);
        background: white;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.15s ease;
    }

    .stair-btn:hover {
        border-color: var(--primary);
        background: var(--primary-soft);
    }

    .stair-btn.active {
        background: var(--primary);
        color: white;
        border-color: var(--primary);
    }

    /* Checkbox row */
    .check-row {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.4rem 0;
    }

    .check-row input[type="checkbox"] {
        width: 18px;
        height: 18px;
        cursor: pointer;
    }

    .check-row label {
        font-size: 0.85rem;
        cursor: pointer;
        margin: 0;
    }

    .check-row .hint {
        font-size: 0.7rem;
        color: var(--text-muted);
        margin-left: auto;
    }

    /* Material Summary */
    .material-summary {
        background: white;
        border-radius: 8px;
        padding: 0.75rem;
        border: 1px solid var(--border-subtle);
        margin-top: 1rem;
    }

    .material-summary h4 {
        margin: 0 0 0.5rem 0;
        font-size: 0.85rem;
        color: var(--primary-dark);
    }

    .material-row {
        display: flex;
        justify-content: space-between;
        font-size: 0.8rem;
        padding: 0.3rem 0;
        border-bottom: 1px dotted var(--border-subtle);
    }

    .material-row:last-child {
        border-bottom: none;
        padding-top: 0.5rem;
        margin-top: 0.25rem;
        border-top: 1px solid var(--border-subtle);
        font-weight: 700;
    }

    .material-row span:first-child {
        color: var(--text-muted);
    }

    .material-row span:last-child {
        font-weight: 600;
    }

    .material-row.optional {
        background: #fef3c7;
        margin: 0.25rem -0.5rem;
        padding: 0.4rem 0.5rem;
        border-radius: 4px;
        border-bottom: none;
    }

    .material-row.optional span:first-child {
        color: #92400e;
    }

    /* Buttons */
    .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 0.65rem 1rem;
        font-size: 0.85rem;
        font-weight: 600;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.15s ease;
        border: none;
    }

    .btn-primary {
        background: var(--primary);
        color: white;
        width: 100%;
        margin-top: 1rem;
    }

    .btn-primary:hover {
        background: var(--primary-dark);
    }

    .btn-success {
        background: var(--success);
        color: white;
    }

    .btn-ghost {
        background: transparent;
        color: var(--text-muted);
        border: 1px solid var(--border-subtle);
        width: 100%;
        margin-top: 0.5rem;
        font-size: 0.8rem;
    }

    .btn-ghost:hover {
        border-color: var(--danger);
        color: var(--danger);
    }

    /* 3D Viewport */
    .builder-viewport {
        position: relative;
        background: linear-gradient(180deg, #87CEEB 0%, #B0E0E6 40%, #90EE90 100%);
        border-radius: 12px;
        overflow: hidden;
        min-height: 500px;
        border: 2px solid var(--border-subtle);
    }

    @media (min-width: 1000px) {
        .builder-viewport {
            min-height: 600px;
        }
    }

    #deck-canvas {
        width: 100% !important;
        height: 100% !important;
        display: block;
        position: absolute;
        top: 0;
        left: 0;
    }

    .viewport-overlay {
        position: absolute;
        bottom: 12px;
        left: 12px;
        display: flex;
        gap: 0.4rem;
        z-index: 10;
    }

    .view-btn {
        background: rgba(255,255,255,0.95);
        border: 1px solid var(--border-subtle);
        border-radius: 6px;
        padding: 0.4rem 0.75rem;
        font-size: 0.75rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.15s ease;
    }

    .view-btn:hover,
    .view-btn.active {
        background: var(--primary);
        color: white;
        border-color: var(--primary);
    }

    .viewport-instructions {
        position: absolute;
        top: 12px;
        left: 12px;
        background: rgba(0,0,0,0.6);
        color: white;
        padding: 0.5rem 0.75rem;
        border-radius: 6px;
        font-size: 0.7rem;
        z-index: 10;
    }

    .viewport-color-indicator {
        position: absolute;
        top: 12px;
        right: 12px;
        background: rgba(255,255,255,0.95);
        padding: 0.5rem 0.75rem;
        border-radius: 6px;
        font-size: 0.75rem;
        font-weight: 600;
        z-index: 10;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        border: 1px solid var(--border-subtle);
    }

    .viewport-color-indicator img {
        width: 24px;
        height: 24px;
        border-radius: 4px;
        object-fit: cover;
    }

    .texture-loading {
        position: absolute;
        bottom: 12px;
        right: 12px;
        background: rgba(255,255,255,0.95);
        padding: 0.4rem 0.6rem;
        border-radius: 6px;
        font-size: 0.7rem;
        z-index: 10;
        display: none;
        align-items: center;
        gap: 0.4rem;
        border: 1px solid var(--border-subtle);
    }

    .texture-loading.visible {
        display: flex;
    }

    .texture-loading .spinner {
        width: 12px;
        height: 12px;
        border: 2px solid var(--border-subtle);
        border-top-color: var(--primary);
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    /* Order Section */
    .order-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.85rem;
        margin-top: 1rem;
    }

    .order-table th,
    .order-table td {
        padding: 0.6rem;
        border: 1px solid var(--border-subtle);
        text-align: left;
    }

    .order-table th {
        background: #f9fafb;
        font-weight: 600;
        color: #4b5563;
    }

    .order-table td.numeric {
        text-align: right;
    }

    .order-table .color-cell {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .order-table .color-cell img {
        width: 28px;
        height: 28px;
        border-radius: 4px;
        object-fit: cover;
        border: 1px solid var(--border-subtle);
    }

    .total-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem;
        background: var(--primary-soft);
        border-radius: 8px;
        margin-top: 1rem;
    }

    .total-bar .label {
        font-weight: 600;
        color: #4b5563;
    }

    .total-bar .value {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--primary-dark);
    }

    /* Form fields */
    .form-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 0.75rem;
    }

    @media (min-width: 600px) {
        .form-grid-2 {
            grid-template-columns: 1fr 1fr;
        }
    }

    textarea {
        width: 100%;
        padding: 0.6rem;
        border: 1px solid var(--border-subtle);
        border-radius: 6px;
        font-size: 0.9rem;
        font-family: inherit;
        resize: vertical;
        min-height: 80px;
    }

    textarea:focus {
        outline: none;
        border-color: var(--primary);
    }

    .actions-row {
        display: flex;
        gap: 0.75rem;
        flex-wrap: wrap;
        justify-content: center;
        margin-top: 1rem;
    }

    .actions-row .btn {
        width: auto;
        min-width: 140px;
    }

    footer {
        text-align: center;
        padding: 1.5rem;
        color: var(--text-muted);
        font-size: 0.8rem;
    }

    footer a {
        color: var(--primary);
        text-decoration: none;
    }

    /* Color modal */
    .modal {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.5);
        z-index: 100;
        justify-content: center;
        align-items: center;
        padding: 1rem;
    }

    .modal.active {
        display: flex;
    }

    .modal-content {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        max-width: 400px;
        text-align: center;
        position: relative;
    }

    .modal-content img {
        max-width: 100%;
        border-radius: 8px;
    }

    .modal-close {
        position: absolute;
        top: 10px;
        right: 12px;
        font-size: 1.5rem;
        cursor: pointer;
        color: #6b7280;
        background: none;
        border: none;
    }

    .modal-close:hover {
        color: #111827;
    }
</style>
</head>
<body>

<div class="page-shell">
    <header class="app-header">
        <img src="colors/AmeriDex.png" alt="AmeriDex Logo" class="logo">
        <h1>3D Deck Builder</h1>
        <p>Design your deck in 3D, then generate your order automatically</p>
    </header>

    <section class="card">
        <h2 class="card-title">3D Deck Designer</h2>
        <p class="card-subtitle">Drag to rotate | Scroll to zoom | Right-click to pan</p>

        <div class="deck-builder-container">
            <!-- Controls Panel -->
            <div class="builder-controls">

                <div class="control-section">
                    <div class="control-section-title">Deck Dimensions</div>
                    <div class="field">
                        <label>Length (ft)</label>
                        <input type="number" id="deck-length" value="16" min="6" max="40" step="1">
                    </div>
                    <div class="field">
                        <label>Width (ft)</label>
                        <input type="number" id="deck-width" value="12" min="6" max="30" step="1">
                    </div>
                    <div class="field">
                        <label>Height (ft)</label>
                        <input type="number" id="deck-height" value="3" min="1" max="10" step="0.5">
                    </div>
                </div>

                <div class="control-section">
                    <div class="control-section-title">Board Color</div>
                    <div class="color-grid" id="color-grid"></div>

                    <div class="color-preview-panel">
                        <div class="color-preview-box">
                            <h5>Selected Color</h5>
                            <img id="preview-color-1" src="colors/Driftwood.png" alt="Selected">
                            <div class="color-name" id="preview-name-1">Driftwood</div>
                        </div>
                        <div class="color-preview-box">
                            <h5>Compare With</h5>
                            <img id="preview-color-2" src="colors/Khaki.png" alt="Compare">
                            <div class="color-name" id="preview-name-2">Khaki</div>
                        </div>
                    </div>
                </div>

                <div class="control-section">
                    <div class="control-section-title">Board Length</div>
                    <div class="field">
                        <select id="board-length">
                            <option value="12">12 ft boards</option>
                            <option value="16" selected>16 ft boards</option>
                            <option value="20">20 ft boards</option>
                        </select>
                    </div>
                </div>

                <div class="control-section">
                    <div class="control-section-title">Add Stairs</div>
                    <div class="stair-grid">
                        <button type="button" class="stair-btn" data-side="front">Front</button>
                        <button type="button" class="stair-btn" data-side="back">Back</button>
                        <button type="button" class="stair-btn" data-side="left">Left</button>
                        <button type="button" class="stair-btn" data-side="right">Right</button>
                    </div>
                    <div class="field" style="margin-top: 0.5rem;">
                        <label>Stair Width (ft)</label>
                        <input type="number" id="stair-width" value="4" min="3" max="8" step="0.5">
                    </div>
                </div>

                <div class="control-section">
                    <div class="control-section-title">Options</div>
                    <div class="check-row">
                        <input type="checkbox" id="add-railing">
                        <label for="add-railing">Add Railing</label>
                    </div>
                    <div class="check-row">
                        <input type="checkbox" id="add-border">
                        <label for="add-border">Picture Frame Border</label>
                    </div>
                    <div class="check-row" style="margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px dashed var(--border-subtle);">
                        <input type="checkbox" id="add-plugs">
                        <label for="add-plugs">Add Color-Matching Plugs</label>
                        <span class="hint" id="plugs-hint">(0 boxes)</span>
                    </div>
                </div>

                <div class="material-summary">
                    <h4>Materials Estimate</h4>
                    <div class="material-row">
                        <span>Deck Boards:</span>
                        <span id="mat-boards">0</span>
                    </div>
                    <div class="material-row">
                        <span>Border Boards:</span>
                        <span id="mat-border">0</span>
                    </div>
                    <div class="material-row">
                        <span>Stair Treads:</span>
                        <span id="mat-stairs">0</span>
                    </div>
                    <div class="material-row">
                        <span>Screw Boxes:</span>
                        <span id="mat-screws">0</span>
                    </div>
                    <div class="material-row optional" id="plugs-row" style="display: none;">
                        <span>Plug Boxes (optional):</span>
                        <span id="mat-plugs">0</span>
                    </div>
                    <div class="material-row">
                        <span>Estimated Total:</span>
                        <span id="mat-total">$0.00</span>
                    </div>
                </div>

                <button type="button" class="btn btn-primary" id="apply-order">
                    Apply to Order Form
                </button>
                <button type="button" class="btn btn-ghost" id="reset-builder">
                    Reset Design
                </button>
            </div>

            <!-- 3D Viewport -->
            <div class="builder-viewport" id="viewport-container">
                <div class="viewport-instructions">
                    Drag to rotate | Scroll to zoom
                </div>
                <div class="viewport-color-indicator">
                    <img id="viewport-color-img" src="colors/Driftwood.png" alt="Color">
                    <span id="viewport-color-name">Driftwood</span>
                </div>
                <div class="texture-loading" id="texture-loading">
                    <div class="spinner"></div>
                    <span>Loading texture...</span>
                </div>
                <canvas id="deck-canvas"></canvas>
                <div class="viewport-overlay">
                    <button type="button" class="view-btn active" data-view="3d">3D</button>
                    <button type="button" class="view-btn" data-view="top">Top</button>
                    <button type="button" class="view-btn" data-view="front">Front</button>
                    <button type="button" class="view-btn" data-view="side">Side</button>
                </div>
            </div>
        </div>
    </section>

    <!-- Customer Info -->
    <section class="card">
        <h2 class="card-title">Customer Information</h2>
        <div class="form-grid form-grid-2">
            <div class="field">
                <label>Name *</label>
                <input type="text" id="cust-name">
            </div>
            <div class="field">
                <label>Company</label>
                <input type="text" id="cust-company">
            </div>
            <div class="field">
                <label>Phone *</label>
                <input type="tel" id="cust-phone">
            </div>
            <div class="field">
                <label>Email *</label>
                <input type="email" id="cust-email">
            </div>
        </div>
        <div class="field" style="margin-top: 0.75rem;">
            <label>Address *</label>
            <textarea id="cust-address" rows="2"></textarea>
        </div>
    </section>

    <!-- Order Details -->
    <section class="card">
        <h2 class="card-title">Order Details</h2>
        <p class="card-subtitle">Generated from your 3D design. Edit quantities as needed.</p>

        <table class="order-table" id="order-table">
            <thead>
                <tr>
                    <th>Product</th>
                    <th>Color</th>
                    <th>Length</th>
                    <th>Qty</th>
                    <th>Unit Price</th>
                    <th>Subtotal</th>
                </tr>
            </thead>
            <tbody id="order-tbody">
                <tr>
                    <td colspan="6" style="text-align: center; color: var(--text-muted); padding: 2rem;">
                        Design your deck above, then click "Apply to Order Form"
                    </td>
                </tr>
            </tbody>
        </table>

        <div class="total-bar">
            <span class="label">Estimated Total</span>
            <span class="value" id="grand-total">$0.00</span>
        </div>
    </section>

    <!-- Special Instructions -->
    <section class="card">
        <h2 class="card-title">Additional Notes</h2>
        <div class="field">
            <label>Special Instructions</label>
            <textarea id="special-notes" placeholder="Any special requirements for your order..."></textarea>
        </div>
    </section>

    <!-- Actions -->
    <section class="card">
        <div class="actions-row">
            <button type="button" class="btn btn-ghost" id="btn-reset">Reset Form</button>
            <button type="button" class="btn btn-primary" id="btn-pdf">Export PDF</button>
            <button type="button" class="btn btn-primary" id="btn-submit">Submit Order</button>
        </div>
    </section>

    <footer>
        <a href="http://www.ameridex.com" target="_blank">www.ameridex.com</a>
    </footer>
</div>

<!-- Color Preview Modal -->
<div id="colorModal" class="modal">
    <div class="modal-content">
        <button type="button" class="modal-close" id="modal-close">&times;</button>
        <img id="modal-color-img" src="" alt="Color Preview">
        <div style="margin-top: 0.75rem; font-weight: 600; font-size: 1.1rem;" id="modal-color-name"></div>
    </div>
</div>

<!-- Three.js -->
<script type="importmap">
{
    "imports": {
        "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
        "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
    }
}
</script>

<script type="module">
import * as THREE from 'three';
import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

// ============================================
// COLOR CONFIGURATION - Matching Quote Program
// ============================================
const COLORS = ['Driftwood', 'Khaki', 'Slate', 'Beachwood', 'Chestnut', 'Redwood', 'Hazelnut'];

const COLOR_IMAGES = {
    Driftwood: 'Driftwood.png',
    Khaki: 'Khaki.png',
    Slate: 'Slate.png',
    Beachwood: 'Beachwood.png',
    Chestnut: 'Chestnut.png',
    Redwood: 'Redwood.png',
    Hazelnut: 'Hazelnut.png'
};

// Fallback hex colors (only used if texture fails to load)
const COLOR_HEX_FALLBACK = {
    Driftwood: 0xA89F91,
    Khaki: 0xC2B280,
    Slate: 0x708090,
    Beachwood: 0xD4C4A8,
    Chestnut: 0x954535,
    Redwood: 0xA45A52,
    Hazelnut: 0x8B7355
};

// ============================================
// PRODUCT CONFIGURATION - Matching Quote Program
// ============================================
const PRODUCTS = {
    system: { 
        name: 'AmeriDex System Boards (Grooved + Dexerdry included)', 
        price: 8.00,
        isFt: true,
        hasColor: true
    },
    solid: { 
        name: 'Solid Edge Deck Boards', 
        price: 6.00,
        isFt: true,
        hasColor: true
    },
    screws: { 
        name: 'Epoxy-Coated Screws (box of 375)', 
        price: 37.00,
        isFt: false,
        hasColor: false
    },
    plugs: {
        name: 'Color-Matching Plugs',
        price: 33.79,
        isFt: false,
        hasColor: true
    }
};

// Board dimensions (matching quote program)
const BOARD_WIDTH_INCH = 5.5;
const BOARD_THICKNESS_INCH = 1;
const GAP_INCH = 0.125;
const BOARD_WIDTH = BOARD_WIDTH_INCH / 12;
const BOARD_THICK = BOARD_THICKNESS_INCH / 12;
const BOARD_GAP = GAP_INCH / 12;
const EFFECTIVE_WIDTH = (BOARD_WIDTH_INCH + GAP_INCH) / 12;
const WASTE_FACTOR = 1.10;
const SCREWS_PER_BOX = 375;

// ============================================
// STATE
// ============================================
let state = {
    length: 16,
    width: 12,
    height: 3,
    color: 'Driftwood',
    boardLength: 16,
    stairs: { front: false, back: false, left: false, right: false },
    stairWidth: 4,
    railing: false,
    border: false,
    includePlugs: false
};

let orderItems = [];

// Three.js objects
let scene, camera, renderer, controls;
let deckGroup;
let deckTextures = {};
let texturesLoaded = {};

// ============================================
// TEXTURE LOADING - Using actual PNG images
// ============================================
const textureLoader = new THREE.TextureLoader();

function showTextureLoading(show) {
    const el = document.getElementById('texture-loading');
    if (show) {
        el.classList.add('visible');
    } else {
        el.classList.remove('visible');
    }
}

function loadColorTexture(colorName) {
    return new Promise((resolve, reject) => {
        if (deckTextures[colorName]) {
            resolve(deckTextures[colorName]);
            return;
        }

        showTextureLoading(true);

        textureLoader.load(
            `colors/${COLOR_IMAGES[colorName]}`,
            (texture) => {
                // Configure texture for realistic wood appearance
                texture.wrapS = THREE.RepeatWrapping;
                texture.wrapT = THREE.RepeatWrapping;
                texture.repeat.set(1, 4); // Stretch along board length
                texture.anisotropy = 16; // Better quality at angles
                texture.colorSpace = THREE.SRGBColorSpace;

                deckTextures[colorName] = texture;
                texturesLoaded[colorName] = true;
                showTextureLoading(false);
                resolve(texture);
            },
            undefined,
            (err) => {
                console.warn(`Could not load texture for ${colorName}, using fallback color`);
                texturesLoaded[colorName] = false;
                showTextureLoading(false);
                reject(err);
            }
        );
    });
}

// Preload all textures
function preloadAllTextures() {
    COLORS.forEach(colorName => {
        loadColorTexture(colorName).catch(() => {});
    });
}

// ============================================
// THREE.JS SETUP
// ============================================
function initScene() {
    const container = document.getElementById('viewport-container');
    const canvas = document.getElementById('deck-canvas');

    scene = new THREE.Scene();
    scene.background = new THREE.Color(0x87CEEB);

    const aspect = container.clientWidth / container.clientHeight;
    camera = new THREE.PerspectiveCamera(50, aspect, 0.1, 500);
    camera.position.set(20, 15, 20);

    renderer = new THREE.WebGLRenderer({ canvas, antialias: true });
    renderer.setSize(container.clientWidth, container.clientHeight);
    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
    renderer.shadowMap.enabled = true;
    renderer.shadowMap.type = THREE.PCFSoftShadowMap;
    renderer.outputColorSpace = THREE.SRGBColorSpace;

    controls = new OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.dampingFactor = 0.05;
    controls.minDistance = 5;
    controls.maxDistance = 80;
    controls.maxPolarAngle = Math.PI / 2 - 0.05;
    controls.target.set(0, state.height / 2, 0);

    // Lighting - enhanced for better texture visibility
    const ambient = new THREE.AmbientLight(0xffffff, 0.6);
    scene.add(ambient);

    const sun = new THREE.DirectionalLight(0xffffff, 0.9);
    sun.position.set(15, 25, 15);
    sun.castShadow = true;
    sun.shadow.mapSize.width = 2048;
    sun.shadow.mapSize.height = 2048;
    sun.shadow.camera.near = 1;
    sun.shadow.camera.far = 100;
    sun.shadow.camera.left = -30;
    sun.shadow.camera.right = 30;
    sun.shadow.camera.top = 30;
    sun.shadow.camera.bottom = -30;
    scene.add(sun);

    const fill = new THREE.DirectionalLight(0xffffff, 0.4);
    fill.position.set(-10, 10, -10);
    scene.add(fill);

    // Ground
    const groundGeo = new THREE.PlaneGeometry(80, 80);
    const groundMat = new THREE.MeshLambertMaterial({ color: 0x7CBA5F });
    const ground = new THREE.Mesh(groundGeo, groundMat);
    ground.rotation.x = -Math.PI / 2;
    ground.receiveShadow = true;
    scene.add(ground);

    // Grid
    const grid = new THREE.GridHelper(80, 80, 0x5CAD4A, 0x5CAD4A);
    grid.position.y = 0.01;
    grid.material.opacity = 0.3;
    grid.material.transparent = true;
    scene.add(grid);

    // Deck group
    deckGroup = new THREE.Group();
    scene.add(deckGroup);

    // Preload textures then build deck
    preloadAllTextures();

    // Initial build with current color
    loadColorTexture(state.color).then(() => {
        buildDeck();
    }).catch(() => {
        buildDeck(); // Build anyway with fallback
    });

    animate();

    window.addEventListener('resize', onResize);
}

function onResize() {
    const container = document.getElementById('viewport-container');
    camera.aspect = container.clientWidth / container.clientHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(container.clientWidth, container.clientHeight);
}

function animate() {
    requestAnimationFrame(animate);
    controls.update();
    renderer.render(scene, camera);
}

// ============================================
// CREATE DECK MATERIAL WITH TEXTURE
// ============================================
function createDeckMaterial(colorName) {
    if (deckTextures[colorName]) {
        // Clone texture so each board can have unique UV if needed
        const texture = deckTextures[colorName].clone();
        texture.needsUpdate = true;

        return new THREE.MeshStandardMaterial({
            map: texture,
            roughness: 0.8,
            metalness: 0.0,
            side: THREE.FrontSide
        });
    } else {
        // Fallback to solid color
        return new THREE.MeshStandardMaterial({
            color: COLOR_HEX_FALLBACK[colorName],
            roughness: 0.8,
            metalness: 0.0
        });
    }
}

// ============================================
// BUILD DECK
// ============================================
function buildDeck() {
    // Clear existing
    while (deckGroup.children.length > 0) {
        const child = deckGroup.children[0];
        if (child.geometry) child.geometry.dispose();
        if (child.material) {
            if (child.material.map) child.material.map.dispose();
            child.material.dispose();
        }
        deckGroup.remove(child);
    }

    const { length, width, height, color, stairs, stairWidth, railing, border } = state;

    // Materials
    const deckMat = createDeckMaterial(color);
    const supportMat = new THREE.MeshStandardMaterial({ color: 0x8B4513, roughness: 0.9 });
    const railMat = new THREE.MeshStandardMaterial({ color: 0x333333, roughness: 0.7 });

    // Support posts
    const postSize = 0.33;
    for (let x = 0; x <= length; x += 6) {
        for (let z = 0; z <= width; z += 6) {
            const postGeo = new THREE.BoxGeometry(postSize, height, postSize);
            const post = new THREE.Mesh(postGeo, supportMat);
            post.position.set(x - length/2, height/2, z - width/2);
            post.castShadow = true;
            post.receiveShadow = true;
            deckGroup.add(post);
        }
    }

    // Rim joists
    const rimHeight = 0.75;
    const rimThick = 0.125;

    const rimFBGeo = new THREE.BoxGeometry(length, rimHeight, rimThick);
    const rimFront = new THREE.Mesh(rimFBGeo, supportMat);
    rimFront.position.set(0, height - rimHeight/2, width/2);
    rimFront.castShadow = true;
    deckGroup.add(rimFront);

    const rimBack = new THREE.Mesh(rimFBGeo, supportMat);
    rimBack.position.set(0, height - rimHeight/2, -width/2);
    rimBack.castShadow = true;
    deckGroup.add(rimBack);

    const rimLRGeo = new THREE.BoxGeometry(rimThick, rimHeight, width);
    const rimLeft = new THREE.Mesh(rimLRGeo, supportMat);
    rimLeft.position.set(-length/2, height - rimHeight/2, 0);
    rimLeft.castShadow = true;
    deckGroup.add(rimLeft);

    const rimRight = new THREE.Mesh(rimLRGeo, supportMat);
    rimRight.position.set(length/2, height - rimHeight/2, 0);
    rimRight.castShadow = true;
    deckGroup.add(rimRight);

    // Deck boards - each gets its own material instance for proper texturing
    const numBoards = Math.ceil(length / EFFECTIVE_WIDTH);

    for (let i = 0; i < numBoards; i++) {
        const xPos = -length/2 + BOARD_WIDTH/2 + i * EFFECTIVE_WIDTH;
        if (xPos < length/2) {
            const boardGeo = new THREE.BoxGeometry(BOARD_WIDTH, BOARD_THICK, width - 0.1);
            const boardMat = createDeckMaterial(color);

            // Randomize texture offset slightly for variation
            if (boardMat.map) {
                boardMat.map = boardMat.map.clone();
                boardMat.map.offset.y = Math.random() * 0.5;
                boardMat.map.needsUpdate = true;
            }

            const board = new THREE.Mesh(boardGeo, boardMat);
            board.position.set(xPos, height + BOARD_THICK/2, 0);
            board.castShadow = true;
            board.receiveShadow = true;
            deckGroup.add(board);
        }
    }

    // Picture frame border
    if (border) {
        const borderMat = createDeckMaterial(color);

        const frameGeo1 = new THREE.BoxGeometry(length + BOARD_WIDTH * 2, BOARD_THICK * 1.2, BOARD_WIDTH);

        const frameFront = new THREE.Mesh(frameGeo1, borderMat);
        frameFront.position.set(0, height + BOARD_THICK/2 + 0.01, width/2 + BOARD_WIDTH/2);
        frameFront.castShadow = true;
        deckGroup.add(frameFront);

        const frameBack = new THREE.Mesh(frameGeo1.clone(), createDeckMaterial(color));
        frameBack.position.set(0, height + BOARD_THICK/2 + 0.01, -width/2 - BOARD_WIDTH/2);
        frameBack.castShadow = true;
        deckGroup.add(frameBack);

        const frameGeo2 = new THREE.BoxGeometry(BOARD_WIDTH, BOARD_THICK * 1.2, width);

        const frameLeft = new THREE.Mesh(frameGeo2, createDeckMaterial(color));
        frameLeft.position.set(-length/2 - BOARD_WIDTH/2, height + BOARD_THICK/2 + 0.01, 0);
        frameLeft.castShadow = true;
        deckGroup.add(frameLeft);

        const frameRight = new THREE.Mesh(frameGeo2.clone(), createDeckMaterial(color));
        frameRight.position.set(length/2 + BOARD_WIDTH/2, height + BOARD_THICK/2 + 0.01, 0);
        frameRight.castShadow = true;
        deckGroup.add(frameRight);
    }

    // Railings
    if (railing) {
        const railHeight = 3;
        const postSpacing = 4;

        const sides = [
            { skip: stairs.front, axis: 'x', pos: width/2, range: length },
            { skip: stairs.back, axis: 'x', pos: -width/2, range: length },
            { skip: stairs.left, axis: 'z', pos: -length/2, range: width },
            { skip: stairs.right, axis: 'z', pos: length/2, range: width }
        ];

        sides.forEach(side => {
            if (side.skip) return;

            const numPosts = Math.ceil(side.range / postSpacing) + 1;
            const postGeo = new THREE.BoxGeometry(0.1, railHeight, 0.1);

            for (let i = 0; i < numPosts; i++) {
                const offset = -side.range/2 + i * (side.range / (numPosts - 1));
                const railPost = new THREE.Mesh(postGeo, railMat);

                if (side.axis === 'x') {
                    railPost.position.set(offset, height + railHeight/2, side.pos);
                } else {
                    railPost.position.set(side.pos, height + railHeight/2, offset);
                }
                railPost.castShadow = true;
                deckGroup.add(railPost);
            }

            const topRailGeo = side.axis === 'x' 
                ? new THREE.BoxGeometry(side.range, 0.15, 0.25)
                : new THREE.BoxGeometry(0.25, 0.15, side.range);
            const topRail = new THREE.Mesh(topRailGeo, railMat);

            if (side.axis === 'x') {
                topRail.position.set(0, height + railHeight, side.pos);
            } else {
                topRail.position.set(side.pos, height + railHeight, 0);
            }
            topRail.castShadow = true;
            deckGroup.add(topRail);
        });
    }

    // Stairs
    Object.entries(stairs).forEach(([side, hasStairs]) => {
        if (!hasStairs) return;

        const numSteps = Math.ceil(height / 0.75);
        const stepRise = height / numSteps;
        const stepRun = 1;

        for (let s = 0; s < numSteps; s++) {
            const stepGeo = new THREE.BoxGeometry(
                (side === 'left' || side === 'right') ? stepRun : stairWidth,
                BOARD_THICK,
                (side === 'left' || side === 'right') ? stairWidth : stepRun
            );
            const stepMat = createDeckMaterial(color);
            const step = new THREE.Mesh(stepGeo, stepMat);

            const stepY = height - (s + 1) * stepRise + BOARD_THICK/2;
            let stepX = 0, stepZ = 0;

            if (side === 'front') stepZ = width/2 + (s + 1) * stepRun - stepRun/2;
            if (side === 'back') stepZ = -width/2 - (s + 1) * stepRun + stepRun/2;
            if (side === 'left') stepX = -length/2 - (s + 1) * stepRun + stepRun/2;
            if (side === 'right') stepX = length/2 + (s + 1) * stepRun - stepRun/2;

            step.position.set(stepX, stepY, stepZ);
            step.castShadow = true;
            step.receiveShadow = true;
            deckGroup.add(step);
        }

        // Stringers
        const stringerLen = numSteps * stepRun;
        const stringerGeo = new THREE.BoxGeometry(
            (side === 'left' || side === 'right') ? stringerLen : 0.125,
            0.75,
            (side === 'left' || side === 'right') ? 0.125 : stringerLen
        );

        [-stairWidth/2 + 0.15, stairWidth/2 - 0.15].forEach(offset => {
            const stringer = new THREE.Mesh(stringerGeo, supportMat);

            if (side === 'front') stringer.position.set(offset, height/2, width/2 + stringerLen/2);
            if (side === 'back') stringer.position.set(offset, height/2, -width/2 - stringerLen/2);
            if (side === 'left') stringer.position.set(-length/2 - stringerLen/2, height/2, offset);
            if (side === 'right') stringer.position.set(length/2 + stringerLen/2, height/2, offset);

            stringer.castShadow = true;
            deckGroup.add(stringer);
        });
    });

    controls.target.set(0, height/2, 0);
    updateEstimates();
}

// ============================================
// MATERIAL ESTIMATES
// ============================================
function updateEstimates() {
    const { length, width, height, boardLength, stairs, stairWidth, border, includePlugs } = state;

    const deckArea = length * width;
    const boardsNeeded = Math.ceil(length / EFFECTIVE_WIDTH);

    const totalBoardFeet = boardsNeeded * width;
    const numStockBoards = Math.ceil((totalBoardFeet * WASTE_FACTOR) / boardLength);

    let borderBoards = 0;
    if (border) {
        const perimeter = 2 * (length + width);
        borderBoards = Math.ceil((perimeter * WASTE_FACTOR) / boardLength);
    }

    let stairTreads = 0;
    Object.values(stairs).forEach(hasStairs => {
        if (hasStairs) {
            const numSteps = Math.ceil(height / 0.75);
            stairTreads += numSteps;
        }
    });

    const screwCount = Math.ceil(deckArea * 2);
    const screwBoxes = Math.ceil(screwCount / SCREWS_PER_BOX);

    // Plugs match screw boxes (one plug box per screw box)
    const plugBoxes = screwBoxes;

    // Update plug hint
    document.getElementById('plugs-hint').textContent = `(${plugBoxes} box${plugBoxes !== 1 ? 'es' : ''})`;

    // Show/hide plug row based on checkbox
    const plugsRow = document.getElementById('plugs-row');
    if (includePlugs) {
        plugsRow.style.display = 'flex';
        document.getElementById('mat-plugs').textContent = `${plugBoxes} box${plugBoxes !== 1 ? 'es' : ''}`;
    } else {
        plugsRow.style.display = 'none';
    }

    // Calculate costs
    const boardCost = numStockBoards * boardLength * PRODUCTS.system.price;
    const borderCost = borderBoards * boardLength * PRODUCTS.solid.price;
    const stairCost = stairTreads * 4 * PRODUCTS.solid.price;
    const screwCost = screwBoxes * PRODUCTS.screws.price;
    const plugCost = includePlugs ? plugBoxes * PRODUCTS.plugs.price : 0;
    const total = boardCost + borderCost + stairCost + screwCost + plugCost;

    document.getElementById('mat-boards').textContent = `${numStockBoards} @ ${boardLength}ft`;
    document.getElementById('mat-border').textContent = border ? `${borderBoards} @ ${boardLength}ft` : 'None';
    document.getElementById('mat-stairs').textContent = stairTreads > 0 ? `${stairTreads} treads` : 'None';
    document.getElementById('mat-screws').textContent = `${screwBoxes} box${screwBoxes !== 1 ? 'es' : ''}`;
    document.getElementById('mat-total').textContent = `$${total.toFixed(2)}`;

    state.estimates = { numStockBoards, borderBoards, stairTreads, screwBoxes, plugBoxes, total };
}

// ============================================
// CAMERA VIEWS
// ============================================
function setView(view) {
    const { length, width, height } = state;
    const maxDim = Math.max(length, width) * 1.2;

    switch(view) {
        case 'top':
            camera.position.set(0, maxDim * 1.5, 0.01);
            break;
        case 'front':
            camera.position.set(0, height + 5, maxDim);
            break;
        case 'side':
            camera.position.set(maxDim, height + 5, 0);
            break;
        default:
            camera.position.set(maxDim * 0.8, maxDim * 0.6, maxDim * 0.8);
    }

    controls.target.set(0, height/2, 0);
    camera.lookAt(0, height/2, 0);
}

// ============================================
// UI INITIALIZATION
// ============================================
function initUI() {
    // Color grid
    const colorGrid = document.getElementById('color-grid');
    COLORS.forEach((colorName, index) => {
        const card = document.createElement('div');
        card.className = 'color-card' + (colorName === state.color ? ' selected' : '');
        card.dataset.color = colorName;

        const img = document.createElement('img');
        img.src = `colors/${COLOR_IMAGES[colorName]}`;
        img.alt = colorName;
        img.onerror = () => { 
            img.style.background = '#' + COLOR_HEX_FALLBACK[colorName].toString(16).padStart(6, '0'); 
            img.style.height = '45px';
        };

        const label = document.createElement('div');
        label.className = 'color-card-label';
        label.textContent = colorName;

        card.appendChild(img);
        card.appendChild(label);

        card.onclick = () => {
            document.querySelectorAll('.color-card').forEach(c => c.classList.remove('selected'));
            card.classList.add('selected');
            state.color = colorName;
            updateColorPreviews();

            // Load texture if not already loaded, then rebuild
            loadColorTexture(colorName).then(() => {
                buildDeck();
            }).catch(() => {
                buildDeck();
            });
        };

        card.ondblclick = () => {
            showColorModal(colorName);
        };

        colorGrid.appendChild(card);
    });

    updateColorPreviews();

    // Dimension inputs
    document.getElementById('deck-length').oninput = (e) => {
        state.length = parseFloat(e.target.value) || 6;
        buildDeck();
    };
    document.getElementById('deck-width').oninput = (e) => {
        state.width = parseFloat(e.target.value) || 6;
        buildDeck();
    };
    document.getElementById('deck-height').oninput = (e) => {
        state.height = parseFloat(e.target.value) || 1;
        buildDeck();
    };

    // Board length
    document.getElementById('board-length').onchange = (e) => {
        state.boardLength = parseInt(e.target.value);
        updateEstimates();
    };

    // Stair width
    document.getElementById('stair-width').oninput = (e) => {
        state.stairWidth = parseFloat(e.target.value) || 3;
        buildDeck();
    };

    // Stair buttons
    document.querySelectorAll('.stair-btn').forEach(btn => {
        btn.onclick = () => {
            const side = btn.dataset.side;
            state.stairs[side] = !state.stairs[side];
            btn.classList.toggle('active', state.stairs[side]);
            buildDeck();
        };
    });

    // Options
    document.getElementById('add-railing').onchange = (e) => {
        state.railing = e.target.checked;
        buildDeck();
    };
    document.getElementById('add-border').onchange = (e) => {
        state.border = e.target.checked;
        buildDeck();
    };

    // Plugs option
    document.getElementById('add-plugs').onchange = (e) => {
        state.includePlugs = e.target.checked;
        updateEstimates();
    };

    // View buttons
    document.querySelectorAll('.view-btn').forEach(btn => {
        btn.onclick = () => {
            document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            setView(btn.dataset.view);
        };
    });

    // Apply to order
    document.getElementById('apply-order').onclick = applyToOrder;

    // Reset builder
    document.getElementById('reset-builder').onclick = resetBuilder;

    // Form buttons
    document.getElementById('btn-reset').onclick = () => {
        if (confirm('Clear entire form?')) {
            orderItems = [];
            renderOrder();
            ['cust-name','cust-company','cust-phone','cust-email','cust-address','special-notes'].forEach(id => {
                document.getElementById(id).value = '';
            });
        }
    };

    document.getElementById('btn-submit').onclick = submitOrder;
    document.getElementById('btn-pdf').onclick = generatePDF;

    // Modal close
    document.getElementById('modal-close').onclick = () => {
        document.getElementById('colorModal').classList.remove('active');
    };
    document.getElementById('colorModal').onclick = (e) => {
        if (e.target.id === 'colorModal') {
            document.getElementById('colorModal').classList.remove('active');
        }
    };
}

function updateColorPreviews() {
    const colorIndex = COLORS.indexOf(state.color);
    const compareColor = COLORS[(colorIndex + 1) % COLORS.length];

    document.getElementById('preview-color-1').src = `colors/${COLOR_IMAGES[state.color]}`;
    document.getElementById('preview-name-1').textContent = state.color;
    document.getElementById('preview-color-2').src = `colors/${COLOR_IMAGES[compareColor]}`;
    document.getElementById('preview-name-2').textContent = compareColor;

    document.getElementById('viewport-color-img').src = `colors/${COLOR_IMAGES[state.color]}`;
    document.getElementById('viewport-color-name').textContent = state.color;
}

function showColorModal(colorName) {
    document.getElementById('modal-color-img').src = `colors/${COLOR_IMAGES[colorName]}`;
    document.getElementById('modal-color-name').textContent = colorName;
    document.getElementById('colorModal').classList.add('active');
}

function resetBuilder() {
    state = {
        length: 16, width: 12, height: 3,
        color: 'Driftwood', boardLength: 16,
        stairs: { front: false, back: false, left: false, right: false },
        stairWidth: 4, railing: false, border: false, includePlugs: false
    };

    document.getElementById('deck-length').value = 16;
    document.getElementById('deck-width').value = 12;
    document.getElementById('deck-height').value = 3;
    document.getElementById('board-length').value = 16;
    document.getElementById('stair-width').value = 4;
    document.getElementById('add-railing').checked = false;
    document.getElementById('add-border').checked = false;
    document.getElementById('add-plugs').checked = false;

    document.querySelectorAll('.stair-btn').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.color-card').forEach(c => {
        c.classList.toggle('selected', c.dataset.color === 'Driftwood');
    });

    updateColorPreviews();
    buildDeck();
    setView('3d');
}

// ============================================
// ORDER FUNCTIONS
// ============================================
function applyToOrder() {
    const { color, boardLength, estimates, border, stairs, includePlugs } = state;

    orderItems = [];

    if (estimates.numStockBoards > 0) {
        orderItems.push({
            product: PRODUCTS.system.name,
            color: color,
            colorImg: COLOR_IMAGES[color],
            length: boardLength,
            qty: estimates.numStockBoards,
            unitPrice: PRODUCTS.system.price * boardLength
        });
    }

    if (border && estimates.borderBoards > 0) {
        orderItems.push({
            product: PRODUCTS.solid.name + ' (Border)',
            color: color,
            colorImg: COLOR_IMAGES[color],
            length: boardLength,
            qty: estimates.borderBoards,
            unitPrice: PRODUCTS.solid.price * boardLength
        });
    }

    if (estimates.stairTreads > 0) {
        orderItems.push({
            product: PRODUCTS.solid.name + ' (Stairs)',
            color: color,
            colorImg: COLOR_IMAGES[color],
            length: 4,
            qty: estimates.stairTreads,
            unitPrice: PRODUCTS.solid.price * 4
        });
    }

    if (estimates.screwBoxes > 0) {
        orderItems.push({
            product: PRODUCTS.screws.name,
            color: null,
            colorImg: null,
            length: null,
            qty: estimates.screwBoxes,
            unitPrice: PRODUCTS.screws.price
        });
    }

    // Add plugs if user opted in
    if (includePlugs && estimates.plugBoxes > 0) {
        orderItems.push({
            product: PRODUCTS.plugs.name,
            color: color,
            colorImg: COLOR_IMAGES[color],
            length: null,
            qty: estimates.plugBoxes,
            unitPrice: PRODUCTS.plugs.price
        });
    }

    renderOrder();
    document.getElementById('order-table').scrollIntoView({ behavior: 'smooth' });

    const btn = document.getElementById('apply-order');
    btn.textContent = 'Applied!';
    btn.classList.add('btn-success');
    setTimeout(() => {
        btn.textContent = 'Apply to Order Form';
        btn.classList.remove('btn-success');
    }, 2000);
}

function renderOrder() {
    const tbody = document.getElementById('order-tbody');
    tbody.innerHTML = '';

    if (orderItems.length === 0) {
        tbody.innerHTML = `<tr><td colspan="6" style="text-align: center; color: var(--text-muted); padding: 2rem;">
            Design your deck above, then click "Apply to Order Form"
        </td></tr>`;
        document.getElementById('grand-total').textContent = '$0.00';
        return;
    }

    let grandTotal = 0;

    orderItems.forEach(item => {
        const subtotal = item.unitPrice * item.qty;
        grandTotal += subtotal;

        const tr = document.createElement('tr');

        const tdProduct = document.createElement('td');
        tdProduct.textContent = item.product;
        tr.appendChild(tdProduct);

        const tdColor = document.createElement('td');
        if (item.color && item.colorImg) {
            tdColor.innerHTML = `<div class="color-cell">
                <img src="colors/${item.colorImg}" alt="${item.color}">
                <span>${item.color}</span>
            </div>`;
        } else {
            tdColor.textContent = 'N/A';
        }
        tr.appendChild(tdColor);

        const tdLength = document.createElement('td');
        tdLength.textContent = item.length ? `${item.length} ft` : 'N/A';
        tr.appendChild(tdLength);

        const tdQty = document.createElement('td');
        tdQty.className = 'numeric';
        tdQty.textContent = item.qty;
        tr.appendChild(tdQty);

        const tdPrice = document.createElement('td');
        tdPrice.className = 'numeric';
        tdPrice.textContent = `$${item.unitPrice.toFixed(2)}`;
        tr.appendChild(tdPrice);

        const tdSub = document.createElement('td');
        tdSub.className = 'numeric';
        tdSub.textContent = `$${subtotal.toFixed(2)}`;
        tr.appendChild(tdSub);

        tbody.appendChild(tr);
    });

    document.getElementById('grand-total').textContent = `$${grandTotal.toFixed(2)}`;
}

function submitOrder() {
    const name = document.getElementById('cust-name').value || 'Customer';
    const email = document.getElementById('cust-email').value || '';
    const phone = document.getElementById('cust-phone').value || '';
    const total = document.getElementById('grand-total').textContent;

    let body = `AmeriDex Order%0A%0A`;
    body += `Customer: ${name}%0A`;
    body += `Email: ${email}%0A`;
    body += `Phone: ${phone}%0A%0A`;
    body += `Items:%0A`;

    orderItems.forEach((item, i) => {
        body += `${i+1}. ${item.product}`;
        if (item.color) body += ` - ${item.color}`;
        if (item.length) body += ` - ${item.length}ft`;
        body += ` x ${item.qty}%0A`;
    });

    body += `%0ATotal: ${total}`;

    window.location.href = `mailto:sales@ameridex.com?subject=AmeriDex Order - ${name}&body=${body}`;
}

function generatePDF() {
    if (typeof window.jspdf === 'undefined') {
        alert('PDF generation is available when jsPDF library is loaded.');
        return;
    }

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    doc.setFontSize(18);
    doc.text('AmeriDex Order', 105, 20, { align: 'center' });

    let y = 35;
    doc.setFontSize(12);
    doc.text('Customer: ' + (document.getElementById('cust-name').value || 'N/A'), 20, y);
    y += 8;
    doc.text('Email: ' + (document.getElementById('cust-email').value || 'N/A'), 20, y);
    y += 8;
    doc.text('Phone: ' + (document.getElementById('cust-phone').value || 'N/A'), 20, y);
    y += 15;

    doc.setFontSize(14);
    doc.text('Order Items:', 20, y);
    y += 10;

    doc.setFontSize(10);
    orderItems.forEach((item, i) => {
        let line = `${i+1}. ${item.product}`;
        if (item.color) line += ` - ${item.color}`;
        if (item.length) line += ` - ${item.length}ft`;
        line += ` x ${item.qty} = $${(item.unitPrice * item.qty).toFixed(2)}`;
        doc.text(line, 20, y);
        y += 7;
        if (y > 270) {
            doc.addPage();
            y = 20;
        }
    });

    y += 10;
    doc.setFontSize(14);
    doc.text('Total: ' + document.getElementById('grand-total').textContent, 20, y);

    doc.save('ameridex-order.pdf');
}

// ============================================
// INIT
// ============================================
initScene();
initUI();

</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

</body>
</html>
