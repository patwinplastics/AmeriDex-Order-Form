<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AmeriDex Order Form</title>
<style>
    :root {
        --bg-page: #f5f7fa;
        --bg-card: #ffffff;
        --primary: #2563eb;
        --primary-dark: #1d4ed8;
        --primary-soft: #eff6ff;
        --border-subtle: #e5e7eb;
        --text-main: #111827;
        --text-muted: #6b7280;
        --danger: #dc2626;
        --shadow-soft: 0 10px 25px rgba(15, 23, 42, 0.08);
        --radius-card: 14px;
        --radius-field: 8px;
    }

    * { box-sizing: border-box; }

    body {
        margin: 0;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        background-color: var(--bg-page);
        color: var(--text-main);
        line-height: 1.5;
    }

    .page-shell {
        max-width: 1120px;
        margin: 0 auto;
        padding: 1.5rem 1.25rem 2.5rem;
    }

    header.app-header {
        background: linear-gradient(135deg, #2563eb, #1e40af);
        color: #fff;
        padding: 2.4rem 1.75rem 2.6rem;
        border-radius: 0 0 var(--radius-card) var(--radius-card);
        box-shadow: var(--shadow-soft);
        text-align: center;
        position: sticky;
        top: 0;
        z-index: 5;
    }

    header.app-header img {
        max-width: 220px;
        height: auto;
        display: block;
        margin: 0 auto 0.75rem;
    }

    header.app-header h1 {
        margin: 0.25rem 0 0.5rem;
        font-size: 1.9rem;
        letter-spacing: 0.03em;
    }

    header.app-header p.header-sub {
        margin: 0.15rem 0 0;
        font-size: 0.88rem;
        color: rgba(249, 250, 251, 0.9);
    }

    main { margin-top: 1.5rem; }

    .card {
        background: var(--bg-card);
        border-radius: var(--radius-card);
        padding: 1.75rem;
        margin-bottom: 1.25rem;
        box-shadow: 0 1px 3px rgba(15, 23, 42, 0.05);
        border: 1px solid rgba(148, 163, 184, 0.18);
    }

    .card-header {
        margin-bottom: 1rem;
        border-bottom: 1px solid rgba(229, 231, 235, 0.9);
        padding-bottom: 0.75rem;
    }

    .card-title {
        margin: 0;
        font-size: 1.15rem;
        font-weight: 700;
        letter-spacing: 0.01em;
    }

    .card-subtitle {
        margin: 0.2rem 0 0;
        font-size: 0.88rem;
        color: var(--text-muted);
    }

    .form-grid {
        display: grid;
        grid-template-columns: minmax(0, 1fr);
        gap: 0.9rem 1.25rem;
    }

    .field {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
    }

    .field-row-2 {
        display: grid;
        grid-template-columns: minmax(0, 1fr);
        gap: 0.9rem 1.25rem;
    }

    @media (min-width: 768px) {
        .field-row-2 {
            grid-template-columns: minmax(0, 1fr) minmax(0, 1fr);
        }
    }

    label {
        font-size: 0.9rem;
        font-weight: 600;
        color: #374151;
    }

    .required-indicator {
        color: var(--danger);
        margin-left: 0.15rem;
    }

    input[type="text"],
    input[type="email"],
    input[type="tel"],
    input[type="number"],
    input[type="date"],
    textarea,
    select {
        width: 100%;
        padding: 0.68rem 0.7rem;
        border-radius: var(--radius-field);
        border: 1px solid var(--border-subtle);
        font-size: 0.94rem;
        color: var(--text-main);
        background-color: #ffffff;
        transition: border-color 0.12s ease, box-shadow 0.12s ease, background-color 0.12s ease;
    }

    input:focus,
    textarea:focus,
    select:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.22);
        background-color: #f9fafb;
    }

    textarea {
        min-height: 90px;
        resize: vertical;
    }

    .error {
        font-size: 0.78rem;
        color: var(--danger);
        margin-top: 0.1rem;
    }

    .hint {
        font-size: 0.82rem;
        color: var(--text-muted);
        margin-top: 0.15rem;
    }

    .inline-checks {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        margin-bottom: 0.75rem;
    }

    .check-row {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .check-row input[type="checkbox"] {
        width: 16px;
        height: 16px;
    }

    .note-inline {
        margin-left: 1.6rem;
        font-size: 0.82rem;
        color: #b45309;
    }

    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 1rem;
        font-size: 0.9rem;
    }

    thead { background-color: #f9fafb; }

    th,
    td {
        border: 1px solid var(--border-subtle);
        padding: 0.55rem 0.5rem;
        vertical-align: middle;
    }

    th {
        font-weight: 600;
        color: #4b5563;
        text-align: left;
        font-size: 0.84rem;
    }

    th.numeric,
    td.numeric {
        text-align: right;
    }

    td input,
    td select {
        font-size: 0.86rem;
        padding: 0.4rem 0.45rem;
        border-radius: 6px;
    }

    td .qty-input { max-width: 70px; }
    td .len-input { max-width: 90px; }
    td .price-input { max-width: 110px; }

    .preview-img {
        width: 34px;
        height: 34px;
        object-fit: cover;
        border-radius: 6px;
        cursor: pointer;
        margin-left: 0.45rem;
        border: 1px solid #e5e7eb;
        background-color: #f9fafb;
    }

    .table-actions-cell {
        text-align: center;
        width: 40px;
    }

    .btn-remove-row {
        background-color: #fee2e2;
        color: #b91c1c;
        border-radius: 999px;
        border: none;
        padding: 0.18rem 0.55rem;
        font-size: 1rem;
        cursor: pointer;
    }

    .btn-remove-row:hover {
        background-color: #fecaca;
    }

    .btn-add-row {
        margin-top: 0.9rem;
        font-size: 0.88rem;
        padding-inline: 1rem;
    }

    .total-bar {
        display: flex;
        justify-content: flex-end;
        align-items: center;
        padding: 0.9rem 1.1rem;
        border-radius: var(--radius-card);
        background: #f9fafb;
        border: 1px solid var(--border-subtle);
    }

    .total-label {
        font-size: 0.92rem;
        color: #4b5563;
        margin-right: 0.4rem;
    }

    .total-value {
        font-size: 1.25rem;
        font-weight: 700;
        color: #1e40af;
    }

    .fastener-block {
        margin-top: 0.9rem;
        padding: 0.7rem 0.8rem;
        background-color: var(--primary-soft);
        border-radius: 10px;
        border: 1px dashed #bfdbfe;
        font-size: 0.85rem;
        color: #1d4ed8;
    }

    .fastener-warning {
        color: #b91c1c;
        font-size: 0.8rem;
        margin-top: 0.45rem;
    }

    .actions-row {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 0.75rem;
    }

    .btn {
        border-radius: 999px;
        padding: 0.7rem 1.6rem;
        font-size: 0.9rem;
        font-weight: 600;
        cursor: pointer;
        border: 1px solid transparent;
        transition: background-color 0.12s ease, border-color 0.12s ease, color 0.12s ease, box-shadow 0.12s ease;
    }

    .btn-primary {
        background-color: var(--primary);
        color: #ffffff;
        box-shadow: 0 10px 20px rgba(37, 99, 235, 0.18);
    }

    .btn-primary:hover { background-color: var(--primary-dark); }

    .btn-outline {
        background-color: #ffffff;
        color: var(--primary);
        border-color: var(--primary);
    }

    .btn-outline:hover { background-color: #eff6ff; }

    .btn-ghost {
        background-color: transparent;
        color: #374151;
        border-color: #d1d5db;
    }

    .btn-ghost:hover { background-color: #f9fafb; }

    .success-banner {
        margin-top: 0.85rem;
        padding: 0.65rem 0.9rem;
        border-radius: 10px;
        background-color: #ecfdf3;
        color: #166534;
        font-size: 0.84rem;
        border: 1px solid #bbf7d0;
    }

    .modal {
        display: none;
        position: fixed;
        inset: 0;
        background-color: rgba(15, 23, 42, 0.55);
        z-index: 50;
        justify-content: center;
        align-items: center;
        padding: 1.25rem;
    }

    .modal-content {
        background: #ffffff;
        padding: 1.25rem;
        border-radius: 12px;
        max-width: 90%;
        max-height: 90vh;
        text-align: center;
        position: relative;
        box-shadow: var(--shadow-soft);
    }

    .modal-content img {
        max-width: 100%;
        max-height: 70vh;
        border-radius: 10px;
    }

    .modal-close {
        position: absolute;
        top: 10px;
        right: 12px;
        font-size: 1.5rem;
        cursor: pointer;
        color: #6b7280;
    }

    .modal-close:hover { color: #111827; }

    footer.app-footer {
        text-align: center;
        padding: 1.5rem 1.25rem 0.5rem;
        font-size: 0.83rem;
        color: var(--text-muted);
    }

    footer.app-footer a {
        color: var(--primary);
        text-decoration: none;
    }

    footer.app-footer a:hover { text-decoration: underline; }

    /* Mobile layout for line items */
    @media (max-width: 768px) {
        header.app-header {
            border-radius: 0 0 10px 10px;
            padding-inline: 1.25rem;
        }
        .card { padding-inline: 1.2rem; }

        #line-items,
        #line-items thead,
        #line-items tbody,
        #line-items th,
        #line-items td,
        #line-items tr {
            display: block;
        }

        #line-items thead { display: none; }

        #line-items tr {
            margin-bottom: 1.1rem;
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
            background-color: #ffffff;
            padding: 0.55rem 0.85rem 0.7rem;
        }

        #line-items td {
            border: none;
            padding: 0.28rem 0;
            text-align: left;
        }

        #line-items td::before {
            content: attr(data-label);
            display: block;
            font-weight: 600;
            font-size: 0.8rem;
            color: #6b7280;
            margin-bottom: 0.05rem;
        }

        #line-items td.numeric { text-align: left; }

        .table-actions-cell {
            text-align: right;
            margin-top: 0.45rem;
        }

        .preview-img { margin-top: 0.35rem; }

        td input,
        td select { width: 100%; }
    }
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>

<div class="page-shell">
    <header class="app-header">
        <!-- Rename your file to this path for simplicity -->
        <img src="colors/AmeriDex-logo.png" alt="AmeriDex Logo">
        <h1>AmeriDex Order Form</h1>
        <p class="header-sub">
            AmeriDex System Boards pricing includes integrated Dexerdry. Use standalone Dexerdry only for non-system applications.
        </p>
    </header>

    <main>
        <form id="order-form">

            <!-- Customer -->
            <section class="card" id="customer">
                <div class="card-header">
                    <h2 class="card-title">Customer Information</h2>
                    <p class="card-subtitle">Where this order will be used and who we should contact.</p>
                </div>

                <div class="form-grid">
                    <div class="field-row-2">
                        <div class="field">
                            <label for="cust-name">Name<span class="required-indicator">*</span></label>
                            <input type="text" id="cust-name" required>
                            <div class="error" id="err-name"></div>
                        </div>
                        <div class="field">
                            <label for="cust-company">Company</label>
                            <input type="text" id="cust-company">
                            <div class="error" id="err-company"></div>
                        </div>
                    </div>

                    <div class="field">
                        <label for="cust-address">Address<span class="required-indicator">*</span></label>
                        <textarea id="cust-address" rows="3" required></textarea>
                        <div class="error" id="err-address"></div>
                    </div>

                    <div class="field-row-2">
                        <div class="field">
                            <label for="cust-phone">Phone<span class="required-indicator">*</span></label>
                            <input type="tel" id="cust-phone" required>
                            <div class="error" id="err-phone"></div>
                        </div>
                        <div class="field">
                            <label for="cust-email">Email<span class="required-indicator">*</span></label>
                            <input type="email" id="cust-email" required>
                            <div class="error" id="err-email"></div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Order -->
            <section class="card" id="order">
                <div class="card-header">
                    <h2 class="card-title">Order Details</h2>
                    <p class="card-subtitle">Deck layout, boards, and special requirements.</p>
                </div>

                <div class="inline-checks">
                    <div class="check-row">
                        <input type="checkbox" id="use-calc">
                        <label for="use-calc">Use Deck Calculator (suggests AmeriDex System Boards)</label>
                    </div>
                </div>

                <div id="calc-panel" style="display:none; margin-bottom:0.9rem;">
                    <div class="field-row-2">
                        <div class="field">
                            <label for="deck-len">Deck Length (ft)</label>
                            <input type="number" id="deck-len" step="0.1" min="0">
                        </div>
                        <div class="field">
                            <label for="deck-wid">Deck Width (ft)</label>
                            <input type="number" id="deck-wid" step="0.1" min="0">
                        </div>
                    </div>

                    <div class="field-row-2" style="margin-top:0.5rem;">
                        <div class="field">
                            <label for="orientation">Board Orientation</label>
                            <select id="orientation">
                                <option value="parallel">Parallel to Length</option>
                                <option value="perpendicular" selected>Perpendicular to Length</option>
                            </select>
                        </div>
                        <div class="field" style="align-self:flex-end;">
                            <button type="button" class="btn btn-outline" id="calc-btn">Calculate & Suggest</button>
                        </div>
                    </div>

                    <div id="calc-result" class="hint" style="margin-top:0.65rem;"></div>
                </div>

                <div class="inline-checks" style="margin-top:0.4rem;">
                    <div class="check-row">
                        <input type="checkbox" id="pic-frame">
                        <label for="pic-frame">Picture Framing</label>
                    </div>
                    <div id="pic-frame-note" class="note-inline" style="display:none;">Add Solid Edge boards to frame the deck perimeter.</div>

                    <div class="check-row" style="margin-top:0.2rem;">
                        <input type="checkbox" id="stairs">
                        <label for="stairs">Stairs</label>
                    </div>
                    <div id="stairs-note" class="note-inline" style="display:none;">Add Solid Edge boards for stair treads and risers.</div>
                </div>

                <div id="fastener-hint" class="fastener-block" style="display:none;"></div>

                <table id="line-items">
                    <thead>
                    <tr>
                        <th>Product</th>
                        <th>Color</th>
                        <th>Length (ft)</th>
                        <th class="numeric">Qty</th>
                        <th class="numeric">Unit Price</th>
                        <th class="numeric">Subtotal</th>
                        <th class="table-actions-cell"></th>
                    </tr>
                    </thead>
                    <tbody></tbody>
                </table>

                <button type="button" class="btn btn-outline btn-add-row" id="add-row">+ Add Line Item</button>

                <div style="margin-top:1.4rem;" class="form-grid">
                    <div class="field">
                        <label for="special-instr">Special Instructions / Notes for Production</label>
                        <textarea id="special-instr" rows="3"></textarea>
                    </div>
                    <div class="field">
                        <label for="internal-notes">Internal Sales Rep Notes</label>
                        <textarea id="internal-notes" rows="2"></textarea>
                    </div>
                </div>
            </section>

            <!-- Shipping -->
            <section class="card">
                <div class="card-header">
                    <h2 class="card-title">Shipping & Delivery</h2>
                    <p class="card-subtitle">Delivery details if different from the customer information.</p>
                </div>

                <div class="form-grid">
                    <div class="field">
                        <label for="ship-addr">Shipping Address (if different)</label>
                        <textarea id="ship-addr" rows="3"></textarea>
                    </div>
                    <div class="field">
                        <label for="del-date">Preferred Delivery Date</label>
                        <input type="date" id="del-date">
                    </div>
                </div>
            </section>

            <!-- Attachments -->
            <section class="card">
                <div class="card-header">
                    <h2 class="card-title">Attachments</h2>
                    <p class="card-subtitle">Optional plans, sketches, or drawings to clarify your layout.</p>
                </div>

                <div class="form-grid">
                    <div class="field">
                        <label for="files">Attachments (plans, sketches, etc.)</label>
                        <input type="file" id="files" multiple accept="image/*,.pdf">
                        <div class="error" id="err-files"></div>
                        <p class="hint">
                            Attachments cannot be auto-attached via email link. After clicking Submit Order, attach files manually in your email client.
                        </p>
                    </div>
                </div>
            </section>

            <!-- Total -->
            <section class="card">
                <div class="total-bar">
                    <span class="total-label">Estimated Total</span>
                    <span class="total-value" id="grand-total">$0.00</span>
                </div>
            </section>

            <!-- Actions -->
            <section class="card" style="text-align:center;">
                <div class="actions-row">
                    <button type="button" class="btn btn-ghost" id="reset">Reset Form</button>
                    <button type="button" class="btn btn-outline" id="pdf">Export PDF</button>
                    <button type="submit" class="btn btn-primary" id="submit">Submit Order - Email</button>
                </div>
                <div id="success-msg" class="success-banner" style="display:none;">
                    Order email prepared. Remember to attach any files in your email client before sending.
                </div>
            </section>
        </form>
    </main>

    <!-- Color preview modal -->
    <div id="colorModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" id="modal-close">&times;</span>
            <img id="colorLarge" src="" alt="Color Preview">
            <div id="colorName" style="margin-top:0.75rem;font-weight:600;"></div>
        </div>
    </div>

    <footer class="app-footer">
        <a href="http://www.ameridex.com" target="_blank">www.ameridex.com</a>
    </footer>
</div>

<script>
const PRODUCTS = {
    system:   { name: "AmeriDex System Boards (Grooved + Dexerdry included)",   price: 8.00,  isFt: true,  hasColor: true },
    grooved:  { name: "Grooved Deck Boards (no Dexerdry)",                      price: 6.00,  isFt: true,  hasColor: true },
    solid:    { name: "Solid Edge Deck Boards",                                 price: 6.00,  isFt: true,  hasColor: true },
    dexerdry: { name: "Dexerdry Seals (standalone - for non-system decks)",     price: 2.00,  isFt: true,  hasColor: false },
    screws:   { name: "Epoxy-Coated Screws",                                    price: 37,    isFt: false, hasColor: false },
    plugs:    { name: "Color-Matching Plugs",                                   price: 33.79, isFt: false, hasColor: false },
    custom:   { name: "Custom / Manual Item",                                   price: 0,     isFt: false, hasColor: false }
};

const COLORS = ["Driftwood","Khaki","Slate","Beachwood","Chestnut","Redwood","Hazelnut"];

// Match these to the actual extensions in /colors
const COLOR_IMAGES = {
    Driftwood: "Driftwood.jpg",
    Khaki: "Khaki.jpg",
    Slate: "Slate.jpg",          // add when available
    Beachwood: "Beachwood.jpg",
    Chestnut: "Chestnut.jpg",
    Redwood: "Redwood.jpg",
    Hazelnut: "Hazelnut.jpg"
};

const BOARD_WIDTH_INCH = 5.5;
const GAP_INCH = 0.125;
const EFFECTIVE_FT = (BOARD_WIDTH_INCH + GAP_INCH) / 12;
const WASTE = 1.10;
const MAX_ATTACHMENT_BYTES = 10 * 1024 * 1024;
const SCREWS_PER_BOX = 375;

let lineItems = [];
let deckLengthFt = 0;
let deckWidthFt = 0;

const tbody = document.querySelector("#line-items tbody");
const modal = document.getElementById("colorModal");
const modalImg = document.getElementById("colorLarge");
const modalName = document.getElementById("colorName");
const closeBtn = document.getElementById("modal-close");

document.getElementById("use-calc").addEventListener("change", e => {
    document.getElementById("calc-panel").style.display = e.target.checked ? "block" : "none";
});

["pic-frame","stairs"].forEach(id => {
    document.getElementById(id).addEventListener("change", e => {
        document.getElementById(id + "-note").style.display = e.target.checked ? "block" : "none";
    });
});

document.getElementById("add-row").onclick = () => {
    lineItems.push({
        type: "system",
        color: "",
        length: 16,
        qty: 1,
        priceOverride: null,
        customDesc: "",
        customUnitPrice: 0
    });
    render();
    updateTotalAndFasteners();
};

document.getElementById("calc-btn").onclick = calculateAndSuggest;

closeBtn.onclick = () => modal.style.display = "none";
window.onclick = e => { if (e.target === modal) modal.style.display = "none"; };

document.getElementById("reset").onclick = () => {
    if (!confirm("Clear the entire form?")) return;
    lineItems = [];
    render();
    updateTotalAndFasteners();
    ["cust-name","cust-company","cust-address","cust-phone","cust-email","ship-addr","del-date","special-instr","internal-notes"].forEach(id => {
        document.getElementById(id).value = "";
    });
    document.getElementById("files").value = "";
    document.getElementById("use-calc").checked = false;
    document.getElementById("calc-panel").style.display = "none";
    document.getElementById("pic-frame").checked = false;
    document.getElementById("stairs").checked = false;
    document.getElementById("pic-frame-note").style.display = "none";
    document.getElementById("stairs-note").style.display = "none";
    const hintEl = document.getElementById("fastener-hint");
    hintEl.style.display = "none";
    hintEl.innerHTML = "";
    document.getElementById("success-msg").style.display = "none";
};

document.getElementById("pdf").onclick = generatePDF;

document.getElementById("order-form").addEventListener("submit", e => {
    e.preventDefault();
    submitOrder();
});

function render() {
    tbody.innerHTML = "";
    lineItems.forEach((item, i) => {
        const prod = PRODUCTS[item.type] || PRODUCTS.custom;
        const row = document.createElement("tr");

        // Product
        let td = document.createElement("td");
        td.setAttribute("data-label", "Product");
        const sel = document.createElement("select");
        Object.keys(PRODUCTS).forEach(k => {
            const opt = document.createElement("option");
            opt.value = k;
            opt.textContent = PRODUCTS[k].name;
            if (k === item.type) opt.selected = true;
            sel.appendChild(opt);
        });
        sel.onchange = () => {
            item.type = sel.value;
            if (item.type !== "custom") {
                item.customDesc = "";
                item.customUnitPrice = 0;
            }
            if (!PRODUCTS[item.type].isFt) item.length = null;
            render();
            updateTotalAndFasteners();
        };
        td.appendChild(sel);
        row.appendChild(td);

        // Color
        td = document.createElement("td");
        td.setAttribute("data-label", "Color");
        if (prod.hasColor) {
            const csel = document.createElement("select");
            COLORS.forEach(c => {
                const o = document.createElement("option");
                o.value = c;
                o.textContent = c;
                if (c === item.color) o.selected = true;
                csel.appendChild(o);
            });

            const prev = document.createElement("img");

            function applyImage() {
                const colorName = item.color || COLORS[0];
                const imgFile = COLOR_IMAGES[colorName] || COLOR_IMAGES.Driftwood;
                prev.src = "colors/" + imgFile;
            }

            csel.onchange = e => {
                item.color = e.target.value;
                applyImage();              // immediate update on any device
                updateTotalAndFasteners();
            };

            td.appendChild(csel);

            item.color = item.color || COLORS[0];
            applyImage();

            prev.className = "preview-img";
            prev.alt = "preview";
            prev.title = "Click to enlarge";
            prev.onerror = () => { prev.src = "https://via.placeholder.com/34?text=?"; };
            prev.onclick = () => {
                modalImg.src = prev.src;
                modalName.textContent = item.color || COLORS[0];
                modal.style.display = "flex";
            };

            td.appendChild(prev);
        }
        row.appendChild(td);

        // Length
        td = document.createElement("td");
        td.setAttribute("data-label", "Length (ft)");
        if (prod.isFt) {
            if (["system","grooved","solid"].includes(item.type)) {
                const lsel = document.createElement("select");
                [12,16,20].forEach(l => {
                    const o = document.createElement("option");
                    o.value = l;
                    o.text = l + " ft";
                    if (l === item.length) o.selected = true;
                    lsel.appendChild(o);
                });
                const custOpt = document.createElement("option");
                custOpt.value = "custom";
                custOpt.text = "Custom";
                if (![12,16,20].includes(item.length)) custOpt.selected = true;
                lsel.appendChild(custOpt);

                lsel.onchange = e => {
                    if (e.target.value === "custom") {
                        const val = prompt("Custom length (ft):", item.length || "");
                        item.length = parseFloat(val) || 16;
                    } else {
                        item.length = parseFloat(e.target.value);
                    }
                    render();
                    updateTotalAndFasteners();
                };
                td.appendChild(lsel);
            } else {
                const inp = document.createElement("input");
                inp.type = "number";
                inp.step = "0.1";
                inp.min = "0";
                inp.className = "len-input";
                inp.value = item.length || "";
                inp.oninput = e => { item.length = parseFloat(e.target.value) || 0; updateTotalAndFasteners(); };
                td.appendChild(inp);
            }
        }
        row.appendChild(td);

        // Qty and custom extras
        td = document.createElement("td");
        td.className = "numeric";
        td.setAttribute("data-label", "Qty");
        const q = document.createElement("input");
        q.type = "number";
        q.min = "1";
        q.step = "1";
        q.className = "qty-input";
        q.value = item.qty;
        q.oninput = e => { item.qty = Math.max(1, parseInt(e.target.value) || 1); updateTotalAndFasteners(); };
        td.appendChild(q);

        if (item.type === "custom") {
            const d = document.createElement("input");
            d.type = "text";
            d.placeholder = "Description";
            d.style.marginTop = "0.3rem";
            d.value = item.customDesc || "";
            d.oninput = e => item.customDesc = e.target.value;
            td.appendChild(d);

            const up = document.createElement("input");
            up.type = "number";
            up.step = "0.01";
            up.placeholder = "Unit $";
            up.style.marginTop = "0.25rem";
            up.value = item.customUnitPrice || "";
            up.oninput = e => { item.customUnitPrice = parseFloat(e.target.value) || 0; updateTotalAndFasteners(); };
            td.appendChild(up);
        }
        row.appendChild(td);

        // Unit price
        td = document.createElement("td");
        td.className = "numeric";
        td.setAttribute("data-label", "Unit Price");
        if (prod.isFt || item.type === "custom") {
            const p = document.createElement("input");
            p.type = "number";
            p.step = "0.01";
            p.min = "0";
            p.className = "price-input";
            const defPrice = item.type === "custom" ? item.customUnitPrice : prod.price;
            p.placeholder = "default $" + defPrice.toFixed(2);
            p.value = item.priceOverride ?? "";
            p.oninput = e => { item.priceOverride = parseFloat(e.target.value); updateTotalAndFasteners(); };
            td.appendChild(p);
        } else {
            td.textContent = "$" + prod.price.toFixed(2);
        }
        row.appendChild(td);

        // Subtotal
        td = document.createElement("td");
        td.className = "numeric";
        td.id = "sub-" + i;
        td.setAttribute("data-label", "Subtotal");
        row.appendChild(td);

        // Remove
        td = document.createElement("td");
        td.className = "table-actions-cell";
        td.setAttribute("data-label", "Actions");
        const rm = document.createElement("button");
        rm.type = "button";
        rm.textContent = "×";
        rm.className = "btn-remove-row";
        rm.onclick = () => { lineItems.splice(i, 1); render(); updateTotalAndFasteners(); };
        td.appendChild(rm);
        row.appendChild(td);

        tbody.appendChild(row);
    });
}

function getItemPrice(item) {
    const prod = PRODUCTS[item.type] || PRODUCTS.custom;
    if (item.priceOverride != null && !Number.isNaN(item.priceOverride)) return item.priceOverride;
    if (item.type === "custom") return item.customUnitPrice || 0;
    return prod.price;
}

function getItemSubtotal(item) {
    const prod = PRODUCTS[item.type] || PRODUCTS.custom;
    const price = getItemPrice(item);
    if (prod.isFt || (item.type === "custom" && item.length)) {
        return item.qty * (item.length || 0) * price;
    }
    return item.qty * price;
}

function updateTotalAndFasteners() {
    let total = 0;
    let totalGroovedBoards = 0;
    let hasSystem = false;
    let hasStandaloneDex = false;

    lineItems.forEach((item, i) => {
        const sub = getItemSubtotal(item);
        total += sub;
        const subCell = document.getElementById("sub-" + i);
        if (subCell) subCell.textContent = "$" + sub.toFixed(2);

        if (["system","grooved"].includes(item.type)) {
            totalGroovedBoards += item.qty;
        }
        if (item.type === "system") hasSystem = true;
        if (item.type === "dexerdry") hasStandaloneDex = true;
    });

    document.getElementById("grand-total").textContent = "$" + total.toFixed(2);

    const hintEl = document.getElementById("fastener-hint");
    let hintHtml = "";

    if (totalGroovedBoards > 0 && deckLengthFt > 0) {
        const joistCount = Math.floor(deckLengthFt * 12 / 16) + 1;
        const intersections = totalGroovedBoards * joistCount;
        const screwsNeeded = intersections * 2;
        const boxesScrews = Math.ceil(screwsNeeded / SCREWS_PER_BOX);

        hintHtml += "<strong>Fastener suggestion (reference only):</strong><br>" +
            "≈ " + boxesScrews + " boxes of screws<br>" +
            "≈ " + boxesScrews + " boxes of plugs";
    }

    if (hasSystem && hasStandaloneDex) {
        hintHtml += '<div class="fastener-warning">AmeriDex System Boards already include Dexerdry in the price. Standalone Dexerdry is typically only needed for non-system decks.</div>';
    }

    if (hintHtml) {
        hintEl.style.display = "block";
        hintEl.innerHTML = hintHtml;
    } else {
        hintEl.style.display = "none";
        hintEl.innerHTML = "";
    }
}

function calculateAndSuggest() {
    deckLengthFt = parseFloat(document.getElementById("deck-len").value) || 0;
    deckWidthFt = parseFloat(document.getElementById("deck-wid").value) || 0;

    if (deckLengthFt <= 0 || deckWidthFt <= 0) {
        alert("Please enter both deck length and width greater than 0.");
        return;
    }

    const perp = document.getElementById("orientation").value === "perpendicular";
    const span = perp ? deckLengthFt : deckWidthFt;
    const run  = perp ? deckWidthFt  : deckLengthFt;

    const boardsNeeded = Math.ceil((span / EFFECTIVE_FT) * WASTE);
    const dexerdryFt = (boardsNeeded - 1) * run * WASTE;

    const msg =
        "<strong>Suggested AmeriDex System Boards (Dexerdry included in price)</strong><br>" +
        "• " + boardsNeeded + " boards @ " + run.toFixed(1) + " ft each<br>" +
        "• Total board ft: " + (boardsNeeded * run).toFixed(1) + "<br>" +
        "• Integrated Dexerdry coverage (for reference): " + dexerdryFt.toFixed(1) + " ft<br><br>" +
        "(10% waste included)";
    document.getElementById("calc-result").innerHTML = msg;

    if (confirm("Add suggested AmeriDex System Boards to the order?")) {
        lineItems.push({
            type: "system",
            color: "Driftwood",
            length: Math.min(20, Math.round(run)),
            qty: boardsNeeded,
            priceOverride: null,
            customDesc: "",
            customUnitPrice: 0
        });
        render();
        updateTotalAndFasteners();
    }
}

function validateRequired() {
    const form = document.getElementById("order-form");
    if (form && !form.reportValidity()) {
        return false;
    }

    let ok = true;

    let totalBytes = 0;
    const files = document.getElementById("files").files;
    for (let file of files) totalBytes += file.size;
    const fileErr = document.getElementById("err-files");
    fileErr.textContent = totalBytes > MAX_ATTACHMENT_BYTES ? "Total attachments exceed 10 MB." : "";
    if (totalBytes > MAX_ATTACHMENT_BYTES) ok = false;

    for (let item of lineItems) {
        if (item.qty < 1) {
            alert("All quantities must be at least 1.");
            return false;
        }
    }

    return ok;
}

function generateOrderText() {
    let txt = "AmeriDex Order\n\nCUSTOMER:\n";
    txt += "Name:     " + document.getElementById("cust-name").value + "\n";
    txt += "Company:  " + (document.getElementById("cust-company").value || "") + "\n";
    txt += "Address:  " + document.getElementById("cust-address").value.replace(/\n/g," | ") + "\n";
    txt += "Phone:    " + document.getElementById("cust-phone").value + "\n";
    txt += "Email:    " + document.getElementById("cust-email").value + "\n\n";

    txt += "ORDER LINES:\n";
    lineItems.forEach(item => {
        const prod = PRODUCTS[item.type]?.name || "Custom";
        const color = item.color ? " (" + item.color + ")" : "";
        const len = item.length ? " × " + item.length.toFixed(1) + " ft" : "";
        const price = getItemPrice(item);
        const sub = getItemSubtotal(item);
        txt += "• " + prod + color + len + "  Qty: " + item.qty + "   $" + price.toFixed(2) + "/unit   Subtotal: $" + sub.toFixed(2) + "\n";
    });

    const grand = lineItems.reduce((s,i)=>s+getItemSubtotal(i),0);
    txt += "\nESTIMATED TOTAL: $" + grand.toFixed(2) + "\n\n";

    txt += "SHIPPING:\n" + (document.getElementById("ship-addr").value.replace(/\n/g," | ") || "(same as customer)") + "\n";
    txt += "Preferred Date: " + (document.getElementById("del-date").value || "-") + "\n\n";

    const instr = document.getElementById("special-instr").value.trim();
    if (instr) txt += "SPECIAL INSTRUCTIONS:\n" + instr + "\n\n";

    const notes = document.getElementById("internal-notes").value.trim();
    if (notes) txt += "INTERNAL NOTES:\n" + notes + "\n";

    return txt;
}

function submitOrder() {
    if (!validateRequired()) return;

    const body = generateOrderText();
    const name = document.getElementById("cust-name").value.trim() || "Customer";
    const subject = "New AmeriDex Order - " + name;

    location.href = "mailto:sales@ameridex.com?subject=" +
        encodeURIComponent(subject) + "&body=" + encodeURIComponent(body);

    const msg = document.getElementById("success-msg");
    msg.style.display = "block";
    setTimeout(() => { msg.style.display = "none"; }, 12000);
}

function generatePDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    let y = 20;

    doc.setFontSize(20);
    doc.text("AmeriDex Order Estimate", 105, y, {align:"center"}); y += 12;

    doc.setFontSize(12);
    doc.text("Customer:", 15, y); y += 7;
    doc.setFontSize(10);
    doc.text(document.getElementById("cust-name").value,    20, y); y += 6;
    doc.text(document.getElementById("cust-company").value, 20, y); y += 6;
    let addr = document.getElementById("cust-address").value.split("\n");
    addr.forEach(line => { doc.text(line, 20, y); y += 6; });
    y += 3;
    doc.text("Phone: " + document.getElementById("cust-phone").value, 20, y); y += 6;
    doc.text("Email: " + document.getElementById("cust-email").value, 20, y); y += 12;

    doc.setFontSize(12);
    doc.text("Order Lines:", 15, y); y += 8;
    doc.setFontSize(10);

    lineItems.forEach(item => {
        const prod = PRODUCTS[item.type]?.name || item.customDesc || "Custom";
        const color = item.color ? " (" + item.color + ")" : "";
        const len = item.length ? " × " + item.length + " ft" : "";
        const price = getItemPrice(item);
        const sub = getItemSubtotal(item);
        const line = prod + color + len + " × " + item.qty + "   $" + price.toFixed(2) + "   $" + sub.toFixed(2);
        doc.text(line, 20, y);
        y += 7;
        if (y > 270) { doc.addPage(); y = 20; }
    });

    const total = lineItems.reduce((s,i)=>s+getItemSubtotal(i),0);
    y += 5;
    doc.setFontSize(12);
    doc.text("Estimated Total: $" + total.toFixed(2), 20, y);

    y += 15;
    if (document.getElementById("special-instr").value.trim()) {
        doc.text("Special Instructions:", 15, y); y += 7;
        doc.setFontSize(10);
        let instrLines = document.getElementById("special-instr").value.split("\n");
        instrLines.forEach(l => { doc.text(l, 20, y); y += 6; if (y>270){doc.addPage(); y=20;} });
    }

    doc.save("AmeriDex_Order_" + new Date().toISOString().slice(0,10) + ".pdf");
}

render();
updateTotalAndFasteners();
</script>
</body>
</html>
