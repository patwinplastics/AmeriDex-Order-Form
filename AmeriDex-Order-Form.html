<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>AmeriDex 3D Deck Builder + Order Form</title>
<style>
    :root {
        --bg-page: #f5f7fa;
        --bg-card: #ffffff;
        --primary: #2563eb;
        --primary-dark: #1d4ed8;
        --primary-soft: #eff6ff;
        --border-subtle: #e5e7eb;
        --text-main: #111827;
        --text-muted: #6b7280;
        --danger: #dc2626;
        --success: #16a34a;
        --warning: #f59e0b;
        --shadow-soft: 0 10px 25px rgba(15, 23, 42, 0.08);
        --radius-card: 14px;
        --radius-field: 8px;
    }

    * { box-sizing: border-box; }

    html, body {
        margin: 0;
        padding: 0;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        background-color: var(--bg-page);
        color: var(--text-main);
        line-height: 1.5;
    }

    .page-shell {
        max-width: 1400px;
        margin: 0 auto;
        padding: 1rem;
    }

    header.app-header {
        background: linear-gradient(135deg, #2563eb, #1e40af);
        color: #fff;
        padding: 1.5rem 1rem;
        border-radius: 0 0 var(--radius-card) var(--radius-card);
        box-shadow: var(--shadow-soft);
        text-align: center;
        margin-bottom: 1rem;
    }

    header.app-header img.logo {
        max-width: 180px;
        height: auto;
        margin-bottom: 0.5rem;
    }

    header.app-header h1 {
        margin: 0;
        font-size: 1.6rem;
    }

    header.app-header p {
        margin: 0.5rem 0 0;
        font-size: 0.9rem;
        opacity: 0.9;
    }

    .card {
        background: var(--bg-card);
        border-radius: var(--radius-card);
        padding: 1.25rem;
        margin-bottom: 1rem;
        box-shadow: 0 1px 3px rgba(15, 23, 42, 0.08);
        border: 1px solid var(--border-subtle);
    }

    .card-title {
        margin: 0 0 0.5rem 0;
        font-size: 1.1rem;
        font-weight: 700;
        color: var(--primary);
    }

    .card-subtitle {
        margin: 0 0 1rem 0;
        font-size: 0.8rem;
        color: var(--text-muted);
    }

    /* 3D Builder Layout */
    .deck-builder-container {
        display: grid;
        grid-template-columns: 1fr;
        gap: 1rem;
    }

    @media (min-width: 1000px) {
        .deck-builder-container {
            grid-template-columns: 360px 1fr;
        }
    }

    .builder-controls {
        background: #f8fafc;
        border-radius: 12px;
        padding: 1rem;
        border: 1px solid var(--border-subtle);
        max-height: calc(100vh - 200px);
        overflow-y: auto;
    }

    .control-section {
        margin-bottom: 1.25rem;
        padding-bottom: 1rem;
        border-bottom: 1px dashed var(--border-subtle);
    }

    .control-section:last-child {
        border-bottom: none;
        margin-bottom: 0;
        padding-bottom: 0;
    }

    .control-section-title {
        font-size: 0.75rem;
        font-weight: 700;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: 0.6rem;
    }

    .field {
        margin-bottom: 0.6rem;
    }

    .field label {
        display: block;
        font-size: 0.8rem;
        font-weight: 600;
        margin-bottom: 0.25rem;
        color: #374151;
    }

    .field input,
    .field select {
        width: 100%;
        padding: 0.5rem;
        border: 1px solid var(--border-subtle);
        border-radius: 6px;
        font-size: 0.9rem;
    }

    .field input:focus,
    .field select:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.15);
    }

    /* Color Grid */
    .color-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 0.5rem;
    }

    .color-card {
        border: 3px solid transparent;
        border-radius: 8px;
        overflow: hidden;
        cursor: pointer;
        transition: all 0.2s ease;
        background: white;
    }

    .color-card:hover {
        border-color: var(--primary);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .color-card.selected {
        border-color: var(--primary);
        box-shadow: 0 0 0 2px white, 0 0 0 4px var(--primary);
    }

    .color-card img {
        width: 100%;
        height: 45px;
        object-fit: cover;
        display: block;
    }

    .color-card-label {
        text-align: center;
        font-size: 0.65rem;
        font-weight: 600;
        padding: 0.25rem 0.15rem;
        color: var(--text-main);
        background: #f9fafb;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    /* Color Preview Panel */
    .color-preview-panel {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 0.75rem;
        margin-top: 0.75rem;
        padding: 0.75rem;
        background: white;
        border-radius: 8px;
        border: 1px solid var(--border-subtle);
    }

    .color-preview-box {
        text-align: center;
    }

    .color-preview-box h5 {
        margin: 0 0 0.4rem 0;
        font-size: 0.7rem;
        color: var(--text-muted);
        text-transform: uppercase;
    }

    .color-preview-box img {
        width: 100%;
        max-width: 100px;
        height: 60px;
        object-fit: cover;
        border-radius: 6px;
        border: 1px solid var(--border-subtle);
    }

    .color-preview-box .color-name {
        font-size: 0.75rem;
        font-weight: 600;
        margin-top: 0.3rem;
    }

    /* Stair Buttons */
    .stair-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 0.4rem;
    }

    .stair-btn {
        padding: 0.5rem;
        font-size: 0.75rem;
        font-weight: 600;
        border: 1px solid var(--border-subtle);
        background: white;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.15s ease;
    }

    .stair-btn:hover {
        border-color: var(--primary);
        background: var(--primary-soft);
    }

    .stair-btn.active {
        background: var(--primary);
        color: white;
        border-color: var(--primary);
    }

    /* Options row */
    .check-row {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.4rem 0;
    }

    .check-row input[type="checkbox"] {
        width: 18px;
        height: 18px;
        cursor: pointer;
    }

    .check-row label {
        font-size: 0.85rem;
        cursor: pointer;
        margin: 0;
    }

    .check-row .hint {
        font-size: 0.7rem;
        color: var(--text-muted);
        margin-left: auto;
    }

    /* Material Summary */
    .material-summary {
        background: white;
        border-radius: 8px;
        padding: 0.75rem;
        border: 1px solid var(--border-subtle);
        margin-top: 1rem;
    }

    .material-summary h4 {
        margin: 0 0 0.5rem 0;
        font-size: 0.85rem;
        color: var(--primary-dark);
    }

    .material-row {
        display: flex;
        justify-content: space-between;
        font-size: 0.8rem;
        padding: 0.3rem 0;
        border-bottom: 1px dotted var(--border-subtle);
    }

    .material-row:last-child {
        border-bottom: none;
        padding-top: 0.5rem;
        margin-top: 0.25rem;
        border-top: 1px solid var(--border-subtle);
        font-weight: 700;
    }

    .material-row span:first-child {
        color: var(--text-muted);
    }

    .material-row span:last-child {
        font-weight: 600;
    }

    .material-row.optional {
        background: #fef3c7;
        margin: 0.25rem -0.5rem;
        padding: 0.4rem 0.5rem;
        border-radius: 4px;
        border-bottom: none;
    }

    .material-row.optional span:first-child {
        color: #92400e;
    }

    /* Buttons */
    .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 0.65rem 1rem;
        font-size: 0.85rem;
        font-weight: 600;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.15s ease;
        border: none;
    }

    .btn-primary {
        background: var(--primary);
        color: white;
    }

    .btn-primary:hover {
        background: var(--primary-dark);
    }

    .btn-success {
        background: var(--success);
        color: white;
    }

    .btn-outline {
        background: white;
        border: 1px solid var(--primary);
        color: var(--primary);
    }

    .btn-outline:hover {
        background: var(--primary-soft);
    }

    .btn-ghost {
        background: transparent;
        color: var(--text-muted);
        border: 1px solid var(--border-subtle);
        font-size: 0.8rem;
    }

    .btn-ghost:hover {
        border-color: var(--danger);
        color: var(--danger);
    }

    /* 3D Viewport */
    .builder-viewport {
        position: relative;
        background: linear-gradient(180deg, #87CEEB 0%, #B0E0E6 40%, #90EE90 100%);
        border-radius: 12px;
        overflow: hidden;
        min-height: 520px;
        border: 2px solid var(--border-subtle);
    }

    @media (min-width: 1000px) {
        .builder-viewport {
            min-height: 620px;
        }
    }

    #deck-canvas {
        width: 100% !important;
        height: 100% !important;
        display: block;
        position: absolute;
        top: 0;
        left: 0;
    }

    .viewport-overlay {
        position: absolute;
        bottom: 12px;
        left: 12px;
        display: flex;
        gap: 0.4rem;
        z-index: 10;
    }

    .view-btn {
        background: rgba(255,255,255,0.95);
        border: 1px solid var(--border-subtle);
        border-radius: 6px;
        padding: 0.4rem 0.75rem;
        font-size: 0.75rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.15s ease;
    }

    .view-btn:hover,
    .view-btn.active {
        background: var(--primary);
        color: white;
        border-color: var(--primary);
    }

    .viewport-instructions {
        position: absolute;
        top: 12px;
        left: 12px;
        background: rgba(0,0,0,0.6);
        color: white;
        padding: 0.5rem 0.75rem;
        border-radius: 6px;
        font-size: 0.7rem;
        z-index: 10;
    }

    .viewport-color-indicator {
        position: absolute;
        top: 12px;
        right: 12px;
        background: rgba(255,255,255,0.95);
        padding: 0.5rem 0.75rem;
        border-radius: 6px;
        font-size: 0.75rem;
        font-weight: 600;
        z-index: 10;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        border: 1px solid var(--border-subtle);
    }

    .viewport-color-indicator img {
        width: 24px;
        height: 24px;
        border-radius: 4px;
        object-fit: cover;
    }

    .texture-loading {
        position: absolute;
        bottom: 12px;
        right: 12px;
        background: rgba(255,255,255,0.95);
        padding: 0.4rem 0.6rem;
        border-radius: 6px;
        font-size: 0.7rem;
        z-index: 10;
        display: none;
        align-items: center;
        gap: 0.4rem;
        border: 1px solid var(--border-subtle);
    }

    .texture-loading.visible {
        display: flex;
    }

    .texture-loading .spinner {
        width: 12px;
        height: 12px;
        border: 2px solid var(--border-subtle);
        border-top-color: var(--primary);
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    /* Order table with manual line items */
    .order-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.85rem;
        margin-top: 1rem;
    }

    .order-table th,
    .order-table td {
        padding: 0.6rem;
        border: 1px solid var(--border-subtle);
        text-align: left;
    }

    .order-table th {
        background: #f9fafb;
        font-weight: 600;
        color: #4b5563;
    }

    .order-table td.numeric {
        text-align: right;
    }

    .order-table .color-cell {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .order-table .color-cell img {
        width: 28px;
        height: 28px;
        border-radius: 4px;
        object-fit: cover;
        border: 1px solid var(--border-subtle);
    }

    .line-input {
        width: 100%;
        padding: 0.35rem 0.4rem;
        font-size: 0.8rem;
        border-radius: 6px;
        border: 1px solid var(--border-subtle);
    }

    .line-input:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 1px rgba(37,99,235,0.2);
    }

    .line-select {
        width: 100%;
        padding: 0.35rem 0.4rem;
        font-size: 0.8rem;
        border-radius: 6px;
        border: 1px solid var(--border-subtle);
    }

    .btn-remove-row {
        background-color: #fee2e2;
        color: #b91c1c;
        border-radius: 999px;
        border: none;
        padding: 0.18rem 0.55rem;
        font-size: 1rem;
        cursor: pointer;
    }

    .btn-remove-row:hover {
        background-color: #fecaca;
    }

    .btn-add-row {
        margin-top: 0.75rem;
        font-size: 0.85rem;
    }

    .total-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem;
        background: var(--primary-soft);
        border-radius: 8px;
        margin-top: 1rem;
    }

    .total-bar .label {
        font-weight: 600;
        color: #4b5563;
    }

    .total-bar .value {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--primary-dark);
    }

    /* Customer fields */
    .form-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 0.75rem;
    }

    @media (min-width: 600px) {
        .form-grid-2 {
            grid-template-columns: 1fr 1fr;
        }
    }

    textarea {
        width: 100%;
        padding: 0.6rem;
        border: 1px solid var(--border-subtle);
        border-radius: 6px;
        font-size: 0.9rem;
        font-family: inherit;
        resize: vertical;
        min-height: 80px;
    }

    textarea:focus {
        outline: none;
        border-color: var(--primary);
    }

    .actions-row {
        display: flex;
        gap: 0.75rem;
        flex-wrap: wrap;
        justify-content: center;
        margin-top: 1rem;
    }

    .actions-row .btn {
        min-width: 140px;
    }

    footer {
        text-align: center;
        padding: 1.5rem;
        color: var(--text-muted);
        font-size: 0.8rem;
    }

    footer a {
        color: var(--primary);
        text-decoration: none;
    }

    footer a:hover {
        text-decoration: underline;
    }

    /* Color modal */
    .modal {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.5);
        z-index: 100;
        justify-content: center;
        align-items: center;
        padding: 1rem;
    }

    .modal.active {
        display: flex;
    }

    .modal-content {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        max-width: 400px;
        text-align: center;
        position: relative;
    }

    .modal-content img {
        max-width: 100%;
        border-radius: 8px;
    }

    .modal-close {
        position: absolute;
        top: 10px;
        right: 12px;
        font-size: 1.5rem;
        cursor: pointer;
        color: #6b7280;
        background: none;
        border: none;
    }

    .modal-close:hover {
        color: #111827;
    }

    /* Mobile tweaks for order table */
    @media (max-width: 768px) {
        .order-table, .order-table thead, .order-table tbody, .order-table th, .order-table td, .order-table tr {
            display: block;
        }
        .order-table thead {
            display: none;
        }
        .order-table tr {
            margin-bottom: 1rem;
            border: 1px solid var(--border-subtle);
            border-radius: 10px;
            background-color: #ffffff;
            padding: 0.5rem 0.75rem;
        }
        .order-table td {
            border: none;
            padding: 0.25rem 0;
            text-align: left;
        }
        .order-table td.numeric {
            text-align: left;
        }
        .order-table td::before {
            content: attr(data-label);
            display: block;
            font-weight: 600;
            font-size: 0.8rem;
            color: #6b7280;
            margin-bottom: 0.05rem;
        }
    }
</style>
</head>
<body>

<div class="page-shell">
    <header class="app-header">
        <img src="colors/AmeriDex.png" alt="AmeriDex Logo" class="logo">
        <h1>AmeriDex 3D Deck Builder & Order Form</h1>
        <p>Design your deck in 3D, then fine-tune the order with manual line items</p>
    </header>

    <!-- 3D Builder -->
    <section class="card">
        <h2 class="card-title">3D Deck Designer</h2>
        <p class="card-subtitle">Drag to rotate, scroll to zoom, right-click to pan</p>

        <div class="deck-builder-container">
            <!-- Controls Panel -->
            <div class="builder-controls">
                <div class="control-section">
                    <div class="control-section-title">Deck Dimensions</div>
                    <div class="field">
                        <label>Length (ft)</label>
                        <input type="number" id="deck-length" value="16" min="6" max="40" step="1">
                    </div>
                    <div class="field">
                        <label>Width (ft)</label>
                        <input type="number" id="deck-width" value="12" min="6" max="30" step="1">
                    </div>
                    <div class="field">
                        <label>Height (ft)</label>
                        <input type="number" id="deck-height" value="3" min="1" max="10" step="0.5">
                    </div>
                </div>

                <div class="control-section">
                    <div class="control-section-title">Board Color</div>
                    <div class="color-grid" id="color-grid"></div>

                    <div class="color-preview-panel">
                        <div class="color-preview-box">
                            <h5>Selected Color</h5>
                            <img id="preview-color-1" src="colors/Driftwood.png" alt="Selected">
                            <div class="color-name" id="preview-name-1">Driftwood</div>
                        </div>
                        <div class="color-preview-box">
                            <h5>Compare With</h5>
                            <img id="preview-color-2" src="colors/Khaki.png" alt="Compare">
                            <div class="color-name" id="preview-name-2">Khaki</div>
                        </div>
                    </div>
                </div>

                <div class="control-section">
                    <div class="control-section-title">Board Length</div>
                    <div class="field">
                        <select id="board-length">
                            <option value="12">12 ft boards</option>
                            <option value="16" selected>16 ft boards</option>
                            <option value="20">20 ft boards</option>
                        </select>
                    </div>
                </div>

                <div class="control-section">
                    <div class="control-section-title">Add Stairs</div>
                    <div class="stair-grid">
                        <button type="button" class="stair-btn" data-side="front">Front</button>
                        <button type="button" class="stair-btn" data-side="back">Back</button>
                        <button type="button" class="stair-btn" data-side="left">Left</button>
                        <button type="button" class="stair-btn" data-side="right">Right</button>
                    </div>
                    <div class="field" style="margin-top: 0.5rem;">
                        <label>Stair Width (ft)</label>
                        <input type="number" id="stair-width" value="4" min="3" max="8" step="0.5">
                    </div>
                </div>

                <div class="control-section">
                    <div class="control-section-title">Options</div>
                    <div class="check-row">
                        <input type="checkbox" id="add-railing">
                        <label for="add-railing">Add Railing</label>
                    </div>
                    <div class="check-row">
                        <input type="checkbox" id="add-border">
                        <label for="add-border">Picture Frame Border</label>
                    </div>
                    <div class="check-row" style="margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px dashed var(--border-subtle);">
                        <input type="checkbox" id="add-plugs">
                        <label for="add-plugs">Add Color-Matching Plugs</label>
                        <span class="hint" id="plugs-hint">(0 boxes)</span>
                    </div>
                </div>

                <div class="material-summary">
                    <h4>Materials Estimate</h4>
                    <div class="material-row">
                        <span>Deck Boards:</span>
                        <span id="mat-boards">0</span>
                    </div>
                    <div class="material-row">
                        <span>Border Boards:</span>
                        <span id="mat-border">0</span>
                    </div>
                    <div class="material-row">
                        <span>Stair Treads:</span>
                        <span id="mat-stairs">0</span>
                    </div>
                    <div class="material-row">
                        <span>Screw Boxes:</span>
                        <span id="mat-screws">0</span>
                    </div>
                    <div class="material-row optional" id="plugs-row" style="display: none;">
                        <span>Plug Boxes (optional):</span>
                        <span id="mat-plugs">0</span>
                    </div>
                    <div class="material-row">
                        <span>Estimated Total:</span>
                        <span id="mat-total">$0.00</span>
                    </div>
                </div>

                <button type="button" class="btn btn-primary" style="width: 100%; margin-top: 1rem;" id="apply-order">
                    Apply to Order Form
                </button>
                <button type="button" class="btn btn-ghost" style="width: 100%; margin-top: 0.5rem;" id="reset-builder">
                    Reset Design
                </button>
            </div>

            <!-- 3D Viewport -->
            <div class="builder-viewport" id="viewport-container">
                <div class="viewport-instructions">
                    Drag to rotate | Scroll to zoom
                </div>
                <div class="viewport-color-indicator">
                    <img id="viewport-color-img" src="colors/Driftwood.png" alt="Color">
                    <span id="viewport-color-name">Driftwood</span>
                </div>
                <div class="texture-loading" id="texture-loading">
                    <div class="spinner"></div>
                    <span>Loading texture...</span>
                </div>
                <canvas id="deck-canvas"></canvas>
                <div class="viewport-overlay">
                    <button type="button" class="view-btn active" data-view="3d">3D</button>
                    <button type="button" class="view-btn" data-view="top">Top</button>
                    <button type="button" class="view-btn" data-view="front">Front</button>
                    <button type="button" class="view-btn" data-view="side">Side</button>
                </div>
            </div>
        </div>
    </section>

    <!-- Customer Info -->
    <section class="card">
        <h2 class="card-title">Customer Information</h2>
        <div class="form-grid form-grid-2">
            <div class="field">
                <label>Name *</label>
                <input type="text" id="cust-name">
            </div>
            <div class="field">
                <label>Company</label>
                <input type="text" id="cust-company">
            </div>
            <div class="field">
                <label>Phone *</label>
                <input type="tel" id="cust-phone">
            </div>
            <div class="field">
                <label>Email *</label>
                <input type="email" id="cust-email">
            </div>
        </div>
        <div class="field" style="margin-top: 0.75rem;">
            <label>Address *</label>
            <textarea id="cust-address" rows="2"></textarea>
        </div>
    </section>

    <!-- Order Details: 3D-generated + Manual Line Items -->
    <section class="card">
        <h2 class="card-title">Order Details</h2>
        <p class="card-subtitle">3D design fills in starter lines. You can freely add, edit, or remove line items below.</p>

        <table class="order-table" id="order-table">
            <thead>
                <tr>
                    <th>Product</th>
                    <th>Color</th>
                    <th>Length</th>
                    <th>Qty</th>
                    <th>Unit Price</th>
                    <th>Subtotal</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="order-tbody">
                <tr>
                    <td colspan="7" style="text-align: center; color: var(--text-muted); padding: 2rem;">
                        Design your deck above and click "Apply to Order Form" or add your own line items below.
                    </td>
                </tr>
            </tbody>
        </table>

        <button type="button" class="btn btn-outline btn-add-row" id="btn-add-row">
            + Add Line Item
        </button>

        <div class="total-bar">
            <span class="label">Estimated Total</span>
            <span class="value" id="grand-total">$0.00</span>
        </div>
    </section>

    <!-- Special Instructions -->
    <section class="card">
        <h2 class="card-title">Additional Notes</h2>
        <div class="field">
            <label>Special Instructions</label>
            <textarea id="special-notes" placeholder="Any special requirements for your order..."></textarea>
        </div>
    </section>

    <!-- Actions -->
    <section class="card">
        <div class="actions-row">
            <button type="button" class="btn btn-ghost" id="btn-reset-form">Reset Form</button>
            <button type="button" class="btn btn-primary" id="btn-pdf">Export PDF</button>
            <button type="button" class="btn btn-primary" id="btn-submit">Submit Order</button>
        </div>
    </section>

    <footer>
        <a href="http://www.ameridex.com" target="_blank">www.ameridex.com</a>
    </footer>
</div>

<!-- Color Preview Modal -->
<div id="colorModal" class="modal">
    <div class="modal-content">
        <button type="button" class="modal-close" id="modal-close">&times;</button>
        <img id="modal-color-img" src="" alt="Color Preview">
        <div style="margin-top: 0.75rem; font-weight: 600; font-size: 1.1rem;" id="modal-color-name"></div>
    </div>
</div>

<!-- Three.js -->
<script type="importmap">
{
    "imports": {
        "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
        "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
    }
}
</script>

<script type="module">
import * as THREE from "three";
import { OrbitControls } from "three/addons/controls/OrbitControls.js";

// COLORS & IMAGES (quote program)
const COLORS = ["Driftwood", "Khaki", "Slate", "Beachwood", "Chestnut", "Redwood", "Hazelnut"];

const COLOR_IMAGES = {
    Driftwood: "Driftwood.png",
    Khaki: "Khaki.png",
    Slate: "Slate.png",
    Beachwood: "Beachwood.png",
    Chestnut: "Chestnut.png",
    Redwood: "Redwood.png",
    Hazelnut: "Hazelnut.png"
};

// Fallback hex colors
const COLOR_HEX_FALLBACK = {
    Driftwood: 0xA89F91,
    Khaki: 0xC2B280,
    Slate: 0x708090,
    Beachwood: 0xD4C4A8,
    Chestnut: 0x954535,
    Redwood: 0xA45A52,
    Hazelnut: 0x8B7355
};

// PRODUCTS (subset matched to your form)
const PRODUCTS = {
    system: {
        name: "AmeriDex System Boards (Grooved + Dexerdry included)",
        price: 8.0,
        isFt: true,
        hasColor: true
    },
    solid: {
        name: "Solid Edge Deck Boards",
        price: 6.0,
        isFt: true,
        hasColor: true
    },
    screws: {
        name: "Epoxy-Coated Screws (box of 375)",
        price: 37.0,
        isFt: false,
        hasColor: false
    },
    plugs: {
        name: "Color-Matching Plugs",
        price: 33.79,
        isFt: false,
        hasColor: true
    },
    custom: {
        name: "Custom Manual Item",
        price: 0,
        isFt: false,
        hasColor: false
    }
};

// Board geometry data
const BOARD_WIDTH_INCH = 5.5;
const BOARD_THICKNESS_INCH = 1;
const GAP_INCH = 0.125;
const BOARD_WIDTH = BOARD_WIDTH_INCH / 12;
const BOARD_THICK = BOARD_THICKNESS_INCH / 12;
const EFFECTIVE_WIDTH = (BOARD_WIDTH_INCH + GAP_INCH) / 12;
const WASTE_FACTOR = 1.1;
const SCREWS_PER_BOX = 375;

// 3D State
let state = {
    length: 16,
    width: 12,
    height: 3,
    color: "Driftwood",
    boardLength: 16,
    stairs: { front: false, back: false, left: false, right: false },
    stairWidth: 4,
    railing: false,
    border: false,
    includePlugs: false,
    estimates: {
        numStockBoards: 0,
        borderBoards: 0,
        stairTreads: 0,
        screwBoxes: 0,
        plugBoxes: 0,
        total: 0
    }
};

// Order line items array
let orderLines = [];

// Three.js globals
let scene, camera, renderer, controls;
let deckGroup;
let deckTextures = {};
let textureLoader = new THREE.TextureLoader();

// Show texture loading badge
function showTextureLoading(show) {
    const el = document.getElementById("texture-loading");
    if (show) el.classList.add("visible");
    else el.classList.remove("visible");
}

// Load one color texture
function loadColorTexture(colorName) {
    return new Promise((resolve, reject) => {
        if (deckTextures[colorName]) {
            resolve(deckTextures[colorName]);
            return;
        }
        showTextureLoading(true);
        textureLoader.load(
            "colors/" + COLOR_IMAGES[colorName],
            tex => {
                tex.wrapS = THREE.RepeatWrapping;
                tex.wrapT = THREE.RepeatWrapping;
                tex.repeat.set(1, 4);
                tex.anisotropy = 16;
                tex.colorSpace = THREE.SRGBColorSpace;
                deckTextures[colorName] = tex;
                showTextureLoading(false);
                resolve(tex);
            },
            undefined,
            err => {
                console.warn("Texture load failed for " + colorName, err);
                showTextureLoading(false);
                reject(err);
            }
        );
    });
}

// Preload all textures
function preloadAllTextures() {
    COLORS.forEach(c => loadColorTexture(c).catch(() => {}));
}

// Create deck material using texture if available
function createDeckMaterial(colorName) {
    if (deckTextures[colorName]) {
        const tex = deckTextures[colorName].clone();
        tex.needsUpdate = true;
        return new THREE.MeshStandardMaterial({
            map: tex,
            roughness: 0.8,
            metalness: 0.0,
            side: THREE.FrontSide
        });
    }
    return new THREE.MeshStandardMaterial({
        color: COLOR_HEX_FALLBACK[colorName],
        roughness: 0.8,
        metalness: 0.0
    });
}

// Init scene
function initScene() {
    const container = document.getElementById("viewport-container");
    const canvas = document.getElementById("deck-canvas");

    scene = new THREE.Scene();
    scene.background = new THREE.Color(0x87CEEB);

    camera = new THREE.PerspectiveCamera(
        50,
        container.clientWidth / container.clientHeight,
        0.1,
        500
    );
    camera.position.set(20, 15, 20);

    renderer = new THREE.WebGLRenderer({
        canvas,
        antialias: true
    });
    renderer.setSize(container.clientWidth, container.clientHeight);
    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
    renderer.shadowMap.enabled = true;
    renderer.shadowMap.type = THREE.PCFSoftShadowMap;
    renderer.outputColorSpace = THREE.SRGBColorSpace;

    controls = new OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.dampingFactor = 0.05;
    controls.minDistance = 5;
    controls.maxDistance = 80;
    controls.maxPolarAngle = Math.PI / 2 - 0.05;
    controls.target.set(0, state.height / 2, 0);

    const ambient = new THREE.AmbientLight(0xffffff, 0.6);
    scene.add(ambient);

    const sun = new THREE.DirectionalLight(0xffffff, 0.9);
    sun.position.set(15, 25, 15);
    sun.castShadow = true;
    sun.shadow.mapSize.width = 2048;
    sun.shadow.mapSize.height = 2048;
    sun.shadow.camera.near = 1;
    sun.shadow.camera.far = 100;
    sun.shadow.camera.left = -30;
    sun.shadow.camera.right = 30;
    sun.shadow.camera.top = 30;
    sun.shadow.camera.bottom = -30;
    scene.add(sun);

    const fill = new THREE.DirectionalLight(0xffffff, 0.4);
    fill.position.set(-10, 10, -10);
    scene.add(fill);

    const groundGeo = new THREE.PlaneGeometry(80, 80);
    const groundMat = new THREE.MeshLambertMaterial({ color: 0x7CBA5F });
    const ground = new THREE.Mesh(groundGeo, groundMat);
    ground.rotation.x = -Math.PI / 2;
    ground.receiveShadow = true;
    scene.add(ground);

    const grid = new THREE.GridHelper(80, 80, 0x5CAD4A, 0x5CAD4A);
    grid.position.y = 0.01;
    grid.material.transparent = true;
    grid.material.opacity = 0.3;
    scene.add(grid);

    deckGroup = new THREE.Group();
    scene.add(deckGroup);

    preloadAllTextures();

    loadColorTexture(state.color)
        .then(buildDeck)
        .catch(buildDeck);

    animate();
    window.addEventListener("resize", onResize);
}

function onResize() {
    const container = document.getElementById("viewport-container");
    camera.aspect = container.clientWidth / container.clientHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(container.clientWidth, container.clientHeight);
}

function animate() {
    requestAnimationFrame(animate);
    controls.update();
    renderer.render(scene, camera);
}

// Build deck
function buildDeck() {
    while (deckGroup.children.length) {
        const child = deckGroup.children[0];
        if (child.geometry) child.geometry.dispose();
        if (child.material) {
            if (child.material.map) child.material.map.dispose();
            child.material.dispose();
        }
        deckGroup.remove(child);
    }

    const { length, width, height, color, stairs, stairWidth, railing, border } =
        state;

    const deckMatBase = createDeckMaterial(color);
    const supportMat = new THREE.MeshStandardMaterial({
        color: 0x8B4513,
        roughness: 0.9
    });
    const railMat = new THREE.MeshStandardMaterial({
        color: 0x333333,
        roughness: 0.7
    });

    const postSize = 0.33;
    for (let x = 0; x <= length; x += 6) {
        for (let z = 0; z <= width; z += 6) {
            const postGeo = new THREE.BoxGeometry(postSize, height, postSize);
            const post = new THREE.Mesh(postGeo, supportMat);
            post.position.set(x - length / 2, height / 2, z - width / 2);
            post.castShadow = true;
            post.receiveShadow = true;
            deckGroup.add(post);
        }
    }

    const rimHeight = 0.75;
    const rimThick = 0.125;

    const rimFBGeo = new THREE.BoxGeometry(length, rimHeight, rimThick);
    const rimFront = new THREE.Mesh(rimFBGeo, supportMat);
    rimFront.position.set(0, height - rimHeight / 2, width / 2);
    rimFront.castShadow = true;
    deckGroup.add(rimFront);

    const rimBack = new THREE.Mesh(rimFBGeo, supportMat);
    rimBack.position.set(0, height - rimHeight / 2, -width / 2);
    rimBack.castShadow = true;
    deckGroup.add(rimBack);

    const rimLRGeo = new THREE.BoxGeometry(rimThick, rimHeight, width);
    const rimLeft = new THREE.Mesh(rimLRGeo, supportMat);
    rimLeft.position.set(-length / 2, height - rimHeight / 2, 0);
    rimLeft.castShadow = true;
    deckGroup.add(rimLeft);

    const rimRight = new THREE.Mesh(rimLRGeo, supportMat);
    rimRight.position.set(length / 2, height - rimHeight / 2, 0);
    rimRight.castShadow = true;
    deckGroup.add(rimRight);

    const numBoards = Math.ceil(length / EFFECTIVE_WIDTH);
    for (let i = 0; i < numBoards; i++) {
        const xPos = -length / 2 + BOARD_WIDTH / 2 + i * EFFECTIVE_WIDTH;
        if (xPos < length / 2) {
            const boardGeo = new THREE.BoxGeometry(
                BOARD_WIDTH,
                BOARD_THICK,
                width - 0.1
            );
            const boardMat = createDeckMaterial(color);
            if (boardMat.map) {
                boardMat.map = boardMat.map.clone();
                boardMat.map.offset.y = Math.random() * 0.5;
                boardMat.map.needsUpdate = true;
            }
            const board = new THREE.Mesh(boardGeo, boardMat);
            board.position.set(xPos, height + BOARD_THICK / 2, 0);
            board.castShadow = true;
            board.receiveShadow = true;
            deckGroup.add(board);
        }
    }

    if (border) {
        const frameGeo1 = new THREE.BoxGeometry(
            length + BOARD_WIDTH * 2,
            BOARD_THICK * 1.2,
            BOARD_WIDTH
        );
        const frameFront = new THREE.Mesh(frameGeo1, createDeckMaterial(color));
        frameFront.position.set(
            0,
            height + BOARD_THICK / 2 + 0.01,
            width / 2 + BOARD_WIDTH / 2
        );
        frameFront.castShadow = true;
        deckGroup.add(frameFront);

        const frameBack = new THREE.Mesh(frameGeo1, createDeckMaterial(color));
        frameBack.position.set(
            0,
            height + BOARD_THICK / 2 + 0.01,
            -width / 2 - BOARD_WIDTH / 2
        );
        frameBack.castShadow = true;
        deckGroup.add(frameBack);

        const frameGeo2 = new THREE.BoxGeometry(
            BOARD_WIDTH,
            BOARD_THICK * 1.2,
            width
        );
        const frameLeft = new THREE.Mesh(frameGeo2, createDeckMaterial(color));
        frameLeft.position.set(
            -length / 2 - BOARD_WIDTH / 2,
            height + BOARD_THICK / 2 + 0.01,
            0
        );
        frameLeft.castShadow = true;
        deckGroup.add(frameLeft);

        const frameRight = new THREE.Mesh(
            frameGeo2,
            createDeckMaterial(color)
        );
        frameRight.position.set(
            length / 2 + BOARD_WIDTH / 2,
            height + BOARD_THICK / 2 + 0.01,
            0
        );
        frameRight.castShadow = true;
        deckGroup.add(frameRight);
    }

    if (railing) {
        const railHeight = 3;
        const postSpacing = 4;

        const sides = [
            { skip: stairs.front, axis: "x", pos: width / 2, range: length },
            { skip: stairs.back, axis: "x", pos: -width / 2, range: length },
            { skip: stairs.left, axis: "z", pos: -length / 2, range: width },
            { skip: stairs.right, axis: "z", pos: length / 2, range: width }
        ];

        sides.forEach(side => {
            if (side.skip) return;

            const numPosts = Math.ceil(side.range / postSpacing) + 1;
            const postGeo = new THREE.BoxGeometry(0.1, railHeight, 0.1);

            for (let i = 0; i < numPosts; i++) {
                const offset =
                    -side.range / 2 + (i * side.range) / (numPosts - 1);
                const railPost = new THREE.Mesh(postGeo, railMat);
                if (side.axis === "x") {
                    railPost.position.set(
                        offset,
                        height + railHeight / 2,
                        side.pos
                    );
                } else {
                    railPost.position.set(
                        side.pos,
                        height + railHeight / 2,
                        offset
                    );
                }
                railPost.castShadow = true;
                deckGroup.add(railPost);
            }

            const topRailGeo =
                side.axis === "x"
                    ? new THREE.BoxGeometry(side.range, 0.15, 0.25)
                    : new THREE.BoxGeometry(0.25, 0.15, side.range);
            const topRail = new THREE.Mesh(topRailGeo, railMat);
            if (side.axis === "x") {
                topRail.position.set(0, height + railHeight, side.pos);
            } else {
                topRail.position.set(side.pos, height + railHeight, 0);
            }
            topRail.castShadow = true;
            deckGroup.add(topRail);
        });
    }

    Object.entries(stairs).forEach(([side, hasStairs]) => {
        if (!hasStairs) return;

        const numSteps = Math.ceil(height / 0.75);
        const stepRise = height / numSteps;
        const stepRun = 1;

        for (let s = 0; s < numSteps; s++) {
            const stepGeo = new THREE.BoxGeometry(
                side === "left" || side === "right" ? stepRun : stairWidth,
                BOARD_THICK,
                side === "left" || side === "right" ? stairWidth : stepRun
            );
            const stepMat = createDeckMaterial(color);
            const step = new THREE.Mesh(stepGeo, stepMat);

            const stepY = height - (s + 1) * stepRise + BOARD_THICK / 2;
            let stepX = 0;
            let stepZ = 0;

            if (side === "front")
                stepZ = width / 2 + (s + 1) * stepRun - stepRun / 2;
            if (side === "back")
                stepZ = -width / 2 - (s + 1) * stepRun + stepRun / 2;
            if (side === "left")
                stepX = -length / 2 - (s + 1) * stepRun + stepRun / 2;
            if (side === "right")
                stepX = length / 2 + (s + 1) * stepRun - stepRun / 2;

            step.position.set(stepX, stepY, stepZ);
            step.castShadow = true;
            step.receiveShadow = true;
            deckGroup.add(step);
        }

        const stringerLen = numSteps * stepRun;
        const stringerGeo = new THREE.BoxGeometry(
            side === "left" || side === "right" ? stringerLen : 0.125,
            0.75,
            side === "left" || side === "right" ? 0.125 : stringerLen
        );

        [-stairWidth / 2 + 0.15, stairWidth / 2 - 0.15].forEach(offset => {
            const stringer = new THREE.Mesh(stringerGeo, supportMat);
            if (side === "front")
                stringer.position.set(
                    offset,
                    height / 2,
                    width / 2 + stringerLen / 2
                );
            if (side === "back")
                stringer.position.set(
                    offset,
                    height / 2,
                    -width / 2 - stringerLen / 2
                );
            if (side === "left")
                stringer.position.set(
                    -length / 2 - stringerLen / 2,
                    height / 2,
                    offset
                );
            if (side === "right")
                stringer.position.set(
                    length / 2 + stringerLen / 2,
                    height / 2,
                    offset
                );
            stringer.castShadow = true;
            deckGroup.add(stringer);
        });
    });

    controls.target.set(0, height / 2, 0);
    updateEstimates();
}

// Material estimates
function updateEstimates() {
    const {
        length,
        width,
        height,
        boardLength,
        stairs,
        border,
        includePlugs
    } = state;

    const deckArea = length * width;
    const boardsNeeded = Math.ceil(length / EFFECTIVE_WIDTH);
    const totalBoardFeet = boardsNeeded * width;
    const numStockBoards = Math.ceil(
        (totalBoardFeet * WASTE_FACTOR) / boardLength
    );

    let borderBoards = 0;
    if (border) {
        const perimeter = 2 * (length + width);
        borderBoards = Math.ceil((perimeter * WASTE_FACTOR) / boardLength);
    }

    let stairTreads = 0;
    Object.values(stairs).forEach(hasStairs => {
        if (hasStairs) {
            const numSteps = Math.ceil(height / 0.75);
            stairTreads += numSteps;
        }
    });

    const screwCount = Math.ceil(deckArea * 2);
    const screwBoxes = Math.ceil(screwCount / SCREWS_PER_BOX);
    const plugBoxes = screwBoxes;

    document.getElementById("plugs-hint").textContent =
        "(" + plugBoxes + " box" + (plugBoxes !== 1 ? "es" : "") + ")";

    const plugsRow = document.getElementById("plugs-row");
    if (includePlugs) {
        plugsRow.style.display = "flex";
        document.getElementById("mat-plugs").textContent =
            plugBoxes + " box" + (plugBoxes !== 1 ? "es" : "");
    } else {
        plugsRow.style.display = "none";
    }

    const boardCost =
        numStockBoards * boardLength * PRODUCTS.system.price;
    const borderCost =
        borderBoards * boardLength * PRODUCTS.solid.price;
    const stairCost =
        stairTreads * 4 * PRODUCTS.solid.price;
    const screwCost = screwBoxes * PRODUCTS.screws.price;
    const plugCost = includePlugs ? plugBoxes * PRODUCTS.plugs.price : 0;
    const total = boardCost + borderCost + stairCost + screwCost + plugCost;

    document.getElementById("mat-boards").textContent =
        numStockBoards + " @ " + boardLength + "ft";
    document.getElementById("mat-border").textContent = border
        ? borderBoards + " @ " + boardLength + "ft"
        : "None";
    document.getElementById("mat-stairs").textContent =
        stairTreads > 0 ? stairTreads + " treads" : "None";
    document.getElementById("mat-screws").textContent =
        screwBoxes + " box" + (screwBoxes !== 1 ? "es" : "");
    document.getElementById("mat-total").textContent =
        "$" + total.toFixed(2);

    state.estimates = {
        numStockBoards,
        borderBoards,
        stairTreads,
        screwBoxes,
        plugBoxes,
        total
    };

    recalcOrderTotal();
}

// Camera presets
function setView(view) {
    const { length, width, height } = state;
    const maxDim = Math.max(length, width) * 1.2;

    if (view === "top") {
        camera.position.set(0, maxDim * 1.5, 0.01);
    } else if (view === "front") {
        camera.position.set(0, height + 5, maxDim);
    } else if (view === "side") {
        camera.position.set(maxDim, height + 5, 0);
    } else {
        camera.position.set(maxDim * 0.8, maxDim * 0.6, maxDim * 0.8);
    }

    controls.target.set(0, height / 2, 0);
    camera.lookAt(0, height / 2, 0);
}

// UI init
function initUI() {
    const colorGrid = document.getElementById("color-grid");
    COLORS.forEach(colorName => {
        const card = document.createElement("div");
        card.className =
            "color-card" + (colorName === state.color ? " selected" : "");
        card.dataset.color = colorName;

        const img = document.createElement("img");
        img.src = "colors/" + COLOR_IMAGES[colorName];
        img.alt = colorName;
        img.onerror = () => {
            img.style.background =
                "#" +
                COLOR_HEX_FALLBACK[colorName]
                    .toString(16)
                    .padStart(6, "0");
        };

        const label = document.createElement("div");
        label.className = "color-card-label";
        label.textContent = colorName;

        card.appendChild(img);
        card.appendChild(label);

        card.onclick = () => {
            document
                .querySelectorAll(".color-card")
                .forEach(c => c.classList.remove("selected"));
            card.classList.add("selected");
            state.color = colorName;
            updateColorPreviews();
            loadColorTexture(colorName)
                .then(buildDeck)
                .catch(buildDeck);
        };

        card.ondblclick = () => {
            showColorModal(colorName);
        };

        colorGrid.appendChild(card);
    });

    updateColorPreviews();

    document.getElementById("deck-length").oninput = e => {
        state.length = parseFloat(e.target.value) || 6;
        buildDeck();
    };
    document.getElementById("deck-width").oninput = e => {
        state.width = parseFloat(e.target.value) || 6;
        buildDeck();
    };
    document.getElementById("deck-height").oninput = e => {
        state.height = parseFloat(e.target.value) || 1;
        buildDeck();
    };

    document.getElementById("board-length").onchange = e => {
        state.boardLength = parseInt(e.target.value);
        updateEstimates();
    };

    document.getElementById("stair-width").oninput = e => {
        state.stairWidth = parseFloat(e.target.value) || 3;
        buildDeck();
    };

    document.querySelectorAll(".stair-btn").forEach(btn => {
        btn.onclick = () => {
            const side = btn.dataset.side;
            state.stairs[side] = !state.stairs[side];
            btn.classList.toggle("active", state.stairs[side]);
            buildDeck();
        };
    });

    document.getElementById("add-railing").onchange = e => {
        state.railing = e.target.checked;
        buildDeck();
    };
    document.getElementById("add-border").onchange = e => {
        state.border = e.target.checked;
        buildDeck();
    };
    document.getElementById("add-plugs").onchange = e => {
        state.includePlugs = e.target.checked;
        updateEstimates();
    };

    document.querySelectorAll(".view-btn").forEach(btn => {
        btn.onclick = () => {
            document
                .querySelectorAll(".view-btn")
                .forEach(b => b.classList.remove("active"));
            btn.classList.add("active");
            setView(btn.dataset.view);
        };
    });

    document.getElementById("apply-order").onclick = applyDesignToOrder;
    document.getElementById("reset-builder").onclick = resetBuilder;

    document.getElementById("btn-add-row").onclick = () => {
        addManualLine();
    };

    document.getElementById("btn-reset-form").onclick = () => {
        if (!confirm("Clear entire form and all line items?")) return;
        orderLines = [];
        renderOrderTable();
        document.getElementById("cust-name").value = "";
        document.getElementById("cust-company").value = "";
        document.getElementById("cust-phone").value = "";
        document.getElementById("cust-email").value = "";
        document.getElementById("cust-address").value = "";
        document.getElementById("special-notes").value = "";
        recalcOrderTotal();
    };

    document.getElementById("btn-submit").onclick = submitOrder;
    document.getElementById("btn-pdf").onclick = generatePDF;

    document.getElementById("modal-close").onclick = () => {
        document.getElementById("colorModal").classList.remove("active");
    };
    document.getElementById("colorModal").onclick = e => {
        if (e.target.id === "colorModal") {
            document.getElementById("colorModal").classList.remove("active");
        }
    };
}

function updateColorPreviews() {
    const idx = COLORS.indexOf(state.color);
    const compare = COLORS[(idx + 1) % COLORS.length];
    document.getElementById("preview-color-1").src =
        "colors/" + COLOR_IMAGES[state.color];
    document.getElementById("preview-name-1").textContent = state.color;
    document.getElementById("preview-color-2").src =
        "colors/" + COLOR_IMAGES[compare];
    document.getElementById("preview-name-2").textContent = compare;
    document.getElementById("viewport-color-img").src =
        "colors/" + COLOR_IMAGES[state.color];
    document.getElementById("viewport-color-name").textContent =
        state.color;
}

function showColorModal(colorName) {
    document.getElementById("modal-color-img").src =
        "colors/" + COLOR_IMAGES[colorName];
    document.getElementById("modal-color-name").textContent = colorName;
    document.getElementById("colorModal").classList.add("active");
}

function resetBuilder() {
    state = {
        length: 16,
        width: 12,
        height: 3,
        color: "Driftwood",
        boardLength: 16,
        stairs: { front: false, back: false, left: false, right: false },
        stairWidth: 4,
        railing: false,
        border: false,
        includePlugs: false,
        estimates: state.estimates
    };
    document.getElementById("deck-length").value = 16;
    document.getElementById("deck-width").value = 12;
    document.getElementById("deck-height").value = 3;
    document.getElementById("board-length").value = 16;
    document.getElementById("stair-width").value = 4;
    document.getElementById("add-railing").checked = false;
    document.getElementById("add-border").checked = false;
    document.getElementById("add-plugs").checked = false;
    document
        .querySelectorAll(".stair-btn")
        .forEach(b => b.classList.remove("active"));
    document
        .querySelectorAll(".color-card")
        .forEach(c => c.classList.toggle("selected", c.dataset.color === "Driftwood"));
    updateColorPreviews();
    buildDeck();
    setView("3d");
}

// ORDER LOGIC

// Add design-derived lines to orderLines (does not remove existing manual lines)
function applyDesignToOrder() {
    const { color, boardLength, estimates, border, includePlugs } = state;

    // Remove previous "auto" lines but keep manual
    orderLines = orderLines.filter(l => !l.autoFromDesign);

    if (estimates.numStockBoards > 0) {
        orderLines.push({
            autoFromDesign: true,
            type: "system",
            product: PRODUCTS.system.name,
            color: color,
            length: boardLength,
            qty: estimates.numStockBoards,
            unitPrice: PRODUCTS.system.price * boardLength
        });
    }
    if (border && estimates.borderBoards > 0) {
        orderLines.push({
            autoFromDesign: true,
            type: "solid",
            product: PRODUCTS.solid.name + " (Border)",
            color: color,
            length: boardLength,
            qty: estimates.borderBoards,
            unitPrice: PRODUCTS.solid.price * boardLength
        });
    }
    if (estimates.stairTreads > 0) {
        orderLines.push({
            autoFromDesign: true,
            type: "solid",
            product: PRODUCTS.solid.name + " (Stairs)",
            color: color,
            length: 4,
            qty: estimates.stairTreads,
            unitPrice: PRODUCTS.solid.price * 4
        });
    }
    if (estimates.screwBoxes > 0) {
        orderLines.push({
            autoFromDesign: true,
            type: "screws",
            product: PRODUCTS.screws.name,
            color: null,
            length: null,
            qty: estimates.screwBoxes,
            unitPrice: PRODUCTS.screws.price
        });
    }
    if (includePlugs && estimates.plugBoxes > 0) {
        orderLines.push({
            autoFromDesign: true,
            type: "plugs",
            product: PRODUCTS.plugs.name,
            color: color,
            length: null,
            qty: estimates.plugBoxes,
            unitPrice: PRODUCTS.plugs.price
        });
    }

    renderOrderTable();
    const btn = document.getElementById("apply-order");
    btn.textContent = "Applied!";
    btn.classList.add("btn-success");
    setTimeout(() => {
        btn.textContent = "Apply to Order Form";
        btn.classList.remove("btn-success");
    }, 2000);
}

// Manual line item helper
function makeBlankManualLine() {
    return {
        autoFromDesign: false,
        type: "custom",
        product: "",
        color: "",
        length: "",
        qty: 1,
        unitPrice: 0
    };
}

function addManualLine() {
    orderLines.push(makeBlankManualLine());
    renderOrderTable();
}

function renderOrderTable() {
    const tbody = document.getElementById("order-tbody");
    tbody.innerHTML = "";

    if (orderLines.length === 0) {
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = 7;
        td.style.textAlign = "center";
        td.style.color = "var(--text-muted)";
        td.style.padding = "2rem";
        td.textContent =
            'Design your deck above and click "Apply to Order Form" or add your own line items below.';
        tr.appendChild(td);
        tbody.appendChild(tr);
        recalcOrderTotal();
        return;
    }

    orderLines.forEach((line, index) => {
        const tr = document.createElement("tr");

        // Product
        const tdProd = document.createElement("td");
        tdProd.setAttribute("data-label", "Product");
        const prodInput = document.createElement("input");
        prodInput.className = "line-input";
        prodInput.value = line.product || "";
        prodInput.oninput = e => {
            line.product = e.target.value;
        };
        tdProd.appendChild(prodInput);
        tr.appendChild(tdProd);

        // Color
        const tdColor = document.createElement("td");
        tdColor.setAttribute("data-label", "Color");
        const colorSelect = document.createElement("select");
        colorSelect.className = "line-select";
        const optNone = document.createElement("option");
        optNone.value = "";
        optNone.textContent = "None";
        colorSelect.appendChild(optNone);
        COLORS.forEach(c => {
            const opt = document.createElement("option");
            opt.value = c;
            opt.textContent = c;
            if (c === line.color) opt.selected = true;
            colorSelect.appendChild(opt);
        });
        colorSelect.onchange = e => {
            line.color = e.target.value || "";
        };
        tdColor.appendChild(colorSelect);
        tr.appendChild(tdColor);

        // Length
        const tdLen = document.createElement("td");
        tdLen.setAttribute("data-label", "Length");
        const lenInput = document.createElement("input");
        lenInput.type = "number";
        lenInput.step = "0.1";
        lenInput.min = "0";
        lenInput.className = "line-input";
        lenInput.value = line.length || "";
        lenInput.oninput = e => {
            line.length = e.target.value ? parseFloat(e.target.value) : "";
            recalcOrderTotal();
        };
        tdLen.appendChild(lenInput);
        tr.appendChild(tdLen);

        // Qty
        const tdQty = document.createElement("td");
        tdQty.className = "numeric";
        tdQty.setAttribute("data-label", "Qty");
        const qtyInput = document.createElement("input");
        qtyInput.type = "number";
        qtyInput.min = "1";
        qtyInput.step = "1";
        qtyInput.className = "line-input";
        qtyInput.value = line.qty || 1;
        qtyInput.oninput = e => {
            line.qty = Math.max(
                1,
                e.target.value ? parseInt(e.target.value) : 1
            );
            qtyInput.value = line.qty;
            recalcOrderTotal();
        };
        tdQty.appendChild(qtyInput);
        tr.appendChild(tdQty);

        // Unit price
        const tdPrice = document.createElement("td");
        tdPrice.className = "numeric";
        tdPrice.setAttribute("data-label", "Unit Price");
        const priceInput = document.createElement("input");
        priceInput.type = "number";
        priceInput.step = "0.01";
        priceInput.min = "0";
        priceInput.className = "line-input";
        priceInput.value = line.unitPrice || 0;
        priceInput.oninput = e => {
            line.unitPrice = e.target.value ? parseFloat(e.target.value) : 0;
            recalcOrderTotal();
        };
        tdPrice.appendChild(priceInput);
        tr.appendChild(tdPrice);

        // Subtotal
        const tdSub = document.createElement("td");
        tdSub.className = "numeric";
        tdSub.setAttribute("data-label", "Subtotal");
        tdSub.textContent = "$" + calcLineSubtotal(line).toFixed(2);
        tr.appendChild(tdSub);

        // Actions
        const tdAct = document.createElement("td");
        tdAct.setAttribute("data-label", "Actions");
        const rmBtn = document.createElement("button");
        rmBtn.type = "button";
        rmBtn.className = "btn-remove-row";
        rmBtn.textContent = "";
        rmBtn.onclick = () => {
            orderLines.splice(index, 1);
            renderOrderTable();
        };
        tdAct.appendChild(rmBtn);
        tr.appendChild(tdAct);

        // Keep subtotal updated
        const observer = () => {
            tdSub.textContent = "$" + calcLineSubtotal(line).toFixed(2);
        };
        priceInput.addEventListener("input", observer);
        qtyInput.addEventListener("input", observer);
        lenInput.addEventListener("input", observer);

        tbody.appendChild(tr);
    });

    recalcOrderTotal();
}

function calcLineSubtotal(line) {
    const qty = line.qty || 0;
    const unit = line.unitPrice || 0;
    return qty * unit;
}

function recalcOrderTotal() {
    const total = orderLines.reduce(
        (sum, line) => sum + calcLineSubtotal(line),
        0
    );
    document.getElementById("grand-total").textContent =
        "$" + total.toFixed(2);
}

// Submit via mailto summary
function submitOrder() {
    const name = document.getElementById("cust-name").value || "Customer";
    const email = document.getElementById("cust-email").value || "";
    const phone = document.getElementById("cust-phone").value || "";
    const addr =
        document.getElementById("cust-address").value || "";
    const notes =
        document.getElementById("special-notes").value || "";
    const total = document.getElementById("grand-total").textContent;

    let body = "AmeriDex Order%0A%0A";
    body += "Customer: " + name + "%0A";
    body += "Company: " +
        (document.getElementById("cust-company").value || "") +
        "%0A";
    body += "Phone: " + phone + "%0A";
    body += "Email: " + email + "%0A";
    body += "Address: " + addr.replace(/\n/g, " ") + "%0A%0A";

    body += "Order Lines:%0A";
    orderLines.forEach((line, i) => {
        let lineTxt = (i + 1) + ". " + (line.product || "Item");
        if (line.color) lineTxt += " - " + line.color;
        if (line.length) lineTxt += " - " + line.length + "ft";
        lineTxt += " x " + (line.qty || 0);
        lineTxt += " @ $" + (line.unitPrice || 0).toFixed(2);
        lineTxt +=
            " = $" + calcLineSubtotal(line).toFixed(2);
        body += lineTxt + "%0A";
    });

    body += "%0ATotal: " + total + "%0A%0A";
    if (notes) {
        body += "Special Instructions: " + notes.replace(/\n/g, " ") + "%0A";
    }

    const subject = "AmeriDex Order - " + name;
    window.location.href =
        "mailto:sales@ameridex.com?subject=" +
        encodeURIComponent(subject) +
        "&body=" +
        body;
}

// Simple PDF summary
function generatePDF() {
    if (!window.jspdf) {
        alert("PDF generation requires jsPDF to be loaded.");
        return;
    }
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    doc.setFontSize(18);
    doc.text("AmeriDex Order", 105, 20, { align: "center" });

    let y = 35;
    doc.setFontSize(12);
    doc.text(
        "Customer: " +
            (document.getElementById("cust-name").value || "N/A"),
        20,
        y
    );
    y += 8;
    doc.text(
        "Email: " +
            (document.getElementById("cust-email").value || "N/A"),
        20,
        y
    );
    y += 8;
    doc.text(
        "Phone: " +
            (document.getElementById("cust-phone").value || "N/A"),
        20,
        y
    );
    y += 8;
    doc.text(
        "Address: " +
            (document.getElementById("cust-address").value || "")
                .replace(/\n/g, " "),
        20,
        y
    );
    y += 15;

    doc.setFontSize(14);
    doc.text("Order Lines:", 20, y);
    y += 10;

    doc.setFontSize(10);
    orderLines.forEach((line, i) => {
        let lineTxt = (i + 1) + ". " + (line.product || "Item");
        if (line.color) lineTxt += " - " + line.color;
        if (line.length) lineTxt += " - " + line.length + "ft";
        lineTxt += " x " + (line.qty || 0);
        lineTxt +=
            " @ $" + (line.unitPrice || 0).toFixed(2);
        lineTxt +=
            " = $" + calcLineSubtotal(line).toFixed(2);
        doc.text(lineTxt, 20, y);
        y += 7;
        if (y > 270) {
            doc.addPage();
            y = 20;
        }
    });

    y += 10;
    doc.setFontSize(14);
    doc.text(
        "Total: " + document.getElementById("grand-total").textContent,
        20,
        y
    );

    doc.save("ameridex-order.pdf");
}

// Init
initScene();
initUI();
</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</body>
</html>
