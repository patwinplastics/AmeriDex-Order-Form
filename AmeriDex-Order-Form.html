<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>AmeriDex Order Form Pro</title>
<style>
    :root {
        --bg-page: #f5f7fa;
        --bg-card: #ffffff;
        --primary: #2563eb;
        --primary-dark: #1d4ed8;
        --primary-soft: #eff6ff;
        --border-subtle: #e5e7eb;
        --text-main: #111827;
        --text-muted: #6b7280;
        --danger: #dc2626;
        --success: #16a34a;
        --warning: #f59e0b;
        --shadow-soft: 0 10px 25px rgba(15, 23, 42, 0.08);
        --radius-card: 14px;
        --radius-field: 8px;
        --safe-area-inset-bottom: env(safe-area-inset-bottom, 0);
    }

    * { box-sizing: border-box; }

    html, body {
        margin: 0;
        padding: 0;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        background-color: var(--bg-page);
        color: var(--text-main);
        line-height: 1.5;
    }

    body {
        -webkit-font-smoothing: antialiased;
        -webkit-tap-highlight-color: transparent;
    }

    .page-shell {
        max-width: 1120px;
        margin: 0 auto;
        padding: 0.75rem 0.75rem 3rem;
    }

    header.app-header {
        background: linear-gradient(135deg, #2563eb, #1e40af);
        color: #fff;
        padding: 1.5rem 1rem 1.75rem;
        border-radius: 0 0 var(--radius-card) var(--radius-card);
        box-shadow: var(--shadow-soft);
        text-align: center;
        position: sticky;
        top: 0;
        z-index: 5;
    }

    header.app-header img {
        max-width: 160px;
        height: auto;
        display: block;
        margin: 0 auto 0.5rem;
    }

    header.app-header h1 {
        margin: 0.15rem 0 0.3rem;
        font-size: 1.4rem;
        letter-spacing: 0.03em;
    }

    header.app-header p.header-sub {
        margin: 0.1rem 0 0;
        font-size: 0.75rem;
        color: rgba(249, 250, 251, 0.9);
        line-height: 1.3;
    }

    main { margin-top: 0.75rem; }

    .card {
        background: var(--bg-card);
        border-radius: var(--radius-card);
        padding: 1.25rem;
        margin-bottom: 0.9rem;
        box-shadow: 0 1px 3px rgba(15, 23, 42, 0.05);
        border: 1px solid rgba(148, 163, 184, 0.18);
    }

    .card-header {
        margin-bottom: 0.75rem;
        border-bottom: 1px solid rgba(229, 231, 235, 0.9);
        padding-bottom: 0.5rem;
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 0.5rem;
    }

    .card-title {
        margin: 0;
        font-size: 1rem;
        font-weight: 700;
        letter-spacing: 0.01em;
    }

    .card-subtitle {
        margin: 0.15rem 0 0;
        font-size: 0.75rem;
        color: var(--text-muted);
        line-height: 1.3;
    }

    .progress-badge {
        display: inline-block;
        background: var(--success);
        color: white;
        padding: 0.25rem 0.6rem;
        border-radius: 999px;
        font-size: 0.65rem;
        font-weight: 600;
        white-space: nowrap;
        flex-shrink: 0;
    }

    .progress-badge.incomplete {
        background: var(--warning);
    }

    .form-grid {
        display: grid;
        grid-template-columns: minmax(0, 1fr);
        gap: 0.7rem;
    }

    .field {
        display: flex;
        flex-direction: column;
        gap: 0.2rem;
    }

    .field-row-2 {
        display: grid;
        grid-template-columns: minmax(0, 1fr);
        gap: 0.7rem;
    }

    @media (min-width: 768px) {
        .field-row-2 {
            grid-template-columns: minmax(0, 1fr) minmax(0, 1fr);
        }
    }

    label {
        font-size: 0.85rem;
        font-weight: 600;
        color: #374151;
    }

    .required-indicator {
        color: var(--danger);
        margin-left: 0.1rem;
    }

    .help-text {
        font-size: 0.7rem;
        color: var(--text-muted);
        margin-top: 0.15rem;
        line-height: 1.3;
    }

    input[type="text"],
    input[type="email"],
    input[type="tel"],
    input[type="number"],
    input[type="date"],
    textarea,
    select {
        width: 100%;
        padding: 0.75rem 0.6rem;
        border-radius: var(--radius-field);
        border: 1px solid var(--border-subtle);
        font-size: 1rem;
        color: var(--text-main);
        background-color: #ffffff;
        transition: border-color 0.12s ease, box-shadow 0.12s ease, background-color 0.12s ease;
        appearance: none;
        -webkit-appearance: none;
    }

    select {
        padding-right: 2.5rem;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23111827' stroke-width='2'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 0.6rem center;
        background-size: 1.2rem;
    }

    input:focus,
    textarea:focus,
    select:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.15);
        background-color: #f9fafb;
    }

    textarea {
        min-height: 80px;
        resize: vertical;
        font-family: inherit;
    }

    .error {
        font-size: 0.7rem;
        color: var(--danger);
        margin-top: 0.1rem;
    }

    .hint {
        font-size: 0.75rem;
        color: var(--text-muted);
        margin-top: 0.1rem;
        line-height: 1.4;
    }

    .inline-checks {
        display: flex;
        flex-direction: column;
        gap: 0.4rem;
        margin-bottom: 0.6rem;
    }

    .check-row {
        display: flex;
        align-items: flex-start;
        gap: 0.5rem;
        padding: 0.4rem 0;
    }

    .check-row input[type="checkbox"] {
        width: 18px;
        height: 18px;
        margin-top: 0.15rem;
        cursor: pointer;
        flex-shrink: 0;
    }

    .check-row label {
        margin: 0;
        font-size: 0.9rem;
        font-weight: 500;
        cursor: pointer;
        flex: 1;
    }

    .note-inline {
        margin-left: 2rem;
        font-size: 0.75rem;
        color: #b45309;
        line-height: 1.3;
    }

    /* Mobile Color Grid */
    .color-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
        gap: 0.6rem;
        margin-top: 0.75rem;
        margin-bottom: 0.75rem;
    }

    @media (min-width: 768px) {
        .color-grid {
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 1rem;
        }
    }

    .color-card {
        border: 2px solid transparent;
        border-radius: 8px;
        overflow: hidden;
        cursor: pointer;
        transition: all 0.2s ease;
        position: relative;
    }

    .color-card:active {
        transform: scale(0.95);
    }

    .color-card:hover {
        border-color: var(--primary);
        transform: translateY(-2px);
    }

    .color-card.selected {
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2);
    }

    .color-card img {
        width: 100%;
        height: 60px;
        object-fit: cover;
        border-radius: 6px;
        display: block;
    }

    .color-card-label {
        text-align: center;
        font-size: 0.7rem;
        font-weight: 600;
        margin-top: 0.3rem;
        color: var(--text-main);
    }

    /* Mobile Comparison Panel */
    .comparison-panel {
        display: grid;
        grid-template-columns: 1fr;
        gap: 1rem;
        margin-top: 1rem;
        padding: 0.75rem;
        background: #f9fafb;
        border-radius: 10px;
    }

    @media (min-width: 768px) {
        .comparison-panel {
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            padding: 1rem;
        }
    }

    .color-preview {
        text-align: center;
    }

    .color-preview h4 {
        margin: 0 0 0.5rem 0;
        font-size: 0.85rem;
        font-weight: 600;
    }

    .color-preview img {
        width: 100%;
        max-width: 150px;
        border-radius: 8px;
        border: 1px solid var(--border-subtle);
    }

    /* Mobile Line Items Card Layout */
    .line-item-card {
        background: white;
        border: 1px solid var(--border-subtle);
        border-radius: 10px;
        padding: 0.9rem;
        margin-bottom: 0.8rem;
        display: none;
    }

    .line-item-card.mobile-visible {
        display: block;
    }

    .line-item-card h4 {
        margin: 0 0 0.75rem 0;
        font-size: 0.9rem;
        font-weight: 600;
        color: var(--primary);
        padding-bottom: 0.5rem;
        border-bottom: 1px solid var(--border-subtle);
    }

    .line-item-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 0.6rem;
        margin-bottom: 0.6rem;
    }

    .line-item-row.full {
        grid-template-columns: 1fr;
    }

    .line-item-row > div {
        display: flex;
        flex-direction: column;
    }

    .line-item-row label {
        font-size: 0.8rem;
        margin-bottom: 0.3rem;
    }

    .line-item-subtotal {
        background: #f9fafb;
        padding: 0.6rem;
        border-radius: 6px;
        font-weight: 600;
        font-size: 0.9rem;
        color: var(--primary-dark);
        text-align: right;
    }

    .line-item-card-actions {
        display: flex;
        gap: 0.4rem;
        margin-top: 0.75rem;
        padding-top: 0.75rem;
        border-top: 1px solid var(--border-subtle);
    }

    .line-item-card-actions button {
        flex: 1;
    }

    @media (max-width: 768px) {
        #line-items {
            display: none;
        }
    }

    @media (min-width: 769px) {
        .line-item-card {
            display: none !important;
        }
        #mobile-items-container {
            display: none !important;
        }
    }

    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 0.75rem;
        font-size: 0.85rem;
    }

    thead { background-color: #f9fafb; }

    th,
    td {
        border: 1px solid var(--border-subtle);
        padding: 0.5rem;
        vertical-align: middle;
    }

    th {
        font-weight: 600;
        color: #4b5563;
        text-align: left;
        font-size: 0.8rem;
    }

    th.numeric,
    td.numeric {
        text-align: right;
    }

    td input,
    td select {
        font-size: 0.8rem;
        padding: 0.35rem 0.4rem;
        border-radius: 6px;
    }

    td .qty-input { max-width: 60px; }
    td .len-input { max-width: 80px; }
    td .price-input { max-width: 120px; }

    .preview-img {
        width: 30px;
        height: 30px;
        object-fit: cover;
        border-radius: 6px;
        cursor: pointer;
        margin-left: 0.4rem;
        border: 1px solid #e5e7eb;
        background-color: #f9fafb;
    }

    .table-actions-cell {
        text-align: center;
        width: 35px;
    }

    .btn-remove-row {
        background-color: #fee2e2;
        color: #b91c1c;
        border-radius: 999px;
        border: none;
        padding: 0.25rem 0.6rem;
        font-size: 1rem;
        cursor: pointer;
        transition: all 0.12s ease;
        min-height: 32px;
    }

    .btn-remove-row:active { background-color: #fca5a5; }
    .btn-remove-row:hover { background-color: #fecaca; }

    .btn-undo {
        background-color: #fef3c7;
        color: #92400e;
        border-radius: 999px;
        border: none;
        padding: 0.4rem 0.9rem;
        font-size: 0.8rem;
        cursor: pointer;
        margin-top: 0.5rem;
        font-weight: 600;
        width: 100%;
        transition: all 0.12s ease;
        min-height: 40px;
    }

    .btn-undo:active { background-color: #fcd34d; }
    .btn-undo:hover { background-color: #fed7aa; }

    .btn-add-row {
        margin-top: 0.75rem;
        font-size: 0.85rem;
        padding-inline: 0.8rem;
        width: 100%;
        min-height: 40px;
    }

    /* Sticky Price Bar - Mobile Bottom */
    .sticky-price-bar {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: linear-gradient(180deg, rgba(255,255,255,0) 0%, #ffffff 20%);
        padding: 0.5rem 0.75rem var(--safe-area-inset-bottom);
        border-top: 2px solid var(--border-subtle);
        z-index: 10;
        display: none;
    }

    .sticky-price-bar.mobile-visible {
        display: block;
    }

    .sticky-price-content {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: white;
        padding: 0.5rem 0.75rem;
        border-radius: 8px;
        box-shadow: 0 -2px 8px rgba(0,0,0,0.1);
    }

    .sticky-label {
        font-size: 0.8rem;
        color: var(--text-muted);
        font-weight: 600;
    }

    .sticky-value {
        font-size: 1.1rem;
        font-weight: 700;
        color: var(--primary-dark);
    }

    .total-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem 0.9rem;
        border-radius: var(--radius-card);
        background: #f9fafb;
        border: 1px solid var(--border-subtle);
        gap: 1rem;
    }

    .total-label {
        font-size: 0.85rem;
        color: #4b5563;
        font-weight: 600;
    }

    .total-value {
        font-size: 1.15rem;
        font-weight: 700;
        color: #1e40af;
    }

    .fastener-block {
        margin-top: 0.75rem;
        padding: 0.6rem;
        background-color: var(--primary-soft);
        border-radius: 10px;
        border: 1px dashed #bfdbfe;
        font-size: 0.8rem;
        color: #1d4ed8;
        line-height: 1.4;
    }

    .fastener-warning {
        color: #b91c1c;
        font-size: 0.75rem;
        margin-top: 0.35rem;
        line-height: 1.3;
    }

    .actions-row {
        display: flex;
        flex-direction: column;
        gap: 0.6rem;
        margin-bottom: 2.5rem;
    }

    @media (min-width: 768px) {
        .actions-row {
            flex-direction: row;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 0;
        }
    }

    .btn {
        border-radius: 8px;
        padding: 0.75rem 1.2rem;
        font-size: 0.9rem;
        font-weight: 600;
        cursor: pointer;
        border: 1px solid transparent;
        transition: all 0.12s ease;
        min-height: 44px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    @media (max-width: 768px) {
        .btn {
            width: 100%;
            min-height: 48px;
            font-size: 0.95rem;
        }
    }

    .btn-primary {
        background-color: var(--primary);
        color: #ffffff;
        box-shadow: 0 4px 12px rgba(37, 99, 235, 0.2);
    }

    .btn-primary:active { background-color: #1e40af; }
    .btn-primary:hover { background-color: var(--primary-dark); }

    .btn-outline {
        background-color: #ffffff;
        color: var(--primary);
        border-color: var(--primary);
    }

    .btn-outline:active { background-color: #f0f7ff; }
    .btn-outline:hover { background-color: #eff6ff; }

    .btn-ghost {
        background-color: transparent;
        color: #374151;
        border-color: #d1d5db;
    }

    .btn-ghost:active { background-color: #f3f4f6; }
    .btn-ghost:hover { background-color: #f9fafb; }

    .btn-sm {
        padding: 0.35rem 0.65rem;
        font-size: 0.75rem;
        min-height: auto;
    }

    .success-banner {
        margin-top: 0.6rem;
        padding: 0.5rem 0.75rem;
        border-radius: 10px;
        background-color: #ecfdf3;
        color: #166534;
        font-size: 0.8rem;
        border: 1px solid #bbf7d0;
        line-height: 1.4;
    }

    .modal {
        display: none;
        position: fixed;
        inset: 0;
        background-color: rgba(15, 23, 42, 0.55);
        z-index: 50;
        justify-content: center;
        align-items: center;
        padding: 0.75rem;
        overflow-y: auto;
        padding-bottom: var(--safe-area-inset-bottom);
    }

    .modal.active {
        display: flex;
    }

    .modal-content {
        background: #ffffff;
        padding: 1rem;
        border-radius: 12px;
        max-width: 95%;
        max-height: 90vh;
        position: relative;
        box-shadow: var(--shadow-soft);
        overflow-y: auto;
        text-align: center;
    }

    .modal-content img {
        max-width: 100%;
        max-height: 60vh;
        border-radius: 10px;
    }

    .modal-close {
        position: absolute;
        top: 8px;
        right: 8px;
        font-size: 1.5rem;
        cursor: pointer;
        color: #6b7280;
        background: none;
        border: none;
        padding: 0.4rem;
        width: 36px;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.12s ease;
    }

    .modal-close:active { color: #374151; }
    .modal-close:hover { color: #111827; }

    .review-modal-content {
        text-align: left;
        max-width: 600px;
    }

    .review-section {
        margin-bottom: 1rem;
        padding-bottom: 0.75rem;
        border-bottom: 1px solid var(--border-subtle);
    }

    .review-section h3 {
        margin: 0 0 0.6rem 0;
        font-size: 0.95rem;
        color: var(--primary);
    }

    .review-item {
        display: flex;
        justify-content: space-between;
        margin-bottom: 0.4rem;
        font-size: 0.85rem;
        gap: 0.5rem;
    }

    .review-item-label {
        color: var(--text-muted);
        font-weight: 600;
        flex-shrink: 0;
    }

    .review-total {
        font-size: 1.1rem;
        font-weight: 700;
        color: var(--primary-dark);
        margin-top: 0.75rem;
        padding-top: 0.75rem;
        border-top: 2px solid var(--primary);
    }

    footer.app-footer {
        text-align: center;
        padding: 1rem 0.75rem 0.5rem;
        font-size: 0.8rem;
        color: var(--text-muted);
    }

    footer.app-footer a {
        color: var(--primary);
        text-decoration: none;
    }

    footer.app-footer a:hover { text-decoration: underline; }

    @media (min-width: 769px) {
        .page-shell { padding: 1.5rem 1.25rem 2.5rem; }
        header.app-header { padding: 2.4rem 1.75rem 2.6rem; }
        header.app-header img { max-width: 220px; margin: 0 auto 0.75rem; }
        header.app-header h1 { font-size: 1.9rem; }
        header.app-header p.header-sub { font-size: 0.88rem; }
        .card { padding: 1.75rem; margin-bottom: 1.25rem; }
        .btn { width: auto; min-height: 40px; }
        .actions-row { flex-direction: row; justify-content: center; }
        .sticky-price-bar { display: none !important; }

        #line-items th:nth-child(1),
        #line-items td:nth-child(1) { width: 30%; }
        #line-items th:nth-child(2),
        #line-items td:nth-child(2) { width: 16%; }
        #line-items th:nth-child(3),
        #line-items td:nth-child(3) { width: 12%; }
        #line-items th:nth-child(4),
        #line-items td:nth-child(4) { width: 10%; }
        #line-items th:nth-child(5),
        #line-items td:nth-child(5) { width: 18%; }
        #line-items th:nth-child(6),
        #line-items td:nth-child(6) { width: 10%; }
        #line-items th:nth-child(7),
        #line-items td:nth-child(7) { width: 4%; }
    }
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>

<div class="page-shell">
    <header class="app-header">
        <img src="colors/AmeriDex.png" alt="AmeriDex Logo">
        <h1>AmeriDex Order Form Pro</h1>
        <p class="header-sub">
            AmeriDex System Boards include integrated Dexerdry. Standalone Dexerdry for non-system applications.
        </p>
    </header>

    <main>
        <form id="order-form">

            <!-- Deck Calculator (MOVED TO TOP, DEFAULT VISIBLE) -->
            <section class="card" id="calculator">
                <div class="card-header">
                    <div>
                        <h2 class="card-title">Deck Calculator</h2>
                        <p class="card-subtitle">Let us suggest the right boards for your deck size.</p>
                    </div>
                </div>

                <div class="form-grid">
                    <div class="field-row-2">
                        <div class="field">
                            <label for="deck-len">Deck Length (ft)<span class="required-indicator">*</span></label>
                            <input type="number" id="deck-len" step="0.1" min="0" inputmode="decimal">
                            <div class="help-text">Total length of your deck</div>
                        </div>
                        <div class="field">
                            <label for="deck-wid">Deck Width (ft)<span class="required-indicator">*</span></label>
                            <input type="number" id="deck-wid" step="0.1" min="0" inputmode="decimal">
                            <div class="help-text">Total width of your deck</div>
                        </div>
                    </div>

                    <div class="field-row-2">
                        <div class="field">
                            <label for="orientation">Board Orientation</label>
                            <select id="orientation">
                                <option value="parallel">Parallel to Length</option>
                                <option value="perpendicular" selected>Perpendicular to Length</option>
                            </select>
                            <div class="help-text">Direction boards run across deck</div>
                        </div>
                        <div class="field" style="align-self:flex-end;">
                            <button type="button" class="btn btn-outline" id="calc-btn">Calculate & Suggest</button>
                        </div>
                    </div>

                    <div id="calc-result" class="hint" style="margin-top:0.65rem;"></div>
                </div>
            </section>

            <!-- Color Selection Panel -->
            <section class="card" id="colors">
                <div class="card-header">
                    <div>
                        <h2 class="card-title">Select Colors</h2>
                        <p class="card-subtitle">Tap to preview and compare.</p>
                    </div>
                </div>

                <div class="color-grid" id="color-grid"></div>

                <div class="comparison-panel">
                    <div class="color-preview">
                        <h4>Color 1</h4>
                        <img id="color1-preview" src="colors/Driftwood.png" alt="Color 1">
                        <div id="color1-name" style="margin-top: 0.35rem; font-weight: 600; font-size: 0.85rem;">Driftwood</div>
                    </div>
                    <div class="color-preview">
                        <h4>Color 2 (Compare)</h4>
                        <img id="color2-preview" src="colors/Khaki.png" alt="Color 2">
                        <div id="color2-name" style="margin-top: 0.35rem; font-weight: 600; font-size: 0.85rem;">Khaki</div>
                    </div>
                </div>
            </section>

            <!-- Customer -->
            <section class="card" id="customer">
                <div class="card-header">
                    <div>
                        <h2 class="card-title">Customer Information</h2>
                        <p class="card-subtitle">Who we're shipping to and contact details.</p>
                    </div>
                    <span class="progress-badge incomplete" id="cust-badge">0/4</span>
                </div>

                <div class="form-grid">
                    <div class="field-row-2">
                        <div class="field">
                            <label for="cust-name">Name<span class="required-indicator">*</span></label>
                            <input type="text" id="cust-name" required>
                            <div class="error" id="err-name"></div>
                        </div>
                        <div class="field">
                            <label for="cust-company">Company</label>
                            <input type="text" id="cust-company">
                            <div class="error" id="err-company"></div>
                        </div>
                    </div>

                    <div class="field">
                        <label for="cust-address">Address<span class="required-indicator">*</span></label>
                        <textarea id="cust-address" rows="3" required></textarea>
                        <div class="error" id="err-address"></div>
                    </div>

                    <div class="field-row-2">
                        <div class="field">
                            <label for="cust-phone">Phone<span class="required-indicator">*</span></label>
                            <input type="tel" id="cust-phone" required inputmode="tel">
                            <div class="error" id="err-phone"></div>
                        </div>
                        <div class="field">
                            <label for="cust-email">Email<span class="required-indicator">*</span></label>
                            <input type="email" id="cust-email" required inputmode="email">
                            <div class="error" id="err-email"></div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Order -->
            <section class="card" id="order">
                <div class="card-header">
                    <div>
                        <h2 class="card-title">Order Details</h2>
                        <p class="card-subtitle">Products and special requirements.</p>
                    </div>
                </div>

                <div class="inline-checks">
                    <div class="check-row">
                        <input type="checkbox" id="pic-frame">
                        <label for="pic-frame">Picture Framing</label>
                    </div>
                    <div id="pic-frame-note" class="note-inline" style="display:none;">Add Solid Edge boards to frame the deck perimeter.</div>

                    <div class="check-row" style="margin-top:0.2rem;">
                        <input type="checkbox" id="stairs">
                        <label for="stairs">Stairs</label>
                    </div>
                    <div id="stairs-note" class="note-inline" style="display:none;">Add Solid Edge boards for stair treads and risers.</div>
                </div>

                <div id="fastener-hint" class="fastener-block" style="display:none;"></div>

                <!-- Desktop Table View -->
                <div id="desktop-table-container">
                    <table id="line-items">
                        <thead>
                        <tr>
                            <th>Product</th>
                            <th>Color</th>
                            <th>Length (ft)</th>
                            <th class="numeric">Qty</th>
                            <th class="numeric">Unit Price</th>
                            <th class="numeric">Subtotal</th>
                            <th class="table-actions-cell"></th>
                        </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>

                <!-- Mobile Card View -->
                <div id="mobile-items-container"></div>

                <button type="button" class="btn btn-outline btn-add-row" id="add-row">+ Add Line Item</button>

                <!-- Undo Button -->
                <button type="button" class="btn-undo" id="undo-btn" style="display:none;">â†¶ Undo Last Deletion</button>

                <div style="margin-top:1rem;" class="form-grid">
                    <div class="field">
                        <label for="special-instr">Special Instructions / Notes for Production</label>
                        <textarea id="special-instr" rows="3"></textarea>
                    </div>
                    <div class="field">
                        <label for="internal-notes">Internal Sales Rep Notes</label>
                        <textarea id="internal-notes" rows="2"></textarea>
                    </div>
                </div>
            </section>

            <!-- Shipping -->
            <section class="card">
                <div class="card-header">
                    <div>
                        <h2 class="card-title">Shipping & Delivery</h2>
                        <p class="card-subtitle">Only if different from customer information.</p>
                    </div>
                </div>

                <div class="form-grid">
                    <div class="field">
                        <label for="ship-addr">Shipping Address (if different)</label>
                        <textarea id="ship-addr" rows="3"></textarea>
                    </div>
                    <div class="field">
                        <label for="del-date">Preferred Delivery Date</label>
                        <input type="date" id="del-date">
                    </div>
                </div>
            </section>

            <!-- Total -->
            <section class="card">
                <div class="total-bar">
                    <span class="total-label">Estimated Total</span>
                    <span class="total-value" id="grand-total">$0.00</span>
                </div>
            </section>

            <!-- Actions -->
            <section class="card" style="text-align:center;">
                <div class="actions-row">
                    <button type="button" class="btn btn-ghost" id="reset">Reset Form</button>
                    <button type="button" class="btn btn-outline" id="pdf">Export PDF</button>
                    <button type="button" class="btn btn-primary" id="review-btn">Review Order</button>
                </div>
                <div id="success-msg" class="success-banner" style="display:none;">
                    Order email prepared. Remember to attach any files in your email client before sending.
                </div>
            </section>
        </form>
    </main>

    <!-- Sticky Price Bar (Mobile) -->
    <div class="sticky-price-bar mobile-visible" id="sticky-price">
        <div class="sticky-price-content">
            <span class="sticky-label">Order Total</span>
            <span class="sticky-value" id="sticky-total">$0.00</span>
        </div>
    </div>

    <!-- Color Preview Modal -->
    <div id="colorModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="colorName">
        <div class="modal-content">
            <button type="button" class="modal-close" id="modal-close" aria-label="Close">&times;</button>
            <img id="colorLarge" src="" alt="Color Preview">
            <div id="colorName" style="margin-top:0.75rem;font-weight:600;"></div>
        </div>
    </div>

    <!-- Order Review Modal -->
    <div id="reviewModal" class="modal" role="dialog" aria-modal="true">
        <div class="modal-content review-modal-content">
            <button type="button" class="modal-close" id="review-close" aria-label="Close">&times;</button>
            <h2 style="margin-top: 0; color: var(--primary); font-size: 1.1rem;">Review Your Order</h2>
            
            <div class="review-section">
                <h3>Customer Details</h3>
                <div class="review-item">
                    <span class="review-item-label">Name:</span>
                    <span id="review-name"></span>
                </div>
                <div class="review-item">
                    <span class="review-item-label">Email:</span>
                    <span id="review-email"></span>
                </div>
                <div class="review-item">
                    <span class="review-item-label">Phone:</span>
                    <span id="review-phone"></span>
                </div>
            </div>

            <div class="review-section">
                <h3>Line Items</h3>
                <div id="review-items"></div>
            </div>

            <div class="review-section">
                <div class="review-total">
                    Estimated Total: <span id="review-total">$0.00</span>
                </div>
            </div>

            <div style="display: flex; flex-direction: column; gap: 0.5rem; margin-top: 1rem;">
                <button type="button" class="btn btn-primary" id="review-submit">Proceed to Email</button>
                <button type="button" class="btn btn-ghost" id="review-back">Back to Edit</button>
            </div>
        </div>
    </div>

    <footer class="app-footer">
        <a href="http://www.ameridex.com" target="_blank">www.ameridex.com</a>
    </footer>
</div>

<script>
// Product Configuration (refactored for maintainability)
const PRODUCT_CONFIG = {
    categories: {
        decking: {
            label: "Decking Boards",
            products: {
                system: {
                    name: "AmeriDex System Boards (Grooved + Dexerdry included)",
                    price: 8.00,
                    isFt: true,
                    hasColor: true,
                    help: "Our premium option includes both grooved boards and integrated Dexerdry sealing. Best for complete system deck projects."
                },
                grooved: {
                    name: "Grooved Deck Boards (no Dexerdry)",
                    price: 6.00,
                    isFt: true,
                    hasColor: true,
                    help: "Grooved boards without integrated sealing. Add standalone Dexerdry if needed."
                },
                solid: {
                    name: "Solid Edge Deck Boards",
                    price: 6.00,
                    isFt: true,
                    hasColor: true,
                    help: "Use for picture framing around deck perimeter or stair construction."
                }
            }
        },
        sealing: {
            label: "Sealing & Protection",
            products: {
                dexerdry: {
                    name: "Dexerdry Seals (standalone - for non-system decks)",
                    price: 2.00,
                    isFt: true,
                    hasColor: false,
                    help: "Standalone sealing product for use with non-system deck boards."
                }
            }
        },
        fasteners: {
            label: "Fasteners & Hardware",
            products: {
                screws: {
                    name: "Epoxy-Coated Screws",
                    price: 37,
                    isFt: false,
                    hasColor: false,
                    help: "Per box (375 screws). Typically 2 screws per board-joist intersection."
                },
                plugs: {
                    name: "Color-Matching Plugs",
                    price: 33.79,
                    isFt: false,
                    hasColor: false,
                    help: "Per box. Matches installed screw heads with color-matched wooden plugs."
                }
            }
        },
        custom: {
            label: "Custom Items",
            products: {
                custom: {
                    name: "Custom / Manual Item",
                    price: 0,
                    isFt: false,
                    hasColor: false,
                    help: "Add any custom product or service with your own description and price."
                }
            }
        }
    }
};

// Flatten for easy access
const PRODUCTS = {};
Object.values(PRODUCT_CONFIG.categories).forEach(cat => {
    Object.assign(PRODUCTS, cat.products);
});

const COLORS = ["Driftwood", "Khaki", "Slate", "Beachwood", "Chestnut", "Redwood", "Hazelnut"];

const COLOR_IMAGES = {
    Driftwood: "Driftwood.png",
    Khaki: "Khaki.png",
    Slate: "Slate.png",
    Beachwood: "Beachwood.png",
    Chestnut: "Chestnut.png",
    Redwood: "Redwood.png",
    Hazelnut: "Hazelnut.png"
};

// Constants
const BOARD_WIDTH_INCH = 5.5;
const GAP_INCH = 0.125;
const EFFECTIVE_FT = (BOARD_WIDTH_INCH + GAP_INCH) / 12;
const WASTE = 1.10;
const SCREWS_PER_BOX = 375;

// State
let lineItems = [];
let deletedItems = [];
let deckLengthFt = 0;
let deckWidthFt = 0;
let selectedColor1 = "Driftwood";
let selectedColor2 = "Khaki";

// DOM Elements
const tbody = document.querySelector("#line-items tbody");
const modal = document.getElementById("colorModal");
const reviewModal = document.getElementById("reviewModal");
const modalImg = document.getElementById("colorLarge");
const modalName = document.getElementById("colorName");
const closeBtn = document.getElementById("modal-close");
const reviewCloseBtn = document.getElementById("review-close");
const stickyPrice = document.getElementById("sticky-price");
const stickyTotal = document.getElementById("sticky-total");

// Initialize color grid
function initColorGrid() {
    const grid = document.getElementById("color-grid");
    grid.innerHTML = "";
    COLORS.forEach(color => {
        const card = document.createElement("div");
        card.className = "color-card";
        card.setAttribute("data-color", color);
        
        const img = document.createElement("img");
        img.src = `colors/${COLOR_IMAGES[color]}`;
        img.alt = color;
        img.onerror = () => { img.src = "https://via.placeholder.com/100x80?text=" + color; };
        
        const label = document.createElement("div");
        label.className = "color-card-label";
        label.textContent = color;
        
        card.appendChild(img);
        card.appendChild(label);
        
        card.addEventListener("click", () => {
            selectedColor1 = color;
            updateColorComparison();
            updateColorSelection();
        });
        
        grid.appendChild(card);
    });
}

function updateColorSelection() {
    document.querySelectorAll(".color-card").forEach(card => {
        if (card.getAttribute("data-color") === selectedColor1) {
            card.classList.add("selected");
        } else {
            card.classList.remove("selected");
        }
    });
}

function updateColorComparison() {
    document.getElementById("color1-preview").src = `colors/${COLOR_IMAGES[selectedColor1]}`;
    document.getElementById("color1-name").textContent = selectedColor1;
    
    const idx = COLORS.indexOf(selectedColor1);
    selectedColor2 = COLORS[(idx + 1) % COLORS.length];
    document.getElementById("color2-preview").src = `colors/${COLOR_IMAGES[selectedColor2]}`;
    document.getElementById("color2-name").textContent = selectedColor2;
}

// Customer info progress tracking
function updateCustomerProgress() {
    const name = document.getElementById("cust-name").value.trim() ? 1 : 0;
    const address = document.getElementById("cust-address").value.trim() ? 1 : 0;
    const phone = document.getElementById("cust-phone").value.trim() ? 1 : 0;
    const email = document.getElementById("cust-email").value.trim() ? 1 : 0;
    const completed = name + address + phone + email;
    const badge = document.getElementById("cust-badge");
    badge.textContent = `${completed}/4`;
    if (completed === 4) {
        badge.classList.remove("incomplete");
    } else {
        badge.classList.add("incomplete");
    }
}

["cust-name", "cust-address", "cust-phone", "cust-email"].forEach(id => {
    document.getElementById(id).addEventListener("input", updateCustomerProgress);
});

document.getElementById("add-row").onclick = () => {
    lineItems.push({
        type: "system",
        color: selectedColor1,
        length: 16,
        qty: 1,
        priceOverride: null,
        customDesc: "",
        customUnitPrice: 0
    });
    deletedItems = [];
    render();
    updateTotalAndFasteners();
};

document.getElementById("calc-btn").onclick = calculateAndSuggest;

closeBtn.onclick = () => modal.classList.remove("active");
reviewCloseBtn.onclick = () => reviewModal.classList.remove("active");

window.addEventListener("keydown", (e) => {
    if (e.key === "Escape") {
        if (modal.classList.contains("active")) modal.classList.remove("active");
        if (reviewModal.classList.contains("active")) reviewModal.classList.remove("active");
    }
});

window.addEventListener("click", (e) => {
    if (e.target === modal) modal.classList.remove("active");
    if (e.target === reviewModal) reviewModal.classList.remove("active");
});

document.getElementById("reset").onclick = () => {
    if (!confirm("Clear the entire form?")) return;
    lineItems = [];
    deletedItems = [];
    render();
    updateTotalAndFasteners();
    updateCustomerProgress();
    ["cust-name", "cust-company", "cust-address", "cust-phone", "cust-email", "ship-addr", "del-date", "special-instr", "internal-notes", "deck-len", "deck-wid"].forEach(id => {
        document.getElementById(id).value = "";
    });
    document.getElementById("pic-frame").checked = false;
    document.getElementById("stairs").checked = false;
    document.getElementById("pic-frame-note").style.display = "none";
    document.getElementById("stairs-note").style.display = "none";
    const hintEl = document.getElementById("fastener-hint");
    hintEl.style.display = "none";
    hintEl.innerHTML = "";
    document.getElementById("success-msg").style.display = "none";
};

document.getElementById("pdf").onclick = generatePDF;
document.getElementById("review-btn").onclick = showReview;
document.getElementById("review-submit").onclick = () => {
    reviewModal.classList.remove("active");
    submitOrder();
};
document.getElementById("review-back").onclick = () => {
    reviewModal.classList.remove("active");
};

["pic-frame", "stairs"].forEach(id => {
    document.getElementById(id).addEventListener("change", (e) => {
        document.getElementById(id + "-note").style.display = e.target.checked ? "block" : "none";
    });
});

function render() {
    renderDesktop();
    renderMobile();
}

function renderDesktop() {
    tbody.innerHTML = "";
    lineItems.forEach((item, i) => {
        const prod = PRODUCTS[item.type] || PRODUCTS.custom;
        const row = document.createElement("tr");

        let td = document.createElement("td");
        td.setAttribute("data-label", "Product");
        const sel = document.createElement("select");
        
        Object.entries(PRODUCT_CONFIG.categories).forEach(([catKey, category]) => {
            const optgroup = document.createElement("optgroup");
            optgroup.label = category.label;
            Object.entries(category.products).forEach(([prodKey, prodData]) => {
                const opt = document.createElement("option");
                opt.value = prodKey;
                opt.textContent = prodData.name;
                if (prodKey === item.type) opt.selected = true;
                optgroup.appendChild(opt);
            });
            sel.appendChild(optgroup);
        });

        sel.onchange = () => {
            item.type = sel.value;
            if (item.type !== "custom") {
                item.customDesc = "";
                item.customUnitPrice = 0;
            }
            if (!PRODUCTS[item.type].isFt) item.length = null;
            render();
            updateTotalAndFasteners();
        };
        td.appendChild(sel);
        
        const helpDiv = document.createElement("div");
        helpDiv.className = "help-text";
        helpDiv.textContent = prod.help || "";
        td.appendChild(helpDiv);
        
        row.appendChild(td);

        td = document.createElement("td");
        td.setAttribute("data-label", "Color");
        if (prod.hasColor) {
            const csel = document.createElement("select");
            COLORS.forEach(c => {
                const o = document.createElement("option");
                o.value = c;
                o.textContent = c;
                if (c === item.color) o.selected = true;
                csel.appendChild(o);
            });

            const prev = document.createElement("img");

            function applyImage() {
                const colorName = item.color || COLORS[0];
                const imgFile = COLOR_IMAGES[colorName] || COLOR_IMAGES.Driftwood;
                prev.src = "colors/" + imgFile;
            }

            csel.onchange = e => {
                item.color = e.target.value;
                applyImage();
                updateTotalAndFasteners();
            };

            td.appendChild(csel);
            item.color = item.color || COLORS[0];
            applyImage();

            prev.className = "preview-img";
            prev.alt = "preview";
            prev.title = "Click to enlarge";
            prev.onerror = () => { prev.src = "https://via.placeholder.com/34?text=?"; };
            prev.onclick = () => {
                modalImg.src = prev.src;
                modalName.textContent = item.color || COLORS[0];
                modal.classList.add("active");
            };

            td.appendChild(prev);
        }
        row.appendChild(td);

        td = document.createElement("td");
        td.setAttribute("data-label", "Length (ft)");
        if (prod.isFt) {
            if (["system", "grooved", "solid"].includes(item.type)) {
                const lsel = document.createElement("select");
                [12, 16, 20].forEach(l => {
                    const o = document.createElement("option");
                    o.value = l;
                    o.text = l + " ft";
                    if (l === item.length) o.selected = true;
                    lsel.appendChild(o);
                });
                const custOpt = document.createElement("option");
                custOpt.value = "custom";
                custOpt.text = "Custom";
                if (![12, 16, 20].includes(item.length)) custOpt.selected = true;
                lsel.appendChild(custOpt);

                lsel.onchange = e => {
                    if (e.target.value === "custom") {
                        const val = prompt("Custom length (ft):", item.length || "");
                        item.length = parseFloat(val) || 16;
                    } else {
                        item.length = parseFloat(e.target.value);
                    }
                    render();
                    updateTotalAndFasteners();
                };
                td.appendChild(lsel);
            } else if (item.type === "dexerdry") {
                const lengthSelect = document.createElement("select");
                const opts = [
                    { value: "240", label: "240 ft coil" },
                    { value: "50", label: "50 ft coil" },
                    { value: "custom", label: "Custom length" }
                ];
                opts.forEach(o => {
                    const opt = document.createElement("option");
                    opt.value = o.value;
                    opt.textContent = o.label;
                    if (!item.length && o.value === "240") opt.selected = true;
                    else if (item.length && String(item.length) === o.value) opt.selected = true;
                    lengthSelect.appendChild(opt);
                });

                const customInput = document.createElement("input");
                customInput.type = "number";
                customInput.step = "0.1";
                customInput.min = "0";
                customInput.placeholder = "Custom ft";
                customInput.className = "len-input";
                customInput.style.marginTop = "0.3rem";
                customInput.style.display = "none";

                function syncInputsFromItem() {
                    if (item.length === 240 || item.length === 50) {
                        lengthSelect.value = String(item.length);
                        customInput.style.display = "none";
                    } else if (item.length) {
                        lengthSelect.value = "custom";
                        customInput.style.display = "block";
                        customInput.value = item.length;
                    } else {
                        lengthSelect.value = "240";
                        customInput.style.display = "none";
                        item.length = 240;
                    }
                }

                lengthSelect.onchange = e => {
                    const val = e.target.value;
                    if (val === "240" || val === "50") {
                        item.length = parseFloat(val);
                        customInput.style.display = "none";
                        updateTotalAndFasteners();
                    } else {
                        customInput.style.display = "block";
                        customInput.focus();
                    }
                };

                customInput.oninput = e => {
                    item.length = parseFloat(e.target.value) || 0;
                    updateTotalAndFasteners();
                };

                syncInputsFromItem();
                td.appendChild(lengthSelect);
                td.appendChild(customInput);
            } else {
                const inp = document.createElement("input");
                inp.type = "number";
                inp.step = "0.1";
                inp.min = "0";
                inp.className = "len-input";
                inp.value = item.length || "";
                inp.oninput = e => { item.length = parseFloat(e.target.value) || 0; updateTotalAndFasteners(); };
                td.appendChild(inp);
            }
        }
        row.appendChild(td);

        td = document.createElement("td");
        td.className = "numeric";
        td.setAttribute("data-label", "Qty");
        const q = document.createElement("input");
        q.type = "number";
        q.min = "1";
        q.step = "1";
        q.className = "qty-input";
        q.value = item.qty;
        q.inputMode = "numeric";
        q.oninput = e => { item.qty = Math.max(1, parseInt(e.target.value) || 1); updateTotalAndFasteners(); };
        td.appendChild(q);

        if (item.type === "custom") {
            const d = document.createElement("input");
            d.type = "text";
            d.placeholder = "Description";
            d.style.marginTop = "0.3rem";
            d.value = item.customDesc || "";
            d.oninput = e => item.customDesc = e.target.value;
            td.appendChild(d);

            const up = document.createElement("input");
            up.type = "number";
            up.step = "0.01";
            up.placeholder = "Unit $";
            up.style.marginTop = "0.25rem";
            up.inputMode = "decimal";
            up.value = item.customUnitPrice || "";
            up.oninput = e => { item.customUnitPrice = parseFloat(e.target.value) || 0; updateTotalAndFasteners(); };
            td.appendChild(up);
        }
        row.appendChild(td);

        td = document.createElement("td");
        td.className = "numeric";
        td.setAttribute("data-label", "Unit Price");
        if ((prod.isFt && item.type !== "dexerdry") || item.type === "custom") {
            const p = document.createElement("input");
            p.type = "number";
            p.step = "0.01";
            p.min = "0";
            p.className = "price-input";
            p.inputMode = "decimal";
            const defPrice = item.type === "custom" ? item.customUnitPrice : prod.price;
            p.placeholder = "default $" + defPrice.toFixed(2);
            p.value = item.priceOverride ?? "";
            p.oninput = e => { item.priceOverride = parseFloat(e.target.value); updateTotalAndFasteners(); };
            td.appendChild(p);
        } else {
            td.textContent = "$" + prod.price.toFixed(2);
        }
        row.appendChild(td);

        td = document.createElement("td");
        td.className = "numeric";
        td.id = "sub-" + i;
        td.setAttribute("data-label", "Subtotal");
        row.appendChild(td);

        td = document.createElement("td");
        td.className = "table-actions-cell";
        td.setAttribute("data-label", "Actions");
        const rm = document.createElement("button");
        rm.type = "button";
        rm.textContent = "Ã—";
        rm.className = "btn-remove-row";
        rm.title = "Delete this line item";
        rm.onclick = () => {
            deletedItems.push(JSON.parse(JSON.stringify(item)));
            lineItems.splice(i, 1);
            render();
            updateTotalAndFasteners();
            updateUndoButton();
        };
        td.appendChild(rm);
        row.appendChild(td);

        tbody.appendChild(row);
    });
}

function renderMobile() {
    const container = document.getElementById("mobile-items-container");
    container.innerHTML = "";
    lineItems.forEach((item, i) => {
        const prod = PRODUCTS[item.type] || PRODUCTS.custom;
        const card = document.createElement("div");
        card.className = "line-item-card mobile-visible";

        const title = document.createElement("h4");
        title.textContent = `Item ${i + 1}`;
        card.appendChild(title);

        const productRow = document.createElement("div");
        productRow.className = "line-item-row full";
        const prodLabel = document.createElement("label");
        prodLabel.textContent = "Product";
        const prodSel = document.createElement("select");
        
        Object.entries(PRODUCT_CONFIG.categories).forEach(([catKey, category]) => {
            const optgroup = document.createElement("optgroup");
            optgroup.label = category.label;
            Object.entries(category.products).forEach(([prodKey, prodData]) => {
                const opt = document.createElement("option");
                opt.value = prodKey;
                opt.textContent = prodData.name;
                if (prodKey === item.type) opt.selected = true;
                optgroup.appendChild(opt);
            });
            prodSel.appendChild(optgroup);
        });

        prodSel.onchange = () => {
            item.type = prodSel.value;
            if (item.type !== "custom") {
                item.customDesc = "";
                item.customUnitPrice = 0;
            }
            if (!PRODUCTS[item.type].isFt) item.length = null;
            render();
            updateTotalAndFasteners();
        };
        
        productRow.appendChild(prodLabel);
        productRow.appendChild(prodSel);
        card.appendChild(productRow);

        if (prod.hasColor) {
            const colorRow = document.createElement("div");
            colorRow.className = "line-item-row full";
            const colorLabel = document.createElement("label");
            colorLabel.textContent = "Color";
            const colorSel = document.createElement("select");
            COLORS.forEach(c => {
                const o = document.createElement("option");
                o.value = c;
                o.textContent = c;
                if (c === item.color) o.selected = true;
                colorSel.appendChild(o);
            });
            colorSel.onchange = e => {
                item.color = e.target.value;
                updateTotalAndFasteners();
            };
            colorRow.appendChild(colorLabel);
            colorRow.appendChild(colorSel);
            card.appendChild(colorRow);
        }

        const lengthQtyRow = document.createElement("div");
        lengthQtyRow.className = "line-item-row";

        if (prod.isFt) {
            const lengthDiv = document.createElement("div");
            const lengthLabel = document.createElement("label");
            lengthLabel.textContent = "Length (ft)";
            const lengthInput = document.createElement("input");
            lengthInput.type = "number";
            lengthInput.value = item.length || "";
            lengthInput.step = "0.1";
            lengthInput.min = "0";
            lengthInput.inputMode = "decimal";
            lengthInput.oninput = e => { item.length = parseFloat(e.target.value) || 0; updateTotalAndFasteners(); };
            lengthDiv.appendChild(lengthLabel);
            lengthDiv.appendChild(lengthInput);
            lengthQtyRow.appendChild(lengthDiv);
        }

        const qtyDiv = document.createElement("div");
        const qtyLabel = document.createElement("label");
        qtyLabel.textContent = "Quantity";
        const qtyInput = document.createElement("input");
        qtyInput.type = "number";
        qtyInput.value = item.qty;
        qtyInput.min = "1";
        qtyInput.step = "1";
        qtyInput.inputMode = "numeric";
        qtyInput.oninput = e => { item.qty = Math.max(1, parseInt(e.target.value) || 1); updateTotalAndFasteners(); };
        qtyDiv.appendChild(qtyLabel);
        qtyDiv.appendChild(qtyInput);
        lengthQtyRow.appendChild(qtyDiv);

        card.appendChild(lengthQtyRow);

        const subRow = document.createElement("div");
        subRow.className = "line-item-subtotal";
        subRow.id = "mobile-sub-" + i;
        card.appendChild(subRow);

        const actionsDiv = document.createElement("div");
        actionsDiv.className = "line-item-card-actions";
        const rmBtn = document.createElement("button");
        rmBtn.type = "button";
        rmBtn.textContent = "Delete Item";
        rmBtn.className = "btn btn-ghost btn-sm";
        rmBtn.onclick = () => {
            deletedItems.push(JSON.parse(JSON.stringify(item)));
            lineItems.splice(i, 1);
            render();
            updateTotalAndFasteners();
            updateUndoButton();
        };
        actionsDiv.appendChild(rmBtn);
        card.appendChild(actionsDiv);

        container.appendChild(card);
    });
}

function updateUndoButton() {
    const btn = document.getElementById("undo-btn");
    if (deletedItems.length > 0) {
        btn.style.display = "block";
        btn.onclick = () => {
            const item = deletedItems.pop();
            lineItems.push(item);
            render();
            updateTotalAndFasteners();
            updateUndoButton();
        };
    } else {
        btn.style.display = "none";
    }
}

function getItemPrice(item) {
    const prod = PRODUCTS[item.type] || PRODUCTS.custom;
    if (item.priceOverride != null && !Number.isNaN(item.priceOverride) && item.type !== "dexerdry") {
        return item.priceOverride;
    }
    if (item.type === "custom") return item.customUnitPrice || 0;
    return prod.price;
}

function getItemSubtotal(item) {
    const prod = PRODUCTS[item.type] || PRODUCTS.custom;
    const price = getItemPrice(item);
    if (prod.isFt || (item.type === "custom" && item.length)) {
        return item.qty * (item.length || 0) * price;
    }
    return item.qty * price;
}

function updateTotalAndFasteners() {
    let total = 0;
    let totalGroovedBoards = 0;
    let hasSystem = false;
    let hasStandaloneDex = false;

    lineItems.forEach((item, i) => {
        const sub = getItemSubtotal(item);
        total += sub;
        const subCell = document.getElementById("sub-" + i);
        if (subCell) subCell.textContent = "$" + sub.toFixed(2);

        const mobileSubCell = document.getElementById("mobile-sub-" + i);
        if (mobileSubCell) mobileSubCell.textContent = "Subtotal: $" + sub.toFixed(2);

        if (["system", "grooved"].includes(item.type)) {
            totalGroovedBoards += item.qty;
        }
        if (item.type === "system") hasSystem = true;
        if (item.type === "dexerdry") hasStandaloneDex = true;
    });

    document.getElementById("grand-total").textContent = "$" + total.toFixed(2);
    stickyTotal.textContent = "$" + total.toFixed(2);

    const hintEl = document.getElementById("fastener-hint");
    let hintHtml = "";

    if (totalGroovedBoards > 0 && deckLengthFt > 0) {
        const joistCount = Math.floor(deckLengthFt * 12 / 16) + 1;
        const intersections = totalGroovedBoards * joistCount;
        const screwsNeeded = intersections * 2;
        const boxesScrews = Math.ceil(screwsNeeded / SCREWS_PER_BOX);

        hintHtml += "<strong>Fastener suggestion (reference only):</strong><br>" +
            "â‰ˆ " + boxesScrews + " boxes of screws<br>" +
            "â‰ˆ " + boxesScrews + " boxes of plugs";
    }

    if (hasSystem && hasStandaloneDex) {
        hintHtml += '<div class="fastener-warning">AmeriDex System Boards already include Dexerdry in the price. Standalone Dexerdry is typically only needed for non-system decks.</div>';
    }

    if (hintHtml) {
        hintEl.style.display = "block";
        hintEl.innerHTML = hintHtml;
    } else {
        hintEl.style.display = "none";
        hintEl.innerHTML = "";
    }
}

function calculateAndSuggest() {
    deckLengthFt = parseFloat(document.getElementById("deck-len").value) || 0;
    deckWidthFt = parseFloat(document.getElementById("deck-wid").value) || 0;

    if (deckLengthFt <= 0 || deckWidthFt <= 0) {
        alert("Please enter both deck length and width greater than 0.");
        return;
    }

    const perp = document.getElementById("orientation").value === "perpendicular";
    const span = perp ? deckLengthFt : deckWidthFt;
    const run = perp ? deckWidthFt : deckLengthFt;

    const boardsNeeded = Math.ceil((span / EFFECTIVE_FT) * WASTE);
    const dexerdryFt = (boardsNeeded - 1) * run * WASTE;

    const msg =
        "<strong>Suggested AmeriDex System Boards (Dexerdry included in price)</strong><br>" +
        "â‰ˆ " + boardsNeeded + " boards @ " + run.toFixed(1) + " ft each<br>" +
        "Total board ft: " + (boardsNeeded * run).toFixed(1) + "<br>" +
        "Integrated Dexerdry: " + dexerdryFt.toFixed(1) + " ft<br><br>" +
        "(10% waste included)";
    document.getElementById("calc-result").innerHTML = msg;

    if (confirm("Add suggested AmeriDex System Boards to the order?")) {
        lineItems.push({
            type: "system",
            color: selectedColor1,
            length: Math.min(20, Math.max(12, Math.round(run))),
            qty: boardsNeeded,
            priceOverride: null,
            customDesc: "",
            customUnitPrice: 0
        });
        deletedItems = [];
        render();
        updateTotalAndFasteners();
        updateUndoButton();
    }
}

function validateRequired() {
    const form = document.getElementById("order-form");
    if (form && !form.reportValidity()) {
        return false;
    }

    for (let item of lineItems) {
        if (item.qty < 1) {
            alert("All quantities must be at least 1.");
            return false;
        }
    }

    return true;
}

function generateOrderText() {
    let txt = "AmeriDex Order\n\nCUSTOMER:\n";
    txt += "Name: " + document.getElementById("cust-name").value + "\n";
    txt += "Company: " + (document.getElementById("cust-company").value || "") + "\n";
    txt += "Address: " + document.getElementById("cust-address").value.replace(/\n/g, " | ") + "\n";
    txt += "Phone: " + document.getElementById("cust-phone").value + "\n";
    txt += "Email: " + document.getElementById("cust-email").value + "\n\n";

    txt += "PRODUCTS:\n";
    lineItems.forEach((item, i) => {
        const prod = PRODUCTS[item.type] || PRODUCTS.custom;
        const price = getItemPrice(item);
        const sub = getItemSubtotal(item);
        let desc = prod.name;
        if (item.type === "custom") desc = item.customDesc || desc;
        if (prod.hasColor && item.color) desc += " (" + item.color + ")";
        txt += (i + 1) + ". " + desc + "\n";
        txt += "   Length: " + (item.length || "N/A") + " ft, Qty: " + item.qty + ", Price: $" + price.toFixed(2) + ", Subtotal: $" + sub.toFixed(2) + "\n";
    });

    txt += "\nTOTAL: $" + document.getElementById("grand-total").textContent + "\n";

    if (document.getElementById("special-instr").value) {
        txt += "\nSPECIAL INSTRUCTIONS:\n" + document.getElementById("special-instr").value + "\n";
    }

    if (document.getElementById("del-date").value) {
        txt += "\nPREFERRED DELIVERY DATE: " + document.getElementById("del-date").value + "\n";
    }

    return txt;
}

function generatePDF() {
    if (!validateRequired()) return;

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const pageWidth = doc.internal.pageSize.getWidth();
    const pageHeight = doc.internal.pageSize.getHeight();
    let yPosition = 10;

    doc.setFontSize(18);
    doc.text("AmeriDex Order Form", pageWidth / 2, yPosition, { align: "center" });
    yPosition += 10;

    doc.setFontSize(12);
    doc.text("Customer Information", 10, yPosition);
    yPosition += 8;

    doc.setFontSize(10);
    const name = document.getElementById("cust-name").value;
    const company = document.getElementById("cust-company").value || "N/A";
    const address = document.getElementById("cust-address").value.replace(/\n/g, ", ");
    const phone = document.getElementById("cust-phone").value;
    const email = document.getElementById("cust-email").value;

    doc.text(`Name: ${name}`, 10, yPosition);
    yPosition += 6;
    doc.text(`Company: ${company}`, 10, yPosition);
    yPosition += 6;
    doc.text(`Address: ${address}`, 10, yPosition);
    yPosition += 6;
    doc.text(`Phone: ${phone}`, 10, yPosition);
    yPosition += 6;
    doc.text(`Email: ${email}`, 10, yPosition);
    yPosition += 12;

    doc.setFontSize(12);
    doc.text("Line Items", 10, yPosition);
    yPosition += 8;

    doc.setFontSize(9);
    const headers = ["Product", "Color", "Length", "Qty", "Price", "Subtotal"];
    const widths = [50, 25, 20, 15, 25, 30];
    let xPos = 10;

    headers.forEach((h, i) => {
        doc.text(h, xPos, yPosition);
        xPos += widths[i];
    });
    yPosition += 7;

    doc.setFontSize(8);
    lineItems.forEach(item => {
        const prod = PRODUCTS[item.type] || PRODUCTS.custom;
        const price = getItemPrice(item);
        const sub = getItemSubtotal(item);

        let desc = prod.name.substring(0, 25);
        let color = item.color || "";
        let length = item.length ? item.length.toString() : "N/A";
        let qty = item.qty.toString();
        let priceStr = "$" + price.toFixed(2);
        let subStr = "$" + sub.toFixed(2);

        xPos = 10;
        doc.text(desc, xPos, yPosition);
        xPos += widths[0];
        doc.text(color, xPos, yPosition);
        xPos += widths[1];
        doc.text(length, xPos, yPosition);
        xPos += widths[2];
        doc.text(qty, xPos, yPosition);
        xPos += widths[3];
        doc.text(priceStr, xPos, yPosition);
        xPos += widths[4];
        doc.text(subStr, xPos, yPosition);

        yPosition += 6;

        if (yPosition > pageHeight - 20) {
            doc.addPage();
            yPosition = 10;
        }
    });

    yPosition += 6;
    doc.setFontSize(11);
    doc.text(`Total: ${document.getElementById("grand-total").textContent}`, 10, yPosition, { style: "bold" });

    doc.save("AmeriDex-Order.pdf");
}

function showReview() {
    if (!validateRequired()) return;

    document.getElementById("review-name").textContent = document.getElementById("cust-name").value;
    document.getElementById("review-email").textContent = document.getElementById("cust-email").value;
    document.getElementById("review-phone").textContent = document.getElementById("cust-phone").value;

    const reviewItems = document.getElementById("review-items");
    reviewItems.innerHTML = "";
    lineItems.forEach((item, i) => {
        const prod = PRODUCTS[item.type] || PRODUCTS.custom;
        const price = getItemPrice(item);
        const sub = getItemSubtotal(item);

        const itemDiv = document.createElement("div");
        itemDiv.style.marginBottom = "0.75rem";
        itemDiv.innerHTML = `
            <strong>${prod.name}</strong><br>
            ${item.color ? 'Color: ' + item.color + '<br>' : ''}
            ${item.length ? 'Length: ' + item.length + ' ft | ' : ''}
            Qty: ${item.qty} @ $${price.toFixed(2)} = <strong>$${sub.toFixed(2)}</strong>
        `;
        reviewItems.appendChild(itemDiv);
    });

    document.getElementById("review-total").textContent = document.getElementById("grand-total").textContent;
    reviewModal.classList.add("active");
}

function submitOrder() {
    const orderText = generateOrderText();
    const mailto = `mailto:${document.getElementById("cust-email").value}?subject=AmeriDex Order Confirmation&body=${encodeURIComponent(orderText)}`;
    window.location.href = mailto;
    document.getElementById("success-msg").style.display = "block";
}

// Initialize on load
initColorGrid();
updateColorSelection();
updateColorComparison();
updateCustomerProgress();
</script>

</body>
</html>
